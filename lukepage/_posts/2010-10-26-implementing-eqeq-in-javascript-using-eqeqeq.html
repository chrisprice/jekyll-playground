---
author: Luke Page
tags: 
permalink: /2010/10/implementing-eqeq-in-javascript-using-eqeqeq/index.html
layout: blog
---
<div class="entry"><h3>Introduction</h3><p>So, in a previous post I pointed out some == coercing that was far from obvious. But despite gradually picking up edge cases, I’ve never had a true understanding of the various cases where x == y. So, prompted by Jonathan’s link to <a href="http://www.mozilla.org/js/language/E262-3.pdf">the specification</a> explanation and figuring that code is going to be easier to understand than a series of steps.</p><h3>Delving Into the Spec</h3><p>So first off, here is how the specification says to do a == comparison.</p><pre>
1. If Type(x) is different from Type(y), go to step 14.
2. If Type(x) is Undefined, return true.
3. If Type(x) is Null, return true.
4. If Type(x) is not Number, go to step 11.
5. If x is NaN, return false.
6. If y is NaN, return false.
7. If x is the same number value as y, return true.
8. If x is +0 and y is -0, return true.
9. If x is -0 and y is +0, return true.
10. Return false.
11. If Type(x) is String, then return true if x and y are exactly the same sequence of characters (same length and
same characters in corresponding positions). Otherwise, return false.
12. If Type(x) is Boolean, return true if x and y are both true or both false. Otherwise, return false.
13. Return true if x and y refer to the same object or if they refer to objects joined to each other (section 13.1.2).
Otherwise, return false.
14. If x is null and y is undefined, return true.
15. If x is undefined and y is null, return true.
16. If Type(x) is Number and Type(y) is String,
return the result of the comparison x == ToNumber(y).
17. If Type(x) is String and Type(y) is Number,
return the result of the comparison ToNumber(x) == y.
18. If Type(x) is Boolean, return the result of the comparison ToNumber(x) == y.
19. If Type(y) is Boolean, return the result of the comparison x == ToNumber(y).
20. If Type(x) is either String or Number and Type(y) is Object,
return the result of the comparison x == ToPrimitive(y).
21. If Type(x) is Object and Type(y) is either String or Number,
return the result of the comparison ToPrimitive(x) == y.
22. Return false.
</pre><p>First – The second part of step 13 talks of detecting joined up of functions. However it is just an implementation detail that can even be used or unused. It isn’t necessary to implement detection because === also finds two joined functions to be equivalent. </p><p>Second, looking at the implementation of === we can also determine that steps 2 to 13 are already implemeted, so we don’t have to detect +0 and -0 or make NaN !== NaN.</p><p>Third I’m going to assume that ToNumber is equivalent to doing using Number(x).</p><p>Next we’ll deal with primitive values of objects. The text relating to this is below.</p><pre>
Return a default value for the Object. The default value of an object is
retrieved by calling the internal [[DefaultValue]] method of the object,
passing the optional hint PreferredType. The behaviour of the
[[DefaultValue]] method is defined by this specification for all native
ECMAScript objects (section 8.6.2.6).
</pre><p>For everything apart from Object we return the value, then for objects we retrieve the DefaultValue. This text relating to this is below.</p><pre>
8.6.2.6 [[DefaultValue]] (hint)

When the [[DefaultValue]] method of O is called with hint String, the following steps are taken:
1. Call the [[Get]] method of object O with argument "toString".
2. If Result(1) is not an object, go to step 5.
3. Call the [[Call]] method of Result(1), with O as the this value and an empty argument list.
4. If Result(3) is a primitive value, return Result(3).
5. Call the [[Get]] method of object O with argument "valueOf".
6. If Result(5) is not an object, go to step 9.
7. Call the [[Call]] method of Result(5), with O as the this value and an empty argument list.
8. If Result(7) is a primitive value, return Result(7).
9. Throw a TypeError exception.

When the [[DefaultValue]] method of O is called with hint Number, the following steps are taken:
1. Call the [[Get]] method of object O with argument "valueOf".
2. If Result(1) is not an object, go to step 5.
3. Call the [[Call]] method of Result(1), with O as the this value and an empty argument list.
4. If Result(3) is a primitive value, return Result(3).
5. Call the [[Get]] method of object O with argument "toString".
6. If Result(5) is not an object, go to step 9.
7. Call the [[Call]] method of Result(5), with O as the this value and an empty argument list.
8. If Result(7) is a primitive value, return Result(7).
9. Throw a TypeError exception.

When the [[DefaultValue]] method of O is called with no hint, then it behaves as if the hint were Number, unless O is
a Date object (section 15.9), in which case it behaves as if the hint were String.

The above specification of [[DefaultValue]] for native objects can return only primitive values. If a host object
implements its own [[DefaultValue]] method, it must ensure that its [[DefaultValue]] method can return only primitive
values.
</pre><h3>Implementing the JavaScript</h3><p>So lets implement our own ToPrimitive() (which is mostly an implementation of DefaultValue).</p><div class="wp_syntax"><div class="code"><pre class="javascript" style="font-family: monospace;"><span style="color: #003366; font-weight: bold;">var</span> ToPrimitive <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">(</span>o<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
    <span style="color: #003366; font-weight: bold;">var</span> primitive<span style="color: #339933;">,</span>
        funcCalls<span style="color: #339933;">,</span>
        funcName<span style="color: #339933;">,</span>
        i<span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #000066; font-weight: bold;">if</span>  <span style="color: #009900;">(</span><span style="color: #000066; font-weight: bold;">typeof</span><span style="color: #009900;">(</span>o<span style="color: #009900;">)</span> <span style="color: #339933;">===</span> <span style="color: #3366CC;">"object"</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
        <span style="color: #000066; font-weight: bold;">if</span>  <span style="color: #009900;">(</span>o <span style="color: #000066; font-weight: bold;">instanceof</span> Date<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
            funcCalls <span style="color: #339933;">=</span> <span style="color: #009900;">[</span><span style="color: #3366CC;">"toString"</span><span style="color: #339933;">,</span> <span style="color: #3366CC;">"toValue"</span><span style="color: #009900;">]</span><span style="color: #339933;">;</span>
        <span style="color: #009900;">}</span> <span style="color: #000066; font-weight: bold;">else</span> <span style="color: #009900;">{</span>
            funcCalls <span style="color: #339933;">=</span> <span style="color: #009900;">[</span><span style="color: #3366CC;">"toValue"</span><span style="color: #339933;">,</span> <span style="color: #3366CC;">"toString"</span><span style="color: #009900;">]</span><span style="color: #339933;">;</span>
        <span style="color: #009900;">}</span>
&nbsp;
        <span style="color: #000066; font-weight: bold;">for</span><span style="color: #009900;">(</span>i <span style="color: #339933;">=</span> <span style="color: #CC0000;">0</span><span style="color: #339933;">;</span> i <span style="color: #339933;">&lt;</span> funcCalls.<span style="color: #660066;">length</span><span style="color: #339933;">;</span> i<span style="color: #339933;">++</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
            funcName <span style="color: #339933;">=</span> funcCalls<span style="color: #009900;">[</span>i<span style="color: #009900;">]</span><span style="color: #339933;">;</span>
            <span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">(</span><span style="color: #000066; font-weight: bold;">typeof</span><span style="color: #009900;">(</span>o<span style="color: #009900;">[</span>funcName<span style="color: #009900;">]</span><span style="color: #009900;">)</span> <span style="color: #339933;">===</span> <span style="color: #3366CC;">"function"</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
                primitive <span style="color: #339933;">=</span> o<span style="color: #009900;">[</span>funcName<span style="color: #009900;">]</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
                <span style="color: #000066; font-weight: bold;">if</span>  <span style="color: #009900;">(</span><span style="color: #000066; font-weight: bold;">typeof</span><span style="color: #009900;">(</span>primitive<span style="color: #009900;">)</span> <span style="color: #339933;">===</span> <span style="color: #3366CC;">"string"</span> <span style="color: #339933;">||</span>
                     <span style="color: #000066; font-weight: bold;">typeof</span><span style="color: #009900;">(</span>primitive<span style="color: #009900;">)</span> <span style="color: #339933;">===</span> <span style="color: #3366CC;">"number"</span> <span style="color: #339933;">||</span>
                     <span style="color: #000066; font-weight: bold;">typeof</span><span style="color: #009900;">(</span>primitive<span style="color: #009900;">)</span> <span style="color: #339933;">===</span> <span style="color: #3366CC;">"boolean"</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
                    <span style="color: #000066; font-weight: bold;">return</span> primitive<span style="color: #339933;">;</span>
                <span style="color: #009900;">}</span>
            <span style="color: #009900;">}</span> 
        <span style="color: #009900;">}</span>
        <span style="color: #000066; font-weight: bold;">throw</span> <span style="color: #003366; font-weight: bold;">new</span> Error<span style="color: #009900;">(</span><span style="color: #3366CC;">"Cannot retrieve DefaultValue of Object"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">}</span>
    <span style="color: #000066; font-weight: bold;">return</span> o<span style="color: #339933;">;</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></div></div><p>Next the specification says “If Type(x) is Null” – when typeof(null) returns “object”. It also refers to objects in a way that includes functions, when typeof(function) is “function”. So I’ve created a sanitised TypeOf()…</p><div class="wp_syntax"><div class="code"><pre class="javascript" style="font-family: monospace;"><span style="color: #003366; font-weight: bold;">var</span> <span style="color: #000066; font-weight: bold;">TypeOf</span> <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">function</span> <span style="color: #009900;">(</span>o<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
    <span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">(</span>o <span style="color: #339933;">===</span> <span style="color: #003366; font-weight: bold;">null</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
        <span style="color: #000066; font-weight: bold;">return</span> <span style="color: #3366CC;">"null"</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">}</span>
    <span style="color: #000066; font-weight: bold;">if</span>  <span style="color: #009900;">(</span><span style="color: #000066; font-weight: bold;">typeof</span><span style="color: #009900;">(</span>o<span style="color: #009900;">)</span> <span style="color: #339933;">===</span> <span style="color: #3366CC;">"function"</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
        <span style="color: #000066; font-weight: bold;">return</span> <span style="color: #3366CC;">"object"</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">}</span>
    <span style="color: #000066; font-weight: bold;">return</span> <span style="color: #000066; font-weight: bold;">typeof</span><span style="color: #009900;">(</span>o<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></div></div><p>And now, our Equals function.</p><div class="wp_syntax"><div class="code"><pre class="javascript" style="font-family: monospace;"><span style="color: #003366; font-weight: bold;">var</span> Equals <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">function</span><span style="color: #009900;">(</span>x<span style="color: #339933;">,</span> y<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
    <span style="color: #003366; font-weight: bold;">var</span> typeX <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">TypeOf</span><span style="color: #009900;">(</span>x<span style="color: #009900;">)</span><span style="color: #339933;">,</span>
        typeY <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">TypeOf</span><span style="color: #009900;">(</span>y<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #000066; font-weight: bold;">if</span>  <span style="color: #009900;">(</span>typeX <span style="color: #339933;">===</span> typeY<span style="color: #009900;">)</span> <span style="color: #009900;">{</span> <span style="color: #006600; font-style: italic;">// Step 1</span>
&nbsp;
        <span style="color: #006600; font-style: italic;">// Steps 2-&gt;13 now covered by === since null is of type "null"</span>
        <span style="color: #000066; font-weight: bold;">return</span> x <span style="color: #339933;">===</span> y<span style="color: #339933;">;</span> <span style="color: #006600; font-style: italic;">// Step 13:</span>
    <span style="color: #009900;">}</span>
&nbsp;
    <span style="color: #006600; font-style: italic;">//Step 14, 15</span>
    <span style="color: #000066; font-weight: bold;">if</span>  <span style="color: #009900;">(</span><span style="color: #009900;">(</span>x <span style="color: #339933;">===</span> <span style="color: #003366; font-weight: bold;">null</span> <span style="color: #339933;">||</span> y <span style="color: #339933;">===</span> <span style="color: #003366; font-weight: bold;">null</span><span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> 
         <span style="color: #009900;">(</span>x <span style="color: #339933;">===</span> undefined <span style="color: #339933;">||</span> y <span style="color: #339933;">===</span> undefined<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
        <span style="color: #000066; font-weight: bold;">return</span> <span style="color: #003366; font-weight: bold;">true</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">}</span>
    <span style="color: #006600; font-style: italic;">//Step 16</span>
    <span style="color: #000066; font-weight: bold;">if</span>  <span style="color: #009900;">(</span>typeX <span style="color: #339933;">===</span> <span style="color: #3366CC;">"number"</span> <span style="color: #339933;">&amp;&amp;</span> typeY <span style="color: #339933;">===</span> <span style="color: #3366CC;">"string"</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
        <span style="color: #000066; font-weight: bold;">return</span> Equals<span style="color: #009900;">(</span>x<span style="color: #339933;">,</span> Number<span style="color: #009900;">(</span>y<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">}</span>
    <span style="color: #006600; font-style: italic;">// Step 17</span>
    <span style="color: #000066; font-weight: bold;">if</span>  <span style="color: #009900;">(</span>typeX <span style="color: #339933;">===</span> <span style="color: #3366CC;">"string"</span> <span style="color: #339933;">&amp;&amp;</span> typeY <span style="color: #339933;">===</span> <span style="color: #3366CC;">"number"</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
        <span style="color: #000066; font-weight: bold;">return</span> Equals<span style="color: #009900;">(</span>Number<span style="color: #009900;">(</span>x<span style="color: #009900;">)</span><span style="color: #339933;">,</span> y<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">}</span>
    <span style="color: #006600; font-style: italic;">//Step 18</span>
    <span style="color: #000066; font-weight: bold;">if</span>  <span style="color: #009900;">(</span>typeX <span style="color: #339933;">===</span> <span style="color: #3366CC;">"boolean"</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
        <span style="color: #000066; font-weight: bold;">return</span> Equals<span style="color: #009900;">(</span>Number<span style="color: #009900;">(</span>x<span style="color: #009900;">)</span><span style="color: #339933;">,</span> y<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">}</span>
    <span style="color: #006600; font-style: italic;">//Step 19</span>
    <span style="color: #000066; font-weight: bold;">if</span>  <span style="color: #009900;">(</span>typeY <span style="color: #339933;">===</span> <span style="color: #3366CC;">"boolean"</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
        <span style="color: #000066; font-weight: bold;">return</span> Equals<span style="color: #009900;">(</span>x<span style="color: #339933;">,</span> Number<span style="color: #009900;">(</span>y<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">}</span>
    <span style="color: #006600; font-style: italic;">//Step 20</span>
    <span style="color: #000066; font-weight: bold;">if</span>  <span style="color: #009900;">(</span><span style="color: #009900;">(</span>typeX <span style="color: #339933;">===</span> <span style="color: #3366CC;">"string"</span> <span style="color: #339933;">||</span> typeX <span style="color: #339933;">===</span> <span style="color: #3366CC;">"number"</span><span style="color: #009900;">)</span> <span style="color: #339933;">&amp;&amp;</span> typeY <span style="color: #339933;">===</span> <span style="color: #3366CC;">"object"</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
        <span style="color: #000066; font-weight: bold;">return</span> Equals<span style="color: #009900;">(</span>x<span style="color: #339933;">,</span> ToPrimitive<span style="color: #009900;">(</span>y<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">}</span>
    <span style="color: #006600; font-style: italic;">//Step 21</span>
    <span style="color: #000066; font-weight: bold;">if</span>  <span style="color: #009900;">(</span>typeX <span style="color: #339933;">===</span> <span style="color: #3366CC;">"object"</span> <span style="color: #339933;">&amp;&amp;</span> <span style="color: #009900;">(</span>typeY <span style="color: #339933;">===</span> <span style="color: #3366CC;">"string"</span> <span style="color: #339933;">||</span> typeY <span style="color: #339933;">===</span> <span style="color: #3366CC;">"number"</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
        <span style="color: #000066; font-weight: bold;">return</span> Equals<span style="color: #009900;">(</span>ToPrimitive<span style="color: #009900;">(</span>x<span style="color: #009900;">)</span><span style="color: #339933;">,</span> y<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">}</span>
    <span style="color: #006600; font-style: italic;">//Step 22.. Not convinced this will ever happen</span>
    <span style="color: #000066; font-weight: bold;">return</span> <span style="color: #003366; font-weight: bold;">false</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></div></div><h3>Unit Tests</h3><p>And finally, rather than put more guess what's == paragraphs, I present some unit tests...</p><style type="text/css">
table#ForUnitTests tr:nth-child(odd) td {
 background-color: #FAFAFF;
}
table#ForUnitTests tr {
border-top: 1px black solid;
}
table#ForUnitTests {
border: 1px black solid;
margin-top: 10px;
}
table#ForUnitTests TH {
padding: 2px;
}
</style><input type="button" value="Run Unit Tests" onclick="return runUnitTests();" /><table id="ForUnitTests">
<thead>
<th>Test</th>
<th>==</th>
<th>Equals</th>
</thead>
<tbody>
</tbody>
</table><p></p></div>