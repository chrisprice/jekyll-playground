---
author: Nicholas Wolverson
tags: 
permalink: /2011/10/plotting-user-functions-with-visiblox/index.html
layout: blog
---
<div class="entry"><p><a href="{{ site.url }}/2011/06/mathematical-style-plots-retemplating-visiblox-charts/">Some time ago</a> I wrote about plotting mathematical functions with Visiblox Charts, and Jesse <a href="http://www.visiblox.com/blog/2011/06/plotting-mathematical-functions-on-visiblox">responded</a> by showing how to wrap a function in a data series to feed into a chart. I’m going to show how to take this idea a bit further, generating additional data on interaction, and allowing the user to specify a function to chart.</p><p><span id="more-130838"></span></p><p>One limitation of the approach Jesse outlined is that the function range (and to a lesser extent its step) are explicitly specified. You can see that if you pan the chart, as this predefined limit is reached we go into uncharted territory (if you’ll pardon the pun). What we’d really like to do is view any part of the function output – without generating more function outputs than required. There are two ways that spring to mind: firstly, bind the chart range to the function data range (which requires either making the data series a dependency object, or setting up the binding in reverse/via an intermediary); and secondly, via some magic which I will show below! My goal is to have a dataseries which will wrap a function (<code>double - double</code> for now) and chart the visible portion as appropriate, requiring no setup other than dropping it into the chart.</p><h4>Basic Function Data Series</h4><p>Let’s start with a basic implementation of a DataSeries wrapping a function. I’ve simplified Jesse’s version, but this is the same basic approach (also omitting niceties like argument validation).</p><div class="wp_syntax"><div class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">class</span> FunctionDataSeries <span style="color: #008000;">:</span> IDataSeries
<span style="color: #008000;">{</span>
    <span style="color: #0600FF; font-weight: bold;">private</span> Func<span style="color: #008000;">&lt;</span><span style="color: #6666cc; font-weight: bold;">double</span>, <span style="color: #6666cc; font-weight: bold;">double</span><span style="color: #008000;">&gt;</span> _function<span style="color: #008000;">;</span>
    <span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">double</span> _min, _max<span style="color: #008000;">;</span>
&nbsp;
    <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">string</span> Title <span style="color: #008000;">{</span> get<span style="color: #008000;">;</span> set<span style="color: #008000;">;</span> <span style="color: #008000;">}</span>
&nbsp;
    <span style="color: #0600FF; font-weight: bold;">public</span> FunctionDataSeries<span style="color: #008000;">(</span>Func<span style="color: #008000;">&lt;</span><span style="color: #6666cc; font-weight: bold;">double</span>, <span style="color: #6666cc; font-weight: bold;">double</span><span style="color: #008000;">&gt;</span> function, <span style="color: #6666cc; font-weight: bold;">double</span> min, <span style="color: #6666cc; font-weight: bold;">double</span> max<span style="color: #008000;">)</span>
    <span style="color: #008000;">{</span>
        _function <span style="color: #008000;">=</span> function<span style="color: #008000;">;</span>
        _min <span style="color: #008000;">=</span> min<span style="color: #008000;">;</span>
        _max <span style="color: #008000;">=</span> max<span style="color: #008000;">;</span>
    <span style="color: #008000;">}</span>
&nbsp;
    <span style="color: #008080; font-style: italic;">/// &lt;summary&gt;</span>
    <span style="color: #008080; font-style: italic;">/// Simplest IDataSeries implementation - directly enumerate the data when asked for it.</span>
    <span style="color: #008080; font-style: italic;">/// &lt;/summary&gt;</span>
    <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #000000;">System.<span style="color: #0000FF;">Collections</span></span><span style="color: #008000;">.</span><span style="color: #0000FF;">IEnumerator</span> GetEnumerator<span style="color: #008000;">(</span><span style="color: #008000;">)</span>
    <span style="color: #008000;">{</span>
        <span style="color: #6666cc; font-weight: bold;">double</span> step <span style="color: #008000;">=</span> Math<span style="color: #008000;">.</span><span style="color: #0000FF;">Max</span><span style="color: #008000;">(</span><span style="color: #FF0000;">0.0001</span>, <span style="color: #008000;">(</span>_max <span style="color: #008000;">-</span> _min<span style="color: #008000;">)</span> <span style="color: #008000;">/</span> <span style="color: #FF0000;">100</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
        <span style="color: #0600FF; font-weight: bold;">for</span> <span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">double</span> x <span style="color: #008000;">=</span> _min<span style="color: #008000;">;</span> x <span style="color: #008000;">&lt;=</span> _max<span style="color: #008000;">;</span> x <span style="color: #008000;">+=</span> step<span style="color: #008000;">)</span>
        <span style="color: #008000;">{</span>
            <span style="color: #0600FF; font-weight: bold;">yield</span> <span style="color: #0600FF; font-weight: bold;">return</span> <span style="color: #008000;">new</span> DataPoint<span style="color: #008000;">&lt;</span><span style="color: #6666cc; font-weight: bold;">double</span>, <span style="color: #6666cc; font-weight: bold;">double</span><span style="color: #008000;">&gt;</span><span style="color: #008000;">(</span>x, _function<span style="color: #008000;">(</span>x<span style="color: #008000;">)</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
        <span style="color: #008000;">}</span>
    <span style="color: #008000;">}</span>
&nbsp;
    <span style="color: #008080; font-style: italic;">/// &lt;summary&gt;</span>
    <span style="color: #008080; font-style: italic;">/// Trivial INotifyCollectionChanged implementation - do nothing as we don't change.</span>
    <span style="color: #008080; font-style: italic;">/// &lt;/summary&gt;</span>
    <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #0600FF; font-weight: bold;">event</span> NotifyCollectionChangedEventHandler CollectionChanged<span style="color: #008000;">;</span>
<span style="color: #008000;">}</span></pre></div></div><p>This is nice and simple – perhaps too simple. Before going any further let’s refine it a bit. While the minimum we have to do to construct a DataSeries is enumerate the points on demand, charting the series requires more than just looking at the data once, so it turns out this implementation is rather inefficient. Lets generate the data once, and instead present the data series as a list, allowing Visiblox to optimise.</p><div class="wp_syntax"><div class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">class</span> FunctionDataSeries <span style="color: #008000;">:</span> List<span style="color: #008000;">&lt;</span>IDataPoint<span style="color: #008000;">&gt;</span>, IDataSeries
<span style="color: #008000;">{</span>
    <span style="color: #0600FF; font-weight: bold;">private</span> Func<span style="color: #008000;">&lt;</span><span style="color: #6666cc; font-weight: bold;">double</span>, <span style="color: #6666cc; font-weight: bold;">double</span><span style="color: #008000;">&gt;</span> _function<span style="color: #008000;">;</span>
    <span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">double</span> _min, _max<span style="color: #008000;">;</span>
&nbsp;
    <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">string</span> Title <span style="color: #008000;">{</span> get<span style="color: #008000;">;</span> set<span style="color: #008000;">;</span> <span style="color: #008000;">}</span>
&nbsp;
    <span style="color: #0600FF; font-weight: bold;">public</span> FunctionDataSeries<span style="color: #008000;">(</span>Func<span style="color: #008000;">&lt;</span><span style="color: #6666cc; font-weight: bold;">double</span>, <span style="color: #6666cc; font-weight: bold;">double</span><span style="color: #008000;">&gt;</span> function, <span style="color: #6666cc; font-weight: bold;">double</span> min, <span style="color: #6666cc; font-weight: bold;">double</span> max<span style="color: #008000;">)</span>
    <span style="color: #008000;">{</span>
        _function <span style="color: #008000;">=</span> function<span style="color: #008000;">;</span>
        _min <span style="color: #008000;">=</span> min<span style="color: #008000;">;</span>
        _max <span style="color: #008000;">=</span> max<span style="color: #008000;">;</span>
        GenerateData<span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">}</span>
&nbsp;
    <span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">void</span> GenerateData<span style="color: #008000;">(</span><span style="color: #008000;">)</span>
    <span style="color: #008000;">{</span>
        <span style="color: #6666cc; font-weight: bold;">double</span> step <span style="color: #008000;">=</span> Math<span style="color: #008000;">.</span><span style="color: #0000FF;">Max</span><span style="color: #008000;">(</span><span style="color: #FF0000;">0.0001</span>, <span style="color: #008000;">(</span>_max <span style="color: #008000;">-</span> _min<span style="color: #008000;">)</span> <span style="color: #008000;">/</span> <span style="color: #FF0000;">100</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
        <span style="color: #0600FF; font-weight: bold;">for</span> <span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">double</span> x <span style="color: #008000;">=</span> _min<span style="color: #008000;">;</span> x <span style="color: #008000;">&lt;=</span> _max<span style="color: #008000;">;</span> x <span style="color: #008000;">+=</span> step<span style="color: #008000;">)</span>
        <span style="color: #008000;">{</span>
            <span style="color: #0600FF; font-weight: bold;">this</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Add</span><span style="color: #008000;">(</span><span style="color: #008000;">new</span> DataPoint<span style="color: #008000;">&lt;</span><span style="color: #6666cc; font-weight: bold;">double</span>, <span style="color: #6666cc; font-weight: bold;">double</span><span style="color: #008000;">&gt;</span><span style="color: #008000;">(</span>x, _function<span style="color: #008000;">(</span>x<span style="color: #008000;">)</span><span style="color: #008000;">)</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
        <span style="color: #008000;">}</span>
    <span style="color: #008000;">}</span>
&nbsp;
    <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #0600FF; font-weight: bold;">event</span> NotifyCollectionChangedEventHandler CollectionChanged<span style="color: #008000;">;</span>
<span style="color: #008000;">}</span></pre></div></div><h4>Updating with the chart</h4><p>This still doesn’t use INotifyCollectionChanged, simply generating data on construction and adding it to the list. But data is only calculated once, points are only constructed once, and the data is available for random access as required. Now we’re in a good place, so how do we generate more data dynamically when the chart range changes? By giving the data series a reference to the chart, or its axes, we can do this. In fact a reference to the IChartSeries used to display the IDataSeries gives exactly what we need: a reference to the axes used to display that series. From that, we can generate data according to the axis range – and when the range of those axes change, or the axes themselves are replaced, we can regenerate the data accordingly.</p><p>We update the data generation to notify changes:</p><div class="wp_syntax"><div class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">void</span> GenerateData<span style="color: #008000;">(</span><span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
    <span style="color: #0600FF; font-weight: bold;">this</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Clear</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    <span style="color: #6666cc; font-weight: bold;">double</span> step <span style="color: #008000;">=</span> Math<span style="color: #008000;">.</span><span style="color: #0000FF;">Max</span><span style="color: #008000;">(</span><span style="color: #FF0000;">0.0001</span>, <span style="color: #008000;">(</span>_max <span style="color: #008000;">-</span> _min<span style="color: #008000;">)</span> <span style="color: #008000;">/</span> <span style="color: #FF0000;">100</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    <span style="color: #0600FF; font-weight: bold;">for</span> <span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">double</span> x <span style="color: #008000;">=</span> _min<span style="color: #008000;">;</span> x <span style="color: #008000;">&lt;=</span> _max<span style="color: #008000;">;</span> x <span style="color: #008000;">+=</span> step<span style="color: #008000;">)</span>
    <span style="color: #008000;">{</span>
        <span style="color: #0600FF; font-weight: bold;">this</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Add</span><span style="color: #008000;">(</span><span style="color: #008000;">new</span> DataPoint<span style="color: #008000;">&lt;</span><span style="color: #6666cc; font-weight: bold;">double</span>, <span style="color: #6666cc; font-weight: bold;">double</span><span style="color: #008000;">&gt;</span><span style="color: #008000;">(</span>x, _function<span style="color: #008000;">(</span>x<span style="color: #008000;">)</span><span style="color: #008000;">)</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">}</span>
    OnCollectionChanged<span style="color: #008000;">(</span><span style="color: #008000;">new</span> NotifyCollectionChangedEventArgs<span style="color: #008000;">(</span>NotifyCollectionChangedAction<span style="color: #008000;">.</span><span style="color: #0000FF;">Reset</span><span style="color: #008000;">)</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
<span style="color: #008000;">}</span>
&nbsp;
<span style="color: #0600FF; font-weight: bold;">protected</span> <span style="color: #6666cc; font-weight: bold;">void</span> OnCollectionChanged<span style="color: #008000;">(</span>NotifyCollectionChangedEventArgs args<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
    <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>CollectionChanged <span style="color: #008000;">!=</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">)</span>
    <span style="color: #008000;">{</span>
        CollectionChanged<span style="color: #008000;">(</span><span style="color: #0600FF; font-weight: bold;">this</span>, args<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">}</span>
<span style="color: #008000;">}</span></pre></div></div><p>(Note that I could have used ObservableCollection, but instead I implement INotifyCollectionChanged directly – we only ever replace all the data at once, so it’s better to just fire a single Reset notification rather than updating each point in turn.)</p><p>I’ll omit most of the event subscription/unsubscription boilerplate, but here’s the meat of it:</p><div class="wp_syntax"><div class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #008080; font-style: italic;">// Property with some event subscribe/unsubscribe logic using SubscribeAxis</span>
<span style="color: #0600FF; font-weight: bold;">public</span> IChartSeries ChartSeries 
<span style="color: #008000;">{</span>
	get <span style="color: #008000;">{</span> <span style="color: #0600FF; font-weight: bold;">return</span> _chartSeries<span style="color: #008000;">;</span> <span style="color: #008000;">}</span>
	set 
        <span style="color: #008000;">{</span> 
            <span style="color: #008080; font-style: italic;">// ...</span>
            _chartSeries <span style="color: #008000;">=</span> value<span style="color: #008000;">;</span>
            <span style="color: #008080; font-style: italic;">// ...</span>
            SubscribeAxis<span style="color: #008000;">(</span>_chartSeries<span style="color: #008000;">.</span><span style="color: #0000FF;">XAxis</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
            <span style="color: #008080; font-style: italic;">// …</span>
        <span style="color: #008000;">}</span>
<span style="color: #008000;">}</span>
<span style="color: #008080; font-style: italic;">// ...</span>
<span style="color: #008080; font-style: italic;">// Main event subscription logic using AxisEventRelay</span>
<span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">void</span> SubscribeAxis<span style="color: #008000;">(</span>IAxis axis<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
    <span style="color: #008080; font-style: italic;">// AxisEventRelay is a great way to be notified of maximum/minimum effective or actual range limit changes</span>
    <span style="color: #008080; font-style: italic;">// without listening to properties directly. </span>
    <span style="color: #008080; font-style: italic;">// Try changing this to AxisEventEnumeration.ActualRangeEffectiveLimitsChanged</span>
    AxisEventRelay relay <span style="color: #008000;">=</span> <span style="color: #008000;">new</span> AxisEventRelay<span style="color: #008000;">(</span>axis, AxisEventEnumeration<span style="color: #008000;">.</span><span style="color: #0000FF;">ActualRangeLimitsChanged</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    relay<span style="color: #008000;">.</span><span style="color: #0000FF;">AxisEvent</span> <span style="color: #008000;">+=</span> Relay_AxisEvent<span style="color: #008000;">;</span>
    GenerateData<span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
<span style="color: #008000;">}</span>
&nbsp;
<span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">void</span> Relay_AxisEvent<span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">object</span> sender, AxisEventRelayEventArgs e<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
    var xAxis <span style="color: #008000;">=</span> _xAxisRelay<span style="color: #008000;">.</span><span style="color: #0000FF;">Axis</span><span style="color: #008000;">;</span>
    _min <span style="color: #008000;">=</span> <span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">double</span><span style="color: #008000;">)</span>xAxis<span style="color: #008000;">.</span><span style="color: #0000FF;">ActualRange</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Minimum</span><span style="color: #008000;">;</span>
    _max <span style="color: #008000;">=</span> <span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">double</span><span style="color: #008000;">)</span>xAxis<span style="color: #008000;">.</span><span style="color: #0000FF;">ActualRange</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Maximum</span><span style="color: #008000;">;</span>
&nbsp;
    GenerateData<span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
<span style="color: #008000;">}</span></pre></div></div><p>I’ve regenerated the data only on actual range limits changing – this means that when zooming/panning when only the “effective” range changes, the data series does not regenerate. This might be a good idea for performance, but I mostly did this so that you can “see it working” – if you wanted to do this in reality, I’d recommend generating extra data off-screen to allow for a smoother panning experience. </p><p>Great! now we can tell our dataseries the IChartSeries used to render it, and it will update the generated data range accordingly. So:</p><div class="wp_syntax"><div class="code"><pre class="csharp" style="font-family: monospace;">var dataSeries <span style="color: #008000;">=</span> <span style="color: #008000;">new</span> FunctionDataSeries<span style="color: #008000;">(</span>x <span style="color: #008000;">=&gt;</span> <span style="color: #FF0000;">2</span><span style="color: #008000;">*</span>x<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
var chartSeries <span style="color: #008000;">=</span> <span style="color: #008000;">new</span> LineSeries <span style="color: #008000;">{</span> DataSeries <span style="color: #008000;">=</span> dataSeries <span style="color: #008000;">}</span><span style="color: #008000;">;</span>
dataSeries<span style="color: #008000;">.</span><span style="color: #0000FF;">ChartSeries</span> <span style="color: #008000;">=</span> chartSeries<span style="color: #008000;">;</span>
myChart<span style="color: #008000;">.</span><span style="color: #0000FF;">Series</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Add</span><span style="color: #008000;">(</span>chartSeries<span style="color: #008000;">)</span><span style="color: #008000;">;</span></pre></div></div><p>And now for the sprinkle of magic. Visiblox defines an interface  IChartSeriesAwareDataSeries. If a data series implements this interface – which consists of a single property</p><div class="wp_syntax"><div class="code"><pre class="csharp" style="font-family: monospace;">IChartSeries ChartSeries <span style="color: #008000;">{</span> get<span style="color: #008000;">;</span> set<span style="color: #008000;">;</span> <span style="color: #008000;">}</span></pre></div></div><p>the data series is informed of the IChartSeries  used to render it, when that is added to the chart. (Normally a data series is “just data”, and may be displayed by multiple chart series – but in this case it only makes sense to consider this a 1:1 relationship). Then our example above becomes:</p><div class="wp_syntax"><div class="code"><pre class="csharp" style="font-family: monospace;">myChart<span style="color: #008000;">.</span><span style="color: #0000FF;">Series</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Add</span><span style="color: #008000;">(</span><span style="color: #008000;">new</span> LineSeries <span style="color: #008000;">{</span> DataSeries <span style="color: #008000;">=</span> <span style="color: #008000;">new</span> FunctionDataSeries<span style="color: #008000;">(</span>x <span style="color: #008000;">=&gt;</span> <span style="color: #FF0000;">2</span><span style="color: #008000;">*</span>x<span style="color: #008000;">)</span> <span style="color: #008000;">}</span> <span style="color: #008000;">)</span><span style="color: #008000;">;</span></pre></div></div><h4>Plotting user functions</h4><p>OK, so we have code to wrap a function in a data series. I’m going to demo that by charting a function typed in by the user. We’ll chart functions of the form “y = f(x)”, so lets just parse some simple arithmetic expressions of x.</p><p>For the parser, I’ve thrown together a parser in <a href="http://research.microsoft.com/en-us/um/cambridge/projects/fsharp/">F#</a> with <a href="http://www.quanttec.com/fparsec/">FParsec</a>, a parser combinator library. Now I wouldn’t necessarily recommend introducing a dependency on the core F# DLLs and the FParsec library itself to parse a trivial language like this in an otherwise C# project. That said, it was fun to write and it’s rather concise.</p><p>I won’t ask you to understand the code in detail, but I’m reproducing it below to give a flavour of it. The constructed parser takes in a string, which is an expression of x, and (if successful) returns a function from x to the expression value (so <code>double-double</code>). So there’s no need to construct an <a href="http://en.wikipedia.org/wiki/Abstract_syntax_tree" title="Abstract Syntax Tree">Abstract Syntax Tree</a>; instead the result of parsing a sub-expression is a function from x to the result of that expression, and these functions are combined to interpret larger expressions. (The funny symbols like <code>&gt;&gt;%</code> and <code>|&gt;&gt;</code> are the FParsec’s combinators, which allow parsers for subexpressions to be combined, with the different varieties for tasks like parsing 2 alternatives, or matching some text then passing it through a function)</p><p><!-- F# is sort of like OCaml... --></p><div class="wp_syntax"><div class="code"><pre class="ocaml" style="font-family: monospace;"><span style="color: #06c; font-weight: bold;">let</span> sym <span style="color: #a52a2a;">=</span> pstring
<span style="color: #5d478b; font-style: italic;">(* environment is just a single double (the x value) *)</span>
<span style="color: #06c; font-weight: bold;">type</span> env <span style="color: #a52a2a;">=</span> double
&nbsp;
<span style="color: #5d478b; font-style: italic;">(* variable becomes function returning the 'environment' x *)</span>
<span style="color: #06c; font-weight: bold;">let</span> var <span style="color: #a52a2a;">=</span> sym <span style="color: #3cb371;">"x"</span> <span style="color: #a52a2a;">&gt;&gt;%</span> id
&nbsp;
<span style="color: #5d478b; font-style: italic;">(* float literal becomes function returning that literal, ignoring the environment *)</span>
<span style="color: #06c; font-weight: bold;">let</span> num <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">(</span>pfloat <span style="color: #a52a2a;">|&gt;&gt;</span> <span style="color: #a52a2a;">(</span><span style="color: #06c; font-weight: bold;">fun</span> z _ <span style="color: #a52a2a;">-&gt;</span> z<span style="color: #a52a2a;">)</span><span style="color: #a52a2a;">)</span>
&nbsp;
<span style="color: #5d478b; font-style: italic;">(* helper function converting a numeric operator to a function of the environment *)</span>
<span style="color: #5d478b; font-style: italic;">(* fop : (double -&gt; double -&gt; double) -&gt; (env -&gt; double) -&gt; (env -&gt; double) -&gt; env -&gt; double *)</span>
<span style="color: #06c; font-weight: bold;">let</span> fop op fa fb env <span style="color: #a52a2a;">=</span> fa env <span style="color: #a52a2a;">|&gt;</span> op <span style="color: #a52a2a;">&lt;|</span> fb env
&nbsp;
<span style="color: #5d478b; font-style: italic;">(* Parse single operators - return function taking two operands and giving the result *)</span>
<span style="color: #06c; font-weight: bold;">let</span> <span style="color: #a52a2a;">(</span>addop <span style="color: #a52a2a;">:</span> Parser<span style="color: #a52a2a;">&lt;</span>_,unit<span style="color: #a52a2a;">&gt;</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">=</span> 
    sym <span style="color: #3cb371;">"+"</span> <span style="color: #a52a2a;">&gt;&gt;%</span> fop <span style="color: #a52a2a;">(</span><span style="color: #a52a2a;">+</span><span style="color: #a52a2a;">)</span>
    <span style="color: #a52a2a;">&lt;|&gt;</span> <span style="color: #a52a2a;">(</span> sym <span style="color: #3cb371;">"-"</span> <span style="color: #a52a2a;">&gt;&gt;%</span> fop <span style="color: #a52a2a;">(</span><span style="color: #a52a2a;">-</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">)</span>
<span style="color: #06c; font-weight: bold;">let</span> <span style="color: #a52a2a;">(</span>mulop <span style="color: #a52a2a;">:</span> Parser<span style="color: #a52a2a;">&lt;</span>_,unit<span style="color: #a52a2a;">&gt;</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">=</span> 
    sym <span style="color: #3cb371;">"*"</span> <span style="color: #a52a2a;">&gt;&gt;%</span> fop <span style="color: #5d478b; font-style: italic;">(*)                  // Keep syntax highlighter happy! *)</span>
    <span style="color: #a52a2a;">&lt;|&gt;</span> <span style="color: #a52a2a;">(</span> sym <span style="color: #3cb371;">"/"</span> <span style="color: #a52a2a;">&gt;&gt;%</span> fop <span style="color: #a52a2a;">(</span><span style="color: #a52a2a;">/</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">)</span>
&nbsp;
<span style="color: #06c; font-weight: bold;">let</span> <span style="color: #a52a2a;">(</span>atom<span style="color: #a52a2a;">:</span> Parser<span style="color: #a52a2a;">&lt;</span>float<span style="color: #a52a2a;">-&gt;</span>float,unit<span style="color: #a52a2a;">&gt;</span><span style="color: #a52a2a;">)</span>, atomImpl <span style="color: #a52a2a;">=</span> createParserForwardedToRef<span style="color: #a52a2a;">(</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">//</span> break circular reference
&nbsp;
<span style="color: #5d478b; font-style: italic;">(*  Parse math function name - return the function itself *)</span>
<span style="color: #06c; font-weight: bold;">let</span> <span style="color: #a52a2a;">(</span>mathOp<span style="color: #a52a2a;">:</span> Parser<span style="color: #a52a2a;">&lt;</span>_,unit<span style="color: #a52a2a;">&gt;</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">=</span> 
       sym <span style="color: #3cb371;">"sin"</span> <span style="color: #a52a2a;">&gt;&gt;%</span> <span style="color: #06c; font-weight: bold;">sin</span>
       <span style="color: #a52a2a;">&lt;|&gt;</span> <span style="color: #a52a2a;">(</span> sym <span style="color: #3cb371;">"cos"</span> <span style="color: #a52a2a;">&gt;&gt;%</span> <span style="color: #06c; font-weight: bold;">cos</span> <span style="color: #a52a2a;">)</span>
       <span style="color: #a52a2a;">&lt;|&gt;</span> <span style="color: #a52a2a;">(</span> sym <span style="color: #3cb371;">"tan"</span> <span style="color: #a52a2a;">&gt;&gt;%</span> <span style="color: #06c; font-weight: bold;">tan</span> <span style="color: #a52a2a;">)</span>
&nbsp;
<span style="color: #5d478b; font-style: italic;">(* f(x) or f(2+3) *)</span>
<span style="color: #5d478b; font-style: italic;">(* compose result of parsing the expression with the given function *)</span>
<span style="color: #06c; font-weight: bold;">let</span> mathExpr <span style="color: #a52a2a;">=</span> mathOp <span style="color: #a52a2a;">.&gt;&gt;.</span> atom <span style="color: #a52a2a;">|&gt;&gt;</span> <span style="color: #06c; font-weight: bold;">fun</span> <span style="color: #a52a2a;">(</span>f,g<span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">-&gt;</span> g <span style="color: #a52a2a;">&gt;&gt;</span> f
&nbsp;
<span style="color: #5d478b; font-style: italic;">(* term, expr - chain of operators of a given precedence *)</span>
<span style="color: #06c; font-weight: bold;">let</span> term <span style="color: #a52a2a;">=</span> chainl1 atom mulop
<span style="color: #06c; font-weight: bold;">let</span> expr <span style="color: #a52a2a;">=</span> chainl1 term addop
atomImpl <span style="color: #a52a2a;">:=</span> num <span style="color: #a52a2a;">&lt;|&gt;</span> var  <span style="color: #a52a2a;">&lt;|&gt;</span> mathExpr <span style="color: #a52a2a;">&lt;|&gt;</span> between <span style="color: #a52a2a;">(</span>sym <span style="color: #3cb371;">"("</span><span style="color: #a52a2a;">)</span> <span style="color: #a52a2a;">(</span>sym <span style="color: #3cb371;">")"</span><span style="color: #a52a2a;">)</span> expr</pre></div></div><p>Putting it all together:<br />
       <object data="data:application/x-silverlight-2," type="application/x-silverlight-2" width="400" height="400"><param name="source" value="http://www.scottlogic.co.uk/wp-content/uploads/2011/10/UserFunctionPlotter.xap" /><param name="background" value="white" /><param name="minRuntimeVersion" value="4.0.50826.0" /><param name="autoUpgrade" value="true" /><a href="http://go.microsoft.com/fwlink/?LinkID=149156&amp;v=4.0.50826.0" style="text-decoration: none;"><br />
 			  <img src="http://go.microsoft.com/fwlink/?LinkId=161376" alt="Get Microsoft Silverlight" style="border-style: none;" /><br />
		  </a><br />
	    </object></p><p>(Try writing arithmetic expressions in x using *,/,+,-, sin(), cos() – note spaces are not permitted with this simple parser.)</p><p>The source code to this <a href="http://www.scottlogic.co.uk/wp-content/uploads/2011/10/UserFunctionPlotter.zip">is available here</a>, this requires the free version of Visiblox Charts which can be <a href="http://www.visiblox.com/download">downloaded here</a>.</p></div>