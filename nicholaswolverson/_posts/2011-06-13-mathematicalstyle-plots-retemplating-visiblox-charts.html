---
author: Nicholas Wolverson
tags: 
permalink: /2011/06/mathematical-style-plots-retemplating-visiblox-charts/index.html
layout: blog
---
<div class="entry"><p>This post demonstrates how to re-template a Visiblox Chart to render data with mathematical-style “on-chart” axes.<span id="more-117518"></span></p><p>Mathematical charts are usually drawn around the zero point, with the X and Y axes crossing at 0,0, and the plot drawn on top of the axes. In other fields, quantities which are never negative are plotted, and this means the zero point (or origin) may be the bottom left of the chart. Otherwise 0 may not be plotted, or horizontal axis may be time or some discrete scale. In each case the axes are fixed at the outside of the chart.</p><p>Visiblox Charts supports this latter type of chart out of the box. What about the mathematical axes-crossing style? At the moment that’s not supported, but here I’ll show you how simple it is to achieve this effect by re-templating the chart.</p><div style="text-align: center;">
<img src="http://www.scottlogic.co.uk/wp-content/uploads/2011/06/MidAxis-Sin.png" alt="Sin chart" title="Visiblox graph of y=sin(x) with on-chart axes" />
</div><h4>Templating a Visiblox Chart</h4><p>An Visiblox chart is an instance of the Chart control. As with any WPF/Silverlight custom control, this can be retemplated to alter its visual appearence. Of course as the control has all the rendering logic to draw complex charts, there is a limit to what you can achive, but it’s surprising how much can be done to alter the layout of the  chart. (Other examples might include embedding some custom data display within the chart.)</p><p>Firstly, consult the <a href="http://www.visiblox.com/docs/">API documentation</a> to see the default template of the chart (the Visiblox API documentation reproduces default or sample templates for most templatable controls, but in general you can find this out for yourself using a tool such as <a href="http://blog.wpfwonderland.com/2007/01/02/wpf-tools-stylesnooper/">StyleSnooper</a> or Reflector). You’ll see that there is some complexity to support axes on all four sides of the chart, and other nice default behaviour – but here we’ll cut back to basics.</p><p>We’ll use a Grid with 2 rows, the first being the title, the 2nd containing the chart. Notice that the default template has a more complex grid. Important parts of this are the <em>plot area</em> (containing all the elements rendered “on chart” in their own individual containers), and the <em>axis containers</em>. </p><p>At this point I’m going to digress a little regarding axes. A Visiblox axis is responsible for 2 things: calculating based on data values where points should be rendered in that dimension, and actually rendering the axis itself. Note that in the default template the Y axis container is in a grid cell adjacent to the plot area, it thus has the same height as the plot area, and thus the ticks on the axis correspond to render positions within the plot area. Similarly the X axis is the same width as the plot area. </p><p>In order to render our axes within the chart, we’ll simply move them into the same grid cell as the plot area. The Y axis will have the same height as it did before, and the X axis will have the same width, so everything will render correctly using the default Visiblox axis implementations.</p><div class="wp_syntax"><div class="code"><pre class="xml" style="font-family: monospace;"><span style="color: #808080; font-style: italic;">&lt;!-- Chart control template placing axes inside plot area --&gt;</span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;ControlTemplate</span> <span style="color: #000066;">TargetType</span>=<span style="color: #ff0000;">"vis:Chart"</span> <span style="color: #000066;">x:Key</span>=<span style="color: #ff0000;">"ChartTemplate"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Grid</span> <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"LayoutRoot"</span> <span style="color: #000066;">Background</span>=<span style="color: #ff0000;">"{TemplateBinding Background}"</span> <span style="color: #000066;">Opacity</span>=<span style="color: #ff0000;">"{TemplateBinding Opacity}"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Grid.RowDefinitions<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
            <span style="color: #808080; font-style: italic;">&lt;!-- Title --&gt;</span>
            <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;RowDefinition</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>
            <span style="color: #808080; font-style: italic;">&lt;!-- Plot Area --&gt;</span>
            <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;RowDefinition</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Grid.RowDefinitions<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;TextBlock</span> <span style="color: #000066;">Text</span>=<span style="color: #ff0000;">"{TemplateBinding Title}"</span> <span style="color: #000066;">Grid.Row</span>=<span style="color: #ff0000;">"0"</span> <span style="color: #000066;">Grid.Column</span>=<span style="color: #ff0000;">"0"</span> <span style="color: #000066;">Style</span>=<span style="color: #ff0000;">"{TemplateBinding TitleStyle}"</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Grid</span> <span style="color: #000066;">Name</span>=<span style="color: #ff0000;">"PlotArea"</span> <span style="color: #000066;">Style</span>=<span style="color: #ff0000;">"{TemplateBinding PlotAreaStyle}"</span> <span style="color: #000066;">Grid.Row</span>=<span style="color: #ff0000;">"1"</span> <span style="color: #000066;">primitives:Clip.ToBounds</span>=<span style="color: #ff0000;">"true"</span> <span style="color: #000000; font-weight: bold;">&gt;</span></span>
            <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Border</span> <span style="color: #000066;">Name</span>=<span style="color: #ff0000;">"PlotAreaBorder"</span> <span style="color: #000066;">Style</span>=<span style="color: #ff0000;">"{TemplateBinding PlotAreaBorderStyle}"</span> <span style="color: #000066;">Canvas.ZIndex</span>=<span style="color: #ff0000;">"120"</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>
            <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Grid</span> <span style="color: #000066;">Name</span>=<span style="color: #ff0000;">"SeriesContainer"</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>
            <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Grid</span> <span style="color: #000066;">Name</span>=<span style="color: #ff0000;">"GridlinesContainer"</span> <span style="color: #000066;">Canvas.ZIndex</span>=<span style="color: #ff0000;">"-100"</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>
            <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Canvas</span> <span style="color: #000066;">Name</span>=<span style="color: #ff0000;">"BehaviourContainer"</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Grid<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Canvas</span> <span style="color: #000066;">Grid.Row</span>=<span style="color: #ff0000;">"1"</span> <span style="color: #000066;">primitives:Clip.ToBounds</span>=<span style="color: #ff0000;">"true"</span> <span style="color: #000066;">IsHitTestVisible</span>=<span style="color: #ff0000;">"False"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
            <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Grid</span> <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"YAxisPrimaryContainer"</span> <span style="color: #000066;">Canvas.Top</span>=<span style="color: #ff0000;">"0"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
            <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Grid</span> <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"XAxisPrimaryContainer"</span> <span style="color: #000066;">Canvas.Left</span>=<span style="color: #ff0000;">"0"</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Canvas<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Grid<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/ControlTemplate<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre></div></div><p>All that remains to be done is to shift the axes to the correct 0 position in order to achive the desired visual effect. The following code repositions the axes. The Y axis is positioned by asking the X axis where it plots 0, and vice versa.</p><div class="wp_syntax"><div class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">void</span> RepositionAxes<span style="color: #008000;">(</span><span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
    <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>Chart<span style="color: #008000;">.</span><span style="color: #0000FF;">YAxis</span> <span style="color: #008000;">==</span> <span style="color: #0600FF; font-weight: bold;">null</span> <span style="color: #008000;">||</span> Chart<span style="color: #008000;">.</span><span style="color: #0000FF;">XAxis</span> <span style="color: #008000;">==</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">)</span> <span style="color: #008000;">{</span> <span style="color: #0600FF; font-weight: bold;">return</span><span style="color: #008000;">;</span> <span style="color: #008000;">}</span>
    var yAxisContainer <span style="color: #008000;">=</span> VisualTreeHelper<span style="color: #008000;">.</span><span style="color: #0000FF;">GetParent</span><span style="color: #008000;">(</span>Chart<span style="color: #008000;">.</span><span style="color: #0000FF;">YAxis</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Element</span><span style="color: #008000;">)</span> <span style="color: #0600FF; font-weight: bold;">as</span> FrameworkElement<span style="color: #008000;">;</span>
    var xAxisContainer <span style="color: #008000;">=</span> VisualTreeHelper<span style="color: #008000;">.</span><span style="color: #0000FF;">GetParent</span><span style="color: #008000;">(</span>Chart<span style="color: #008000;">.</span><span style="color: #0000FF;">XAxis</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Element</span><span style="color: #008000;">)</span> <span style="color: #0600FF; font-weight: bold;">as</span> FrameworkElement<span style="color: #008000;">;</span>
&nbsp;
    <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>yAxisContainer <span style="color: #008000;">==</span> <span style="color: #0600FF; font-weight: bold;">null</span> <span style="color: #008000;">||</span> xAxisContainer <span style="color: #008000;">==</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">)</span> <span style="color: #008000;">{</span> <span style="color: #0600FF; font-weight: bold;">return</span><span style="color: #008000;">;</span> <span style="color: #008000;">}</span>
&nbsp;
    var xPos <span style="color: #008000;">=</span> Chart<span style="color: #008000;">.</span><span style="color: #0000FF;">XAxis</span><span style="color: #008000;">.</span><span style="color: #0000FF;">GetDataValueAsRenderPositionWithZoom</span><span style="color: #008000;">(</span><span style="color: #FF0000;">0.0</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    var yPos <span style="color: #008000;">=</span> Chart<span style="color: #008000;">.</span><span style="color: #0000FF;">YAxis</span><span style="color: #008000;">.</span><span style="color: #0000FF;">GetDataValueAsRenderPositionWithZoom</span><span style="color: #008000;">(</span><span style="color: #FF0000;">0.0</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
	<span style="color: #008080; font-style: italic;">// Account for the width of the Y axis, as it is the right side which should be plotted at 0</span>
    Canvas<span style="color: #008000;">.</span><span style="color: #0000FF;">SetLeft</span><span style="color: #008000;">(</span>yAxisContainer,  Math<span style="color: #008000;">.</span><span style="color: #0000FF;">Floor</span><span style="color: #008000;">(</span>xPos<span style="color: #008000;">)</span><span style="color: #008000;">+</span><span style="color: #FF0000;">0.5</span> <span style="color: #008000;">-</span> yAxisContainer<span style="color: #008000;">.</span><span style="color: #0000FF;">ActualWidth</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    Canvas<span style="color: #008000;">.</span><span style="color: #0000FF;">SetTop</span><span style="color: #008000;">(</span>xAxisContainer, <span style="color: #008000;">(</span>Math<span style="color: #008000;">.</span><span style="color: #0000FF;">Floor</span><span style="color: #008000;">(</span>yPos<span style="color: #008000;">)</span> <span style="color: #008000;">+</span> <span style="color: #FF0000;">0.5</span><span style="color: #008000;">)</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
<span style="color: #008000;">}</span></pre></div></div><p>The axes will have to be repositioned when either the layout changes (eg the chart changes in size or the Y axis becomes wider/narrower), or the position to plot 0 changes (eg because the chart range has changed). Putting it together, the following chart plots a sine curve, and adds a panning behaviour to demonstrate that the usual interactivity of a Visiblox chart is available.</p><div class="wp_syntax"><div class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">public</span> MainPage<span style="color: #008000;">(</span><span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
    InitializeComponent<span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    var chartRelay <span style="color: #008000;">=</span> <span style="color: #008000;">new</span> ChartAxesEventRelay<span style="color: #008000;">(</span>Chart, AxisEventEnumeration<span style="color: #008000;">.</span><span style="color: #0000FF;">ActualRangeEffectiveLimitsChanged</span> <span style="color: #008000;">|</span> AxisEventEnumeration<span style="color: #008000;">.</span><span style="color: #0000FF;">ValueConversion</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    chartRelay<span style="color: #008000;">.</span><span style="color: #0000FF;">AxisEvent</span> <span style="color: #008000;">+=</span> RepositionAxesEvent<span style="color: #008000;">;</span>
    Chart<span style="color: #008000;">.</span><span style="color: #0000FF;">SizeChanged</span> <span style="color: #008000;">+=</span> RepositionAxesEvent<span style="color: #008000;">;</span>
    Chart<span style="color: #008000;">.</span><span style="color: #0000FF;">Loaded</span> <span style="color: #008000;">+=</span> Chart_Loaded<span style="color: #008000;">;</span>
&nbsp;
    AddSeries<span style="color: #008000;">(</span>x <span style="color: #008000;">=&gt;</span> Math<span style="color: #008000;">.</span><span style="color: #0000FF;">Sin</span><span style="color: #008000;">(</span>x<span style="color: #008000;">)</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
<span style="color: #008000;">}</span>
&nbsp;
<span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">void</span> Chart_Loaded<span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">object</span> sender, RoutedEventArgs e<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
    Chart<span style="color: #008000;">.</span><span style="color: #0000FF;">ApplyTemplate</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    RepositionAxes<span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    Chart<span style="color: #008000;">.</span><span style="color: #0000FF;">XAxis</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Element</span><span style="color: #008000;">.</span><span style="color: #0000FF;">SizeChanged</span> <span style="color: #008000;">+=</span> RepositionAxesEvent<span style="color: #008000;">;</span>
    Chart<span style="color: #008000;">.</span><span style="color: #0000FF;">YAxis</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Element</span><span style="color: #008000;">.</span><span style="color: #0000FF;">SizeChanged</span> <span style="color: #008000;">+=</span> RepositionAxesEvent<span style="color: #008000;">;</span>
<span style="color: #008000;">}</span>
&nbsp;
<span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">void</span> AddSeries<span style="color: #008000;">(</span>Func<span style="color: #008000;">&lt;</span><span style="color: #6666cc; font-weight: bold;">double</span>,<span style="color: #6666cc; font-weight: bold;">double</span><span style="color: #008000;">&gt;</span> f<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
    var ds <span style="color: #008000;">=</span> <span style="color: #008000;">new</span> DataSeries<span style="color: #008000;">&lt;</span><span style="color: #6666cc; font-weight: bold;">double</span>, <span style="color: #6666cc; font-weight: bold;">double</span><span style="color: #008000;">&gt;</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    <span style="color: #0600FF; font-weight: bold;">for</span> <span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">double</span> x <span style="color: #008000;">=</span> <span style="color: #008000;">-</span><span style="color: #FF0000;">10</span><span style="color: #008000;">;</span> x <span style="color: #008000;">&lt;=</span> <span style="color: #FF0000;">10</span><span style="color: #008000;">;</span> x <span style="color: #008000;">+=</span> <span style="color: #FF0000;">0.01</span><span style="color: #008000;">)</span>
    <span style="color: #008000;">{</span>
        ds<span style="color: #008000;">.</span><span style="color: #0000FF;">Add</span><span style="color: #008000;">(</span><span style="color: #008000;">new</span> DataPoint<span style="color: #008000;">&lt;</span><span style="color: #6666cc; font-weight: bold;">double</span>, <span style="color: #6666cc; font-weight: bold;">double</span><span style="color: #008000;">&gt;</span><span style="color: #008000;">(</span>x, f<span style="color: #008000;">(</span>x<span style="color: #008000;">)</span><span style="color: #008000;">)</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span> <span style="color: #008000;">;</span>
    <span style="color: #008000;">}</span>
    Chart<span style="color: #008000;">.</span><span style="color: #0000FF;">Series</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Add</span><span style="color: #008000;">(</span><span style="color: #008000;">new</span> LineSeries <span style="color: #008000;">{</span> DataSeries <span style="color: #008000;">=</span> ds <span style="color: #008000;">}</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
<span style="color: #008000;">}</span>
&nbsp;
<span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">void</span> RepositionAxesEvent<span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">object</span> sender, EventArgs e<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
    RepositionAxes<span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
<span style="color: #008000;">}</span></pre></div></div><h4>Conclusion</h4><p>In this article I showed how to re-template a Visiblox chart to render its axes within the main plot area. I didn’t consider many features Visiblox provides, such as a legend or multiple axes, but for those that need it, a custom template can provide flexibility to meet your particular situation.</p><p>You can download source for this example <a href="{{ site.url }}/wp-content/uploads/2011/05/MidAxis.zip">in this project</a>.</p></div>