---
author: Rolf Baxter
tags: 
permalink: /2012/05/developing-an-extended-drag-and-drop-treeview-control-in-c-net/index.html
layout: blog
---
<div class="entry"><p><em>This blog post talks about developing an extended Drag and Drop TreeView control in C#.&nbsp; I say extended because the .Net framework already provides simple drag and drop functionality, but the visual feedback during the drag operation is somewhat lacking.&nbsp; I found a number of TreeView extensions on CodeProject, some of which work quite nicely.&nbsp; However, people have tended to focus on moving folder structures in ‘Windows Explorer’ type clones, while I wanted to focus on restructuring generic trees.&nbsp; In that spirit, this control shows the substructure of the data you are moving during the drag operation, as opposed to a moving folder image.</em></p><h3>Overview</h3><p>Until recently I had never really used the drag and drop functionality of the .Net framework so wanted to experiment a little.&nbsp; In pondering the ‘time and the place’ to use drag and drop I found an interesting article by Leisa Reichelt (<a title="here" href="http://www.disambiguity.com/when-to-use-drag-drop-some-informal-research-results/" target="_blank">here</a>).&nbsp; Her research suggested that users generally preferred to use drag and drop during data manipulation problems such as organising items relative to each other.&nbsp; Indeed, most of us have made extensive use of drag and drop in Windows Explorer to move files around, and thus the .Net TreeView control seemed like an excellent test subject on which I could experiment.</p><p>Given the prominence of drag and drop within windows I was somewhat surprised to find that the .Net Framework’s TreeView control supplied only basic drag and drop provisions, and having quickly grown bored of this functionality extending the control became the object of my experimentation.&nbsp; Where the control particularly lacks provision is in re-structuring a tree <em>within</em> a control, which you simply cannot do.&nbsp; Furthermore, although you can drag data from one control to another using the Drag and Drop API, the visual feedback is severely limited and fails to communicate what data<br />
is being dragged. It was these two aspects in particular that I focused on during my experimentation.&nbsp; In this post I’ll talk about a couple of interesting elements of my experience, while the full control and sample application is available <a href="{{ site.url }}/wp-content/uploads/2012/05/DDTreeView1.zip">here</a>.</p><p>To illustrate the end result, Figure 1 shows <em>Branch 0 – Sub-branch 1</em> as it is dragged into <em>Branch 1,</em> and we can show the same feedback when dragging from one control to another to replace the distinctly unimpressive feedback given by standard Drag and Drop.<a href="http<a href="{{ site.url }}loping-an-extended-drag-and-drop-treeview-control-in-c-net/screenshot-2/" rel="attachment wp-att-151887"><img class="aligncenter size-full wp-image-151887" title="Extended Drag and Drop TreeView" src="http://www.scottlogic.co.uk/wp-content/uploads/2012/05/screenshot.png" alt="Screenshot of the Extended Drag and Drop TreeView" width="754" height="233" /></a></p><p>&nbsp;</p><h3>Displaying the dragged data &amp; dragging between controls</h3><p>While experimenting with various ways of showing the data being dragged, I decided that using a borderless form with a partial treeview provided a simple but effective solution.&nbsp; The extended TreeView uses a member variable to keep track of the TreeNode being dragged, so building a second TreeView to illustrate its structure in a popup is trivial.</p><p>For dragging between controls you can hook into the standard drag and drop API.&nbsp; The great thing about this is that by listening to the DragEnter event we can directly access the data being dragged (the TreeNode), so it is simple to initialise a new popup window when our control’s DragEnter event fires. The resulting event handler looks as follows:</p><div class="wp_syntax"><div class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">void</span> OnDragEnter<span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">object</span> sender,
                         <span style="color: #000000;">System</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Windows</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Forms</span><span style="color: #008000;">.</span><span style="color: #0000FF;">DragEventArgs</span> e<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
   <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>e<span style="color: #008000;">.</span><span style="color: #0000FF;">Data</span><span style="color: #008000;">.</span><span style="color: #0000FF;">GetDataPresent</span><span style="color: #008000;">(</span><span style="color: #008000;">typeof</span><span style="color: #008000;">(</span>TreeNode<span style="color: #008000;">)</span><span style="color: #008000;">)</span><span style="color: #008000;">)</span>
   <span style="color: #008000;">{</span>
      e<span style="color: #008000;">.</span><span style="color: #0000FF;">Effect</span> <span style="color: #008000;">=</span> DragDropEffects<span style="color: #008000;">.</span><span style="color: #0000FF;">Move</span><span style="color: #008000;">;</span>
      TreeNode tn <span style="color: #008000;">=</span> 
          <span style="color: #008000;">(</span>TreeNode<span style="color: #008000;">)</span>e<span style="color: #008000;">.</span><span style="color: #0000FF;">Data</span><span style="color: #008000;">.</span><span style="color: #0000FF;">GetData</span><span style="color: #008000;">(</span><span style="color: #008000;">typeof</span><span style="color: #008000;">(</span>TreeNode<span style="color: #008000;">)</span><span style="color: #008000;">.</span><span style="color: #0000FF;">FullName</span>, <span style="color: #0600FF; font-weight: bold;">true</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
      <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span><span style="color: #008000;">!</span>CompareNodeTagState<span style="color: #008000;">(</span>_nodeBeingMoved, tn<span style="color: #008000;">)</span><span style="color: #008000;">)</span>
      <span style="color: #008000;">{</span>
         _nodeBeingMoved <span style="color: #008000;">=</span> tn<span style="color: #008000;">;</span>
         ReInitMovingDataWindow<span style="color: #008000;">(</span>_nodeBeingMoved<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
      <span style="color: #008000;">}</span>
      <span style="color: #008080; font-style: italic;">// We have some valid data in _previousSelectedNode, </span>
      <span style="color: #008080; font-style: italic;">// so change the curser back</span>
      <span style="color: #0600FF; font-weight: bold;">this</span><span style="color: #008000;">.</span><span style="color: #0000FF;">TopLevelControl</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Cursor</span> <span style="color: #008000;">=</span> Cursors<span style="color: #008000;">.</span><span style="color: #0600FF; font-weight: bold;">Default</span><span style="color: #008000;">;</span>
      <span style="color: #0600FF; font-weight: bold;">this</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Focus</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
   <span style="color: #008000;">}</span>
   <span style="color: #0600FF; font-weight: bold;">else</span>
   <span style="color: #008000;">{</span>
      e<span style="color: #008000;">.</span><span style="color: #0000FF;">Effect</span> <span style="color: #008000;">=</span> DragDropEffects<span style="color: #008000;">.</span><span style="color: #0000FF;">None</span><span style="color: #008000;">;</span>
      _nodeBeingMoved <span style="color: #008000;">=</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">;</span>
   <span style="color: #008000;">}</span>
<span style="color: #008000;">}</span></pre></div></div><p>The other great thing about hooking into the drag and drop API is that it exposes the actual objects being moved rather than a serialised copy.&nbsp; This means that when it comes time to change the TreeNode’s parent, we just call <code>TreeNode.Remove()</code> and then add the node to its new parent.&nbsp; This automatically removes the node from the source control (where the drag started) and leads to a very neat solution.</p><h3>Node Highlighting</h3><p>One of the other things I wanted to do was to use node highlighting to identify restructured tree components. The figure above shows that the data being dragged is highlighted blue in addition to the popup window. Furthermore, once the data is dropped into a new location the data is highlighted green. One can allow the user to restructure the data through multiple drag and drop operations by persisting state information until a save operation is called.</p><p>I chose to persist state information by using the TreeNode Tag property to hold a simple NodeState structure, and the helper function ‘GetNodeTagState’ was useful for accessing a TreeNode’s state. These are shown below:</p><div class="wp_syntax"><div class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #6666cc; font-weight: bold;">struct</span> NodeState
<span style="color: #008000;">{</span>
   <span style="color: #0600FF; font-weight: bold;">Public</span> <span style="color: #6666cc; font-weight: bold;">bool</span> Moving<span style="color: #008000;">;</span>
   <span style="color: #0600FF; font-weight: bold;">Public</span> <span style="color: #6666cc; font-weight: bold;">bool</span> Moved<span style="color: #008000;">;</span>
   <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">int</span> Id<span style="color: #008000;">;</span>
<span style="color: #008000;">}</span><span style="color: #008000;">;</span>
&nbsp;
<span style="color: #008000;">...</span>
&nbsp;
<span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #0600FF; font-weight: bold;">static</span> NodeState GetNodeTagState<span style="color: #008000;">(</span>TreeNode node<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
   <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>node <span style="color: #008000;">==</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">)</span>
   <span style="color: #008000;">{</span>
      <span style="color: #0600FF; font-weight: bold;">throw</span> <span style="color: #008000;">new</span> Exception<span style="color: #008000;">(</span><span style="color: #666666;">"Cannot get tag state from null node"</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
   <span style="color: #008000;">}</span>
&nbsp;
   NodeState state<span style="color: #008000;">;</span>
   <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>node<span style="color: #008000;">.</span><span style="color: #0000FF;">Tag</span> <span style="color: #008000;">!=</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">)</span> state <span style="color: #008000;">=</span> <span style="color: #008000;">(</span>NodeState<span style="color: #008000;">)</span>node<span style="color: #008000;">.</span><span style="color: #0000FF;">Tag</span><span style="color: #008000;">;</span>
   <span style="color: #0600FF; font-weight: bold;">else</span>
   <span style="color: #008000;">{</span>
      state <span style="color: #008000;">=</span> <span style="color: #008000;">new</span> NodeState<span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
      state<span style="color: #008000;">.</span><span style="color: #0000FF;">Id</span> <span style="color: #008000;">=</span> node<span style="color: #008000;">.</span><span style="color: #0000FF;">GetHashCode</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
   <span style="color: #008000;">}</span>
   <span style="color: #0600FF; font-weight: bold;">return</span> state<span style="color: #008000;">;</span>
<span style="color: #008000;">}</span></pre></div></div><p>The states of TreeNodes are primarily manipulated during the ItemDrag and DragDrop event handlers, and similarly, TreeNode BackColor is driven from the TreeNode tag state in similar locations. One could add in further events to automatically change the TreeNode BackColor whenever the node’s state changes, although I have not done this in the example code.</p><h3>Auto-scrolling during drag</h3><p>Another interesting aspect I investigated was how to enable auto-scrolling when the cursor is near the top or bottom of the tree during a drag operation. This task is made slightly more challenging by the fact that the cursor may be over another control (not the source).</p><p>This problem was solved by identifying the control under the mouse during the OnGiveFeedback event, and using a timer to auto-scroll that control while the cursor remained near its border. To identify the control under the cursor we can use the GetChildAtPoint method, as shown below:</p><div class="wp_syntax"><div class="code"><pre class="csharp" style="font-family: monospace;">Point topLevelPoint <span style="color: #008000;">=</span> <span style="color: #0600FF; font-weight: bold;">this</span><span style="color: #008000;">.</span><span style="color: #0000FF;">TopLevelControl</span><span style="color: #008000;">.</span><span style="color: #0000FF;">PointToClient</span><span style="color: #008000;">(</span>Control<span style="color: #008000;">.</span><span style="color: #0000FF;">MousePosition</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
Control ctl <span style="color: #008000;">=</span> <span style="color: #0600FF; font-weight: bold;">this</span><span style="color: #008000;">.</span><span style="color: #0000FF;">TopLevelControl</span><span style="color: #008000;">.</span><span style="color: #0000FF;">GetChildAtPoint</span><span style="color: #008000;">(</span>topLevelPoint<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
<span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>ctl <span style="color: #008000;">!=</span> <span style="color: #0600FF; font-weight: bold;">null</span> <span style="color: #008000;">&amp;</span>amp<span style="color: #008000;">;&amp;</span>amp<span style="color: #008000;">;</span> ctl<span style="color: #008000;">.</span><span style="color: #0000FF;">GetType</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">.</span><span style="color: #0000FF;">FullName</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Equals</span><span style="color: #008000;">(</span><span style="color: #0600FF; font-weight: bold;">this</span><span style="color: #008000;">.</span><span style="color: #0000FF;">GetType</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">.</span><span style="color: #0000FF;">FullName</span><span style="color: #008000;">)</span> <span style="color: #008000;">&amp;</span>amp<span style="color: #008000;">;&amp;</span>amp<span style="color: #008000;">;</span> ctl<span style="color: #008000;">.</span><span style="color: #0000FF;">AllowDrop</span><span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
   _controlUnderMouse <span style="color: #008000;">=</span> ctl<span style="color: #008000;">;</span>
<span style="color: #008000;">}</span></pre></div></div><p>Once we have the control, checking if the cursor is near its edge can be done as follows (a _controlBorderTollerance of 30 pixels seemed to work well):</p><div class="wp_syntax"><div class="code"><pre class="csharp" style="font-family: monospace;">Point controlPoint <span style="color: #008000;">=</span> _controlUnderMouse<span style="color: #008000;">.</span><span style="color: #0000FF;">PointToClient</span><span style="color: #008000;">(</span>Control<span style="color: #008000;">.</span><span style="color: #0000FF;">MousePosition</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
PositionByBorder nearEdge <span style="color: #008000;">=</span> LocationNearControlEdge<span style="color: #008000;">(</span>_controlUnderMouse, controlPoint<span style="color: #008000;">.</span><span style="color: #0000FF;">Y</span>, _controlBorderTollerance<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
<span style="color: #008000;">...</span>
&nbsp;
<span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #0600FF; font-weight: bold;">static</span> PositionByBorder LocationNearControlEdge<span style="color: #008000;">(</span>Control control, <span style="color: #6666cc; font-weight: bold;">int</span> y, <span style="color: #6666cc; font-weight: bold;">int</span> tollerance<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
   <span style="color: #6666cc; font-weight: bold;">int</span> width <span style="color: #008000;">=</span> control<span style="color: #008000;">.</span><span style="color: #0000FF;">Width</span><span style="color: #008000;">;</span>
   <span style="color: #6666cc; font-weight: bold;">int</span> height <span style="color: #008000;">=</span> control<span style="color: #008000;">.</span><span style="color: #0000FF;">Height</span><span style="color: #008000;">;</span>
&nbsp;
   <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>Math<span style="color: #008000;">.</span><span style="color: #0000FF;">Abs</span><span style="color: #008000;">(</span><span style="color: #FF0000;">0</span> <span style="color: #008000;">-</span> y<span style="color: #008000;">)</span> <span style="color: #008000;">&amp;</span>lt<span style="color: #008000;">;</span> tollerance<span style="color: #008000;">)</span> <span style="color: #0600FF; font-weight: bold;">return</span> PositionByBorder<span style="color: #008000;">.</span><span style="color: #0000FF;">Top</span><span style="color: #008000;">;</span>
   <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>Math<span style="color: #008000;">.</span><span style="color: #0000FF;">Abs</span><span style="color: #008000;">(</span>height <span style="color: #008000;">-</span> y<span style="color: #008000;">)</span> <span style="color: #008000;">&amp;</span>lt<span style="color: #008000;">;</span> tollerance<span style="color: #008000;">)</span> <span style="color: #0600FF; font-weight: bold;">return</span> PositionByBorder<span style="color: #008000;">.</span><span style="color: #0000FF;">Bottom</span><span style="color: #008000;">;</span>
&nbsp;
   <span style="color: #0600FF; font-weight: bold;">return</span> PositionByBorder<span style="color: #008000;">.</span><span style="color: #0000FF;">None</span><span style="color: #008000;">;</span>
<span style="color: #008000;">}</span></pre></div></div><p>To actually send a scroll request the SendMessage interface from the Windows API is available. To use this we need to define the following member variables:</p><div class="wp_syntax"><div class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #0600FF; font-weight: bold;">const</span> <span style="color: #6666cc; font-weight: bold;">int</span> WM_VSCROLL <span style="color: #008000;">=</span> 0x115<span style="color: #008000;">;</span>
<span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #0600FF; font-weight: bold;">const</span> <span style="color: #6666cc; font-weight: bold;">int</span> SB_LINEDOWN <span style="color: #008000;">=</span> <span style="color: #FF0000;">1</span><span style="color: #008000;">;</span>
<span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #0600FF; font-weight: bold;">const</span> <span style="color: #6666cc; font-weight: bold;">int</span> SB_LINEUP  <span style="color: #008000;">=</span> <span style="color: #FF0000;">0</span><span style="color: #008000;">;</span>
&nbsp;
<span style="color: #008000;">[</span>DllImport<span style="color: #008000;">(</span><span style="color: #666666;">"user32.dll"</span>, CharSet <span style="color: #008000;">=</span> CharSet<span style="color: #008000;">.</span><span style="color: #0600FF; font-weight: bold;">Auto</span><span style="color: #008000;">)</span><span style="color: #008000;">]</span> 
<span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #0600FF; font-weight: bold;">static</span> <span style="color: #0600FF; font-weight: bold;">extern</span> <span style="color: #6666cc; font-weight: bold;">int</span> SendMessage<span style="color: #008000;">(</span>IntPtr hWnd, <span style="color: #6666cc; font-weight: bold;">int</span> wMsg, IntPtr wParam,IntPtr lParam<span style="color: #008000;">)</span><span style="color: #008000;">;</span></pre></div></div><p>And finally, within the timer scroll up event (the timer runs whenever the cursor is near the control’s border) we simply call:</p><div class="wp_syntax"><div class="code"><pre class="csharp" style="font-family: monospace;">SendMessage<span style="color: #008000;">(</span>_controlUnderMouse<span style="color: #008000;">.</span><span style="color: #0000FF;">Handle</span>, WM_VSCROLL, <span style="color: #008000;">(</span>IntPtr<span style="color: #008000;">)</span>SB_LINEUP, IntPtr<span style="color: #008000;">.</span><span style="color: #0000FF;">Zero</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span></pre></div></div><p>N.B. Use SB_LINEDOWN in the scroll down tick event.</p><p>To keep this post brief I’ll leave the discussion of the details there, but feel free to browse and re-use the full source code and test application <a href="http://www.scottlogic.co.uk/wp-content/uploads/2012/05/DDTreeView1.zip">here</a>.</p></div>