---
author: Mark Rhodes
tags: 
permalink: /2012/08/efficient-map-initialization-in-java/index.html
layout: blog
---
<div class="entry"><p><em>This post looks at how to construct Java’s built-in hash based <code>Map</code> implementations to ensure they have sufficient, but not excessive capacity.</em></p><p>Hash based maps are one of the most commonly used data structures in programming and Java provides two different implementations of these – the commonly used <a href="http://docs.oracle.com/javase/7/docs/api/java/util/HashMap.html"><code>HashMap</code></a> and the older synchronized <a href="http://docs.oracle.com/javase/7/docs/api/java/util/Hashtable.html"><code>Hashtable</code></a>.</p><p>A hash map is essentially a wrapper for an array containing linked lists of the items in it.  Each item is allocated an index in the array based on its hash code (the value returned by invoking the <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/Object.html#hashCode()"><code>hashCode()</code></a> method) and the length of the array.  This means that so long number of items stored in the map is small in comparison to the length of the backing array, and the hash codes allow the items to be evenly distributed throughout it, it can performs many operations (e.g. finding/adding/removing elements) in constant time.  However, as more and more items are added, it needs to ensure that an acceptable ratio between the number of items it’s storing and the length of the underlying array is maintained.  In order to do this, it periodically creates an entirely new, larger backing array and moves all the existing items over to it</p><p>The reallocation of elements to a new backing array is an expensive operation (at best linear time in the number of items in the map) so it’s best to avoid having to do it if at all possible.  To help do this, you can pass the initial size of the underlying array as a argument when constructing your hash map.  This is only really useful if you know (or at least can have a good guess at) the number of items your new map is going to store, which is often the case.  For example, one common use case of a hash map is to store the elements of an array against some id of the elements, e.g. I’ve seen something like the following code many times over:</p><div class="wp_syntax"><div class="code"><pre class="java5" style="font-family: monospace;"><span style="color: #003399; font-weight: bold;">Map</span><span style="color: #339933;">&lt;</span><span style="color: #003399; font-weight: bold;">String</span>, CustomObj<span style="color: #339933;">&gt;</span> objectById = <span style="color: #000000; font-weight: bold;">new</span> <span style="color: #003399; font-weight: bold;">HashMap</span><span style="color: #339933;">&lt;</span><span style="color: #003399; font-weight: bold;">String</span>, CustomObj<span style="color: #339933;">&gt;</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">for</span><span style="color: #009900;">(</span>CustomObj obj : listOfCustomObjs<span style="color: #009900;">)</span><span style="color: #009900;">{</span>
   objectById.<span style="color: #006633;">put</span><span style="color: #009900;">(</span>obj.<span style="color: #006633;">getId</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span>, obj<span style="color: #009900;">)</span> 
<span style="color: #009900;">}</span></pre></div></div><p>The use of the default constructor in the above code means that it’s possible that the map will have to unnecessarily reallocate the elements to ever larger backing arrays numerous times before it’s finished the loop.  However, the snag is that it’s not entirely obvious what you should set the initial size of the backing array to be in order to prevent the map needing to do this and so that you don’t use an excessive amount of memory.  After trawling through the source code of the two hash map implementations and creating some unit tests, it looks like the a good initial value is defined by:</p><div class="wp_syntax"><div class="code"><pre class="java5" style="font-family: monospace;"><span style="color: #009900;">(</span><span style="color: #006600; font-weight: bold;">int</span><span style="color: #009900;">)</span> <span style="color: #003399; font-weight: bold;">Math</span>.<span style="color: #006633;">ceil</span><span style="color: #009900;">(</span>requiredCapacity / loadFactor<span style="color: #009900;">)</span><span style="color: #339933;">;</span></pre></div></div><p>Here, <code>loadFactor</code> is the threshold ratio between the number of items in the map (<em>n</em>) and the size of the backing array (<em>s</em>), i.e. if <em>n</em>  <code>loadFactor</code> * <em>s</em>, a new larger backing array is created and the elements added to it.  The default load factor for both implementations is .75.  Therefore the above code could be more efficiently written like so:</p><div class="wp_syntax"><div class="code"><pre class="java5" style="font-family: monospace;"><span style="color: #006600; font-weight: bold;">int</span> initSize = <span style="color: #009900;">(</span><span style="color: #006600; font-weight: bold;">int</span><span style="color: #009900;">)</span> <span style="color: #003399; font-weight: bold;">Math</span>.<span style="color: #006633;">ceil</span><span style="color: #009900;">(</span>listOfCustomObjs.<span style="color: #006633;">size</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span> / <span style="color: #cc66cc;">0.75</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #003399; font-weight: bold;">Map</span><span style="color: #339933;">&lt;</span><span style="color: #003399; font-weight: bold;">String</span>, CustomObj<span style="color: #339933;">&gt;</span> objectById = <span style="color: #000000; font-weight: bold;">new</span> <span style="color: #003399; font-weight: bold;">HashMap</span><span style="color: #339933;">&lt;</span><span style="color: #003399; font-weight: bold;">String</span>, CustomObj<span style="color: #339933;">&gt;</span><span style="color: #009900;">(</span>initSize<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #666666; font-style: italic;">// as before...</span></pre></div></div><p>The same trick also works for instances of Java’s commonly used <a href="http://docs.oracle.com/javase/7/docs/api/java/util/HashSet.html"><code>HashSet</code></a> class, as a <code>HashSet</code> is these are effectively just a wrapper for <code>HashMap</code> instance.  For example the following code instantiates an <code>HashSet</code> which can hold at least 100 <code>Strings</code> without requiring a reallocating of elements to a new backing array:</p><div class="wp_syntax"><div class="code"><pre class="java5" style="font-family: monospace;"><span style="color: #006600; font-weight: bold;">int</span> initSize = <span style="color: #009900;">(</span><span style="color: #006600; font-weight: bold;">int</span><span style="color: #009900;">)</span> <span style="color: #003399; font-weight: bold;">Math</span>.<span style="color: #006633;">ceil</span><span style="color: #009900;">(</span><span style="color: #cc66cc;">100</span> / <span style="color: #cc66cc;">0.75</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span> 
<span style="color: #003399; font-weight: bold;">Set</span><span style="color: #339933;">&lt;</span><span style="color: #003399; font-weight: bold;">String</span><span style="color: #339933;">&gt;</span> someStrings = <span style="color: #000000; font-weight: bold;">new</span> <span style="color: #003399; font-weight: bold;">HashSet</span><span style="color: #339933;">&lt;</span><span style="color: #003399; font-weight: bold;">String</span><span style="color: #339933;">&gt;</span><span style="color: #009900;">(</span>initSize<span style="color: #009900;">)</span><span style="color: #339933;">;</span></pre></div></div><p><strong>Testing it Works</strong><br />
In order to verify that initializing hash maps in this way works as expected, I wrote some <a href="http://www.junit.org/">JUnit</a> tests, the source for which is available here: <a href="/wp-content/uploads/2012/08/initialisingHashMapUnitTestSource.zip">JUnit test source</a>.  Since we are interested in the state of the underlying backing arrays, which are private in both the <code>HashMap</code> and <code>Hashtable</code> classes, these tests need to use <a href="http://java.sun.com/developer/technicalArticles/ALT/Reflection/">reflection</a> to see what’s going on.  In order to reduce the amount of duplicate code, I made use of the <a href="http://en.wikipedia.org/wiki/Abstract_factory_pattern">abstract factory pattern</a>, so that the main bulk of the testing code doesn’t need to know the specifics of how the map instances it’s testing are constructed.</p><p>The interface for the factory which provides instances to verify is as follows:</p><div class="wp_syntax"><div class="code"><pre class="java5" style="font-family: monospace;"><span style="color: #000000; font-weight: bold;">interface</span> TestInstanceFactory <span style="color: #009900;">{</span>
    <span style="color: #666666; font-style: italic;">//Returns the instance of the Map being tested using the given initial</span>
    <span style="color: #666666; font-style: italic;">//capacity and load factor.</span>
     <span style="color: #003399; font-weight: bold;">Map</span><span style="color: #339933;">&lt;</span><span style="color: #003399; font-weight: bold;">Integer</span>, <span style="color: #003399; font-weight: bold;">Integer</span><span style="color: #339933;">&gt;&gt;</span> createTestInstance<span style="color: #009900;">(</span><span style="color: #006600; font-weight: bold;">int</span> requiredCapacity, <span style="color: #006600; font-weight: bold;">float</span> loadFactor<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #666666; font-style: italic;">//Returns an a new map instance which should be guaranteed to have a</span>
    <span style="color: #666666; font-style: italic;">//table which is smaller than or equal to instances returned from the</span>
    <span style="color: #666666; font-style: italic;">//getTestInstance method when called with the same parameters.</span>
    <span style="color: #666666; font-style: italic;">//Note: the returned instance need not actually have the given required capacity.</span>
     <span style="color: #003399; font-weight: bold;">Map</span><span style="color: #339933;">&lt;</span><span style="color: #003399; font-weight: bold;">Integer</span>, <span style="color: #003399; font-weight: bold;">Integer</span><span style="color: #339933;">&gt;&gt;</span> createSmallerMapInstance<span style="color: #009900;">(</span><span style="color: #006600; font-weight: bold;">int</span> requiredCapacity, <span style="color: #006600; font-weight: bold;">float</span> loadFactor<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></div></div><p>The idea is that test code gets two map instances of the implementation to be tested – one provided by each of these methods, passing in the same values.  It then adds the given number of elements to each and verifies that the backing array of the instance provided by the <code>createTestInstance</code> method didn’t resize and remains no larger than the one provided by <code>createSmallerMapInstance</code> method.  The implementation of the <code>TestInstanceFactory</code> for verifying the initialization of <code>HashMap</code>s is an anonymous inner class that looks like so:</p><div class="wp_syntax"><div class="code"><pre class="java5" style="font-family: monospace;"><span style="color: #000000; font-weight: bold;">new</span> TestInstanceFactory<span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
    @<span style="color: #003399; font-weight: bold;">Override</span>
    <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #003399; font-weight: bold;">HashMap</span><span style="color: #339933;">&lt;</span><span style="color: #003399; font-weight: bold;">Integer</span>, <span style="color: #003399; font-weight: bold;">Integer</span><span style="color: #339933;">&gt;</span> createTestInstance<span style="color: #009900;">(</span><span style="color: #006600; font-weight: bold;">int</span> requiredCapacity, <span style="color: #006600; font-weight: bold;">float</span> loadFactor<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
        <span style="color: #006600; font-weight: bold;">int</span> initialCapacity = <span style="color: #009900;">(</span><span style="color: #006600; font-weight: bold;">int</span><span style="color: #009900;">)</span> <span style="color: #003399; font-weight: bold;">Math</span>.<span style="color: #006633;">ceil</span><span style="color: #009900;">(</span>requiredCapacity / loadFactor<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
        <span style="color: #000000; font-weight: bold;">return</span> <span style="color: #000000; font-weight: bold;">new</span> <span style="color: #003399; font-weight: bold;">HashMap</span><span style="color: #339933;">&lt;</span><span style="color: #003399; font-weight: bold;">Integer</span>, <span style="color: #003399; font-weight: bold;">Integer</span><span style="color: #339933;">&gt;</span><span style="color: #009900;">(</span>initialCapacity, loadFactor<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">}</span>
&nbsp;
    <span style="color: #666666; font-style: italic;">//Returns a map which always has the smallest possible initial capacity (1).</span>
    @<span style="color: #003399; font-weight: bold;">Override</span>
    <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #003399; font-weight: bold;">HashMap</span><span style="color: #339933;">&lt;</span><span style="color: #003399; font-weight: bold;">Integer</span>, <span style="color: #003399; font-weight: bold;">Integer</span><span style="color: #339933;">&gt;</span> createSmallerMapInstance<span style="color: #009900;">(</span>
            <span style="color: #006600; font-weight: bold;">int</span> initialCapacity, <span style="color: #006600; font-weight: bold;">float</span> loadFactor<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
        <span style="color: #000000; font-weight: bold;">return</span> <span style="color: #000000; font-weight: bold;">new</span> <span style="color: #003399; font-weight: bold;">HashMap</span><span style="color: #339933;">&lt;</span><span style="color: #003399; font-weight: bold;">Integer</span>, <span style="color: #003399; font-weight: bold;">Integer</span><span style="color: #339933;">&gt;</span><span style="color: #009900;">(</span><span style="color: #cc66cc;">0</span>, loadFactor<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">}</span>
<span style="color: #009900;">}</span></pre></div></div><p>The actual test method, which takes a <code>TestInstanceFactory</code> as a parameter and verifies the behaviour is as as follows:</p><div class="wp_syntax"><div class="code"><pre class="java5" style="font-family: monospace;"><span style="color: #666666; font-style: italic;">//Verifies that instances provided by the given factory do not increase their internal tables</span>
<span style="color: #666666; font-style: italic;">//and that their capacities are not overly large, for a range of load factors and sizes..</span>
@<span style="color: #003399; font-weight: bold;">SuppressWarnings</span><span style="color: #009900;">(</span><span style="color: #0000ff;">"unchecked"</span><span style="color: #009900;">)</span>
<span style="color: #000000; font-weight: bold;">private</span> <span style="color: #339933;">&lt;</span>T<span style="color: #339933;">&gt;</span> <span style="color: #006600; font-weight: bold;">void</span> testMapInit<span style="color: #009900;">(</span>TestInstanceFactory instanceFactory<span style="color: #009900;">)</span> <span style="color: #000000; font-weight: bold;">throws</span>
	    <span style="color: #003399; font-weight: bold;">IllegalArgumentException</span>, <span style="color: #003399; font-weight: bold;">IllegalAccessException</span>,
	    <span style="color: #003399; font-weight: bold;">SecurityException</span>, <span style="color: #003399; font-weight: bold;">NoSuchFieldException</span> <span style="color: #009900;">{</span>
&nbsp;
    <span style="color: #666666; font-style: italic;">// Whether or not at least one instance provided by the createSmallerMapInstance method</span>
    <span style="color: #666666; font-style: italic;">//had to resize it's backing array..</span>
    <span style="color: #006600; font-weight: bold;">boolean</span> smallerCapMapResized = <span style="color: #006600; font-weight: bold;">false</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #006600; font-weight: bold;">float</span> <span style="color: #009900;">[</span><span style="color: #009900;">]</span> loadFactors = <span style="color: #009900;">{</span> 0.25f, 0.5f, 0.75f <span style="color: #666666; font-style: italic;">/* default */</span>, <span style="color: #cc66cc;">1</span>, <span style="color: #cc66cc;">5</span> <span style="color: #009900;">}</span><span style="color: #339933;">;</span>
    <span style="color: #000000; font-weight: bold;">for</span><span style="color: #009900;">(</span><span style="color: #006600; font-weight: bold;">int</span> f = <span style="color: #cc66cc;">0</span><span style="color: #339933;">;</span> f <span style="color: #339933;">&lt;</span> loadFactors.<span style="color: #006633;">length</span><span style="color: #339933;">;</span> f++<span style="color: #009900;">)</span><span style="color: #009900;">{</span>
        <span style="color: #006600; font-weight: bold;">float</span> loadFactor = loadFactors<span style="color: #009900;">[</span>f<span style="color: #009900;">]</span><span style="color: #339933;">;</span>
    	<span style="color: #000000; font-weight: bold;">for</span><span style="color: #009900;">(</span><span style="color: #006600; font-weight: bold;">int</span> i = <span style="color: #cc66cc;">0</span><span style="color: #339933;">;</span> i <span style="color: #339933;">&lt;</span> <span style="color: #cc66cc;">1026</span><span style="color: #339933;">;</span> i++<span style="color: #009900;">)</span><span style="color: #009900;">{</span>
            <span style="color: #003399; font-weight: bold;">Map</span><span style="color: #339933;">&lt;</span><span style="color: #003399; font-weight: bold;">Integer</span>, <span style="color: #003399; font-weight: bold;">Integer</span><span style="color: #339933;">&gt;</span> map = instanceFactory.<span style="color: #006633;">createTestInstance</span><span style="color: #009900;">(</span>i,  loadFactor<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
            <span style="color: #003399; font-weight: bold;">Map</span><span style="color: #339933;">&lt;</span><span style="color: #003399; font-weight: bold;">Integer</span>, <span style="color: #003399; font-weight: bold;">Integer</span><span style="color: #339933;">&gt;</span> smallerCapMap =
                    instanceFactory.<span style="color: #006633;">createSmallerMapInstance</span><span style="color: #009900;">(</span>i, loadFactor<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
            <span style="color: #666666; font-style: italic;">//make it so that we can see the private fields..</span>
            <span style="color: #003399; font-weight: bold;">Field</span> tableField = map.<span style="color: #006633;">getClass</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span>.<span style="color: #006633;">getDeclaredField</span><span style="color: #009900;">(</span><span style="color: #0000ff;">"table"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
            tableField.<span style="color: #006633;">setAccessible</span><span style="color: #009900;">(</span><span style="color: #006600; font-weight: bold;">true</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
            <span style="color: #003399; font-weight: bold;">Field</span> thresholdField = map.<span style="color: #006633;">getClass</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span>.<span style="color: #006633;">getDeclaredField</span><span style="color: #009900;">(</span><span style="color: #0000ff;">"threshold"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
            thresholdField.<span style="color: #006633;">setAccessible</span><span style="color: #009900;">(</span><span style="color: #006600; font-weight: bold;">true</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
            <span style="color: #003399; font-weight: bold;">Map.<span style="color: #006633;">Entry</span></span><span style="color: #339933;">&lt;</span><span style="color: #003399; font-weight: bold;">Integer</span>, <span style="color: #003399; font-weight: bold;">Integer</span><span style="color: #339933;">&gt;</span><span style="color: #009900;">[</span><span style="color: #009900;">]</span> table =
                    <span style="color: #009900;">(</span><span style="color: #003399; font-weight: bold;">Map.<span style="color: #006633;">Entry</span></span><span style="color: #339933;">&lt;</span><span style="color: #003399; font-weight: bold;">Integer</span>, <span style="color: #003399; font-weight: bold;">Integer</span><span style="color: #339933;">&gt;</span><span style="color: #009900;">[</span><span style="color: #009900;">]</span><span style="color: #009900;">)</span> tableField.<span style="color: #006633;">get</span><span style="color: #009900;">(</span>map<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
            <span style="color: #003399; font-weight: bold;">Map.<span style="color: #006633;">Entry</span></span><span style="color: #339933;">&lt;</span><span style="color: #003399; font-weight: bold;">Integer</span>, <span style="color: #003399; font-weight: bold;">Integer</span><span style="color: #339933;">&gt;</span><span style="color: #009900;">[</span><span style="color: #009900;">]</span> smallCapTable =
                    <span style="color: #009900;">(</span><span style="color: #003399; font-weight: bold;">Map.<span style="color: #006633;">Entry</span></span><span style="color: #339933;">&lt;</span><span style="color: #003399; font-weight: bold;">Integer</span>, <span style="color: #003399; font-weight: bold;">Integer</span><span style="color: #339933;">&gt;</span><span style="color: #009900;">[</span><span style="color: #009900;">]</span><span style="color: #009900;">)</span> tableField.<span style="color: #006633;">get</span><span style="color: #009900;">(</span>smallerCapMap<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
            <span style="color: #666666; font-style: italic;">//check "small one" really is no larger..</span>
            assertTrue<span style="color: #009900;">(</span>table.<span style="color: #006633;">length</span> <span style="color: #339933;">&gt;</span>= smallCapTable.<span style="color: #006633;">length</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
            <span style="color: #666666; font-style: italic;">//add entries to the maps..</span>
            <span style="color: #006600; font-weight: bold;">int</span> startSize = table.<span style="color: #006633;">length</span><span style="color: #339933;">;</span>
            <span style="color: #000000; font-weight: bold;">for</span><span style="color: #009900;">(</span><span style="color: #006600; font-weight: bold;">int</span> j = <span style="color: #cc66cc;">0</span><span style="color: #339933;">;</span> j <span style="color: #339933;">&lt;</span> i<span style="color: #339933;">;</span> j++<span style="color: #009900;">)</span><span style="color: #009900;">{</span>
                map.<span style="color: #006633;">put</span><span style="color: #009900;">(</span>j, j<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
                smallerCapMap.<span style="color: #006633;">put</span><span style="color: #009900;">(</span>j, j<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
            <span style="color: #009900;">}</span>
&nbsp;
            <span style="color: #666666; font-style: italic;">//check to see if the smallCapTable is different..</span>
            <span style="color: #000000; font-weight: bold;">if</span><span style="color: #009900;">(</span>smallCapTable <span style="color: #339933;">!</span>= tableField.<span style="color: #006633;">get</span><span style="color: #009900;">(</span>smallerCapMap<span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">{</span>
            	smallerCapMapResized = <span style="color: #006600; font-weight: bold;">true</span><span style="color: #339933;">;</span>
            <span style="color: #009900;">}</span>
&nbsp;
            <span style="color: #666666; font-style: italic;">//check that the map has not had to resize it's table.. </span>
            table = <span style="color: #009900;">(</span><span style="color: #003399; font-weight: bold;">Map.<span style="color: #006633;">Entry</span></span><span style="color: #339933;">&lt;</span><span style="color: #003399; font-weight: bold;">Integer</span>, <span style="color: #003399; font-weight: bold;">Integer</span><span style="color: #339933;">&gt;</span><span style="color: #009900;">[</span><span style="color: #009900;">]</span><span style="color: #009900;">)</span> tableField.<span style="color: #006633;">get</span><span style="color: #009900;">(</span>map<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
            assertEquals<span style="color: #009900;">(</span>startSize, table.<span style="color: #006633;">length</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
            <span style="color: #666666; font-style: italic;">//check that the map is not too large..</span>
            <span style="color: #003399; font-weight: bold;">Map.<span style="color: #006633;">Entry</span></span><span style="color: #339933;">&lt;</span><span style="color: #003399; font-weight: bold;">Integer</span>, <span style="color: #003399; font-weight: bold;">Integer</span><span style="color: #339933;">&gt;</span><span style="color: #009900;">[</span><span style="color: #009900;">]</span> smallerMapTable =
            		<span style="color: #009900;">(</span><span style="color: #003399; font-weight: bold;">Map.<span style="color: #006633;">Entry</span></span><span style="color: #339933;">&lt;</span><span style="color: #003399; font-weight: bold;">Integer</span>, <span style="color: #003399; font-weight: bold;">Integer</span><span style="color: #339933;">&gt;</span><span style="color: #009900;">[</span><span style="color: #009900;">]</span><span style="color: #009900;">)</span> tableField.<span style="color: #006633;">get</span><span style="color: #009900;">(</span>smallerCapMap<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
            <span style="color: #006600; font-weight: bold;">int</span> smallestCapMapThreshold = <span style="color: #009900;">(</span><span style="color: #006600; font-weight: bold;">int</span><span style="color: #009900;">)</span> thresholdField.<span style="color: #006633;">get</span><span style="color: #009900;">(</span>smallerCapMap<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
            <span style="color: #000000; font-weight: bold;">if</span><span style="color: #009900;">(</span>smallestCapMapThreshold <span style="color: #339933;">&gt;</span>= smallerCapMap.<span style="color: #006633;">size</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">{</span>
                assertTrue<span style="color: #009900;">(</span>smallerMapTable.<span style="color: #006633;">length</span> <span style="color: #339933;">&gt;</span>= table.<span style="color: #006633;">length</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
            <span style="color: #009900;">}</span>
        <span style="color: #009900;">}</span>
    <span style="color: #009900;">}</span>
    <span style="color: #666666; font-style: italic;">//if no smaller cap map resized then we could be allocating too much memory sometimes..</span>
    assertTrue<span style="color: #009900;">(</span>smallerCapMapResized<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></div></div><p>The test is by no means perfect as it requires a sensible implementation of the <code>TestInstanceFactory</code> and it’s never going to be that generic due to the use of reflection, but it gives a fair level of confidence that things are working as expected.  It’s worth noting that if you were to alter the implementation of the <code>createTestInstance</code> method of the factory for <code>HashMap</code>s to be:</p><div class="wp_syntax"><div class="code"><pre class="java5" style="font-family: monospace;"><span style="color: #000000; font-weight: bold;">public</span> <span style="color: #003399; font-weight: bold;">HashMap</span><span style="color: #339933;">&lt;</span><span style="color: #003399; font-weight: bold;">Integer</span>, <span style="color: #003399; font-weight: bold;">Integer</span><span style="color: #339933;">&gt;</span> createTestInstance<span style="color: #009900;">(</span><span style="color: #006600; font-weight: bold;">int</span> requiredCapacity, <span style="color: #006600; font-weight: bold;">float</span> loadFactor<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
    <span style="color: #006600; font-weight: bold;">int</span> initialCapacity = <span style="color: #009900;">(</span><span style="color: #006600; font-weight: bold;">int</span><span style="color: #009900;">)</span> <span style="color: #009900;">(</span>requiredCapacity / loadFactor<span style="color: #009900;">)</span> + <span style="color: #cc66cc;">1</span>
    <span style="color: #000000; font-weight: bold;">return</span> <span style="color: #000000; font-weight: bold;">new</span> <span style="color: #003399; font-weight: bold;">HashMap</span><span style="color: #339933;">&lt;</span><span style="color: #003399; font-weight: bold;">Integer</span>, <span style="color: #003399; font-weight: bold;">Integer</span><span style="color: #339933;">&gt;</span><span style="color: #009900;">(</span>initialCapacity, loadFactor<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></div></div><p>which is effectively what is used within the <code>HashCode</code> source, the test code fails in the case that <code>requiredCapacity / loadFactor</code> is an exact power of two, as it allocates twice the required memory for the backing array.</p></div>