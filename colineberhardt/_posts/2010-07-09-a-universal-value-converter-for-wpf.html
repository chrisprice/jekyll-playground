---
author: Colin Eberhardt
tags: valueconverter, WPF
permalink: /blog/colin/2010/07/a-universal-value-converter-for-wpf/index.html
layout: colineberhardt-blog
---
<div class="entry"><div class="topsy_widget_data topsy_theme_light-green" style="float: right; margin-left: 0.75em; background: url(data:,%7B%20%22url%22%3A%20%22http%253A%252F%252Fwww.scottlogic.co.uk%252Fblog%252Fcolin%252F2010%252F07%252Fa-universal-value-converter-for-wpf%252F%22%2C%20%22style%22%3A%20%22big%22%2C%20%22title%22%3A%20%22A%20Universal%20Value%20Converter%20for%20WPF%20%23%22%20%7D);"></div><p><em>This post provides a simple IValueConverter implementation that makes use of the framework type converters in order to convert between a large range of source / target types. This converter can be used both within bindings and in code-behind to give more concise property setters.</em></p><h2>Introduction</h2><p>One of the great features of the XAML language is that it is flexible, concise and expressive (yes, I know that XML can be a little verbose, but if you try to create a complex UI purely in code-behind I think you will agree with my observations!). For example, you can set the fill of a rectangle by simply specifying the named color:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="xml" style="font-family: monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Rectangle</span> <span style="color: #000066;">Fill</span>=<span style="color: #ff0000;">"Green"</span>/<span style="color: #66cc66;">)</span></span></pre></td></tr></table></div><p>or … you can specify the RGB values directly:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="xml" style="font-family: monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Rectangle</span> <span style="color: #000066;">Fill</span>=<span style="color: #ff0000;">"#00FF00"</span>/<span style="color: #66cc66;">)</span></span></pre></td></tr></table></div><p>Looking at the above examples, you might be fooled into thinking that the Fill property is of type Color. People who are new to WPF often find that this is not the case the first time they try to bind a property of type Color to the Fill property (they would never set the Fill property directly in code behind, because that would be a cardinal sin!). The Fill property is actually of type Brush, and the XAML parser is performing some cunning type conversions in order to make the above markup work.</p><p>The solution to this problem of binding a Color to the Fill property is to create a value converter:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">class</span> ColorToBrushConverter <span style="color: #008000;">:</span> IValueConverter
<span style="color: #008000;">{</span>
  <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">object</span> Convert<span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">object</span> <span style="color: #0600FF; font-weight: bold;">value</span>, Type targetType, <span style="color: #6666cc; font-weight: bold;">object</span> parameter, CultureInfo culture<span style="color: #008000;">)</span>
  <span style="color: #008000;">{</span>
    <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span><span style="color: #0600FF; font-weight: bold;">value</span> <span style="color: #008000;">is</span> Color<span style="color: #008000;">)</span>
    <span style="color: #008000;">{</span>
      <span style="color: #0600FF; font-weight: bold;">return</span> <span style="color: #008000;">new</span> SolidColorBrush<span style="color: #008000;">(</span><span style="color: #008000;">(</span>Color<span style="color: #008000;">)</span><span style="color: #0600FF; font-weight: bold;">value</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">}</span>
    <span style="color: #0600FF; font-weight: bold;">return</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">;</span>
  <span style="color: #008000;">}</span>
&nbsp;
  <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">object</span> ConvertBack<span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">object</span> <span style="color: #0600FF; font-weight: bold;">value</span>, Type targetType, <span style="color: #6666cc; font-weight: bold;">object</span> parameter, CultureInfo culture<span style="color: #008000;">)</span>
  <span style="color: #008000;">{</span>
    <span style="color: #0600FF; font-weight: bold;">throw</span> <span style="color: #008000;">new</span> Exception<span style="color: #008000;">(</span><span style="color: #666666;">"The method or operation is not implemented."</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
  <span style="color: #008000;">}</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>Which can be used as follows:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="xml" style="font-family: monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Rectangle</span> <span style="color: #000066;">Fill</span>=<span style="color: #ff0000;">"{Binding Path=MyColorProperty,</span>
<span style="color: #009900;">                                  Converter={StaticResource ColorToBrushConverter}} "</span>/<span style="color: #66cc66;">)</span></span></pre></td></tr></table></div><p>If you search google for <a href="http://www.google.co.uk/search?q=colortobrushconverter">ColorToBrushConverter</a>, you can see that there are a great many people who have implemented this simple little converter. But what happens if you want to bind to a string representation of color? or you want to bind to a stroke dash property or path geometry? Whilst value converters are simple to implement, it is a shame that you have to create so many of them!</p><h2>A Universal Value Converter</h2><p><img src="http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2010/07/816000_pocket_knife.jpg" alt="" title="816000_pocket_knife" width="300" height="199" class="aligncenter size-full wp-image-728" /></p><p>Wouldn’t it be great to have a single value converter that has the same flexibility as the XAML parser? It is actually very simple to create such as converter (and after creating probably my 5th ColorToBrushConverter I have no idea why it took so long before I realised this!). The .NET framework has had an API for conversion between different types via <a href="http://msdn.microsoft.com/en-us/library/system.componentmodel.typeconverter.aspx">TypeConverters</a> for a long time. They used extensively in .NET technologies for databinding and designer support, and much more.</p><p>A value converter can obtain a suitable TypeConverter for the target property then perform the required conversion:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">class</span> UniversalValueConverter <span style="color: #008000;">:</span> IValueConverter
<span style="color: #008000;">{</span>
    <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">object</span> Convert<span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">object</span> <span style="color: #0600FF; font-weight: bold;">value</span>, Type targetType, <span style="color: #6666cc; font-weight: bold;">object</span> parameter, CultureInfo culture<span style="color: #008000;">)</span>
    <span style="color: #008000;">{</span>
        <span style="color: #008080; font-style: italic;">// obtain the conveter for the target type</span>
        TypeConverter converter <span style="color: #008000;">=</span> TypeDescriptor<span style="color: #008000;">.</span><span style="color: #0000FF;">GetConverter</span><span style="color: #008000;">(</span>targetType<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
        <span style="color: #0600FF; font-weight: bold;">try</span>
        <span style="color: #008000;">{</span>
            <span style="color: #008080; font-style: italic;">// determine if the supplied value is of a suitable type</span>
            <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>converter<span style="color: #008000;">.</span><span style="color: #0000FF;">CanConvertFrom</span><span style="color: #008000;">(</span><span style="color: #0600FF; font-weight: bold;">value</span><span style="color: #008000;">.</span><span style="color: #0000FF;">GetType</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">)</span><span style="color: #008000;">)</span>
            <span style="color: #008000;">{</span>
                <span style="color: #008080; font-style: italic;">// return the converted value</span>
                <span style="color: #0600FF; font-weight: bold;">return</span> converter<span style="color: #008000;">.</span><span style="color: #0000FF;">ConvertFrom</span><span style="color: #008000;">(</span><span style="color: #0600FF; font-weight: bold;">value</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
            <span style="color: #008000;">}</span>
            <span style="color: #0600FF; font-weight: bold;">else</span>
            <span style="color: #008000;">{</span>
                <span style="color: #008080; font-style: italic;">// try to convert from the string representation</span>
                <span style="color: #0600FF; font-weight: bold;">return</span> converter<span style="color: #008000;">.</span><span style="color: #0000FF;">ConvertFrom</span><span style="color: #008000;">(</span><span style="color: #0600FF; font-weight: bold;">value</span><span style="color: #008000;">.</span><span style="color: #0000FF;">ToString</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
            <span style="color: #008000;">}</span>
        <span style="color: #008000;">}</span>
        <span style="color: #0600FF; font-weight: bold;">catch</span> <span style="color: #008000;">(</span>Exception<span style="color: #008000;">)</span>
        <span style="color: #008000;">{</span>
            <span style="color: #0600FF; font-weight: bold;">return</span> <span style="color: #0600FF; font-weight: bold;">value</span><span style="color: #008000;">;</span>
        <span style="color: #008000;">}</span>
&nbsp;
    <span style="color: #008000;">}</span>
&nbsp;
    <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">object</span> ConvertBack<span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">object</span> <span style="color: #0600FF; font-weight: bold;">value</span>, Type targetType, <span style="color: #6666cc; font-weight: bold;">object</span> parameter, CultureInfo culture<span style="color: #008000;">)</span>
    <span style="color: #008000;">{</span>
        <span style="color: #0600FF; font-weight: bold;">throw</span> <span style="color: #008000;">new</span> NotImplementedException<span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">}</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>Note, that this value converter first tries to convert directly from the source to the target type, if this is not possible it then tried to convert via a string representation (I am not sure whether it is more correct to obtain a TypeConverter for the String type, then use this rather that invoking ToString on the value being converted, but the above works for me <img src="http://www.scottlogic.co.uk/blog/colin/wp-includes/images/smilies/icon_smile.gif" alt=":-)" class="wp-smiley" />  ).</p><p>You can see this converter in action below where a range of type conversions are demonstrated:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="xml" style="font-family: monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;TextBlock</span> <span style="color: #000066;">Text</span>=<span style="color: #ff0000;">"Converting String to Brush ...."</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Rectangle</span> <span style="color: #000066;">Fill</span>=<span style="color: #ff0000;">"{Binding ElementName=colorTextBox, Path=Text, Converter={StaticResource UniversalValueConverter}}"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;TextBox</span> <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"colorTextBox"</span></span>
<span style="color: #009900;">             <span style="color: #000066;">Text</span>=<span style="color: #ff0000;">"Red"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
&nbsp;
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;TextBlock</span> <span style="color: #000066;">Text</span>=<span style="color: #ff0000;">"Converting String to Geometry ...."</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Path</span> <span style="color: #000066;">Data</span>=<span style="color: #ff0000;">"{Binding ElementName=geometryText, Path=Text, Converter={StaticResource UniversalValueConverter}}"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;TextBox</span> <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"geometryText"</span>                  </span>
<span style="color: #009900;">             <span style="color: #000066;">Text</span>=<span style="color: #ff0000;">"M 10,20 C 10,2.5 40,35 40,17 H 28"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
&nbsp;
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;TextBlock</span> <span style="color: #000066;">Text</span>=<span style="color: #ff0000;">"Converting String to DoubleCollection (stroke dash) ...."</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Line</span> <span style="color: #000066;">StrokeDashArray</span>=<span style="color: #ff0000;">"{Binding ElementName=dashText, Path=Text, Converter={StaticResource UniversalValueConverter}}"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;TextBox</span> <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"dashText"</span>                  </span>
<span style="color: #009900;">            <span style="color: #000066;">Text</span>=<span style="color: #ff0000;">"2 2 4 5"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span></pre></td></tr></table></div><p><img src="http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2010/07/universal.png" alt="" title="universal" width="395" height="345" class="aligncenter size-full wp-image-735" /></p><p>For the first conversion, string to brush, you can use named colors, and the hex notation in its range of abbreviated forms (#AF7, #AAFF77, #FFAAFF77 …). You can also use this converter to convert from string to their corresponding enum values, for example binding the string “Collapsed” to the Visbility property.</p><h2>Value conversion in code behind</h2><p>The above converter really is swiss army knife for bindings, but what about code-behind? You are still constrained by the type requirements of the property being set:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;">rect1<span style="color: #008000;">.</span><span style="color: #0000FF;">Fill</span> <span style="color: #008000;">=</span> <span style="color: #008000;">new</span> SolidColorBrush<span style="color: #008000;">(</span><span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
    Color <span style="color: #008000;">=</span> Colors<span style="color: #008000;">.</span><span style="color: #0000FF;">Red</span>
<span style="color: #008000;">}</span><span style="color: #008000;">;</span></pre></td></tr></table></div><p>Value converters, whilst typically used in binding, can also be used directly in code-behind. The following extension method extends <code>SetValue</code> method for setting dependency properties to make use of the above value converter:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #008080; font-style: italic;">/// &lt;summary&gt;</span>
<span style="color: #008080; font-style: italic;">/// Sets the given dependency property, applying type conversion where required</span>
<span style="color: #008080; font-style: italic;">/// &lt;/summary&gt;</span>
<span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #0600FF; font-weight: bold;">static</span> <span style="color: #6666cc; font-weight: bold;">void</span> SetValueEx<span style="color: #008000;">(</span><span style="color: #0600FF; font-weight: bold;">this</span> DependencyObject element, DependencyProperty property, <span style="color: #6666cc; font-weight: bold;">object</span> <span style="color: #0600FF; font-weight: bold;">value</span><span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
    <span style="color: #0600FF; font-weight: bold;">var</span> conv <span style="color: #008000;">=</span> <span style="color: #008000;">new</span> UniversalValueConverter<span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    <span style="color: #0600FF; font-weight: bold;">var</span> convertedValue <span style="color: #008000;">=</span> conv<span style="color: #008000;">.</span><span style="color: #0000FF;">Convert</span><span style="color: #008000;">(</span><span style="color: #0600FF; font-weight: bold;">value</span>, property<span style="color: #008000;">.</span><span style="color: #0000FF;">PropertyType</span>, <span style="color: #0600FF; font-weight: bold;">null</span>, CultureInfo<span style="color: #008000;">.</span><span style="color: #0000FF;">InvariantCulture</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    element<span style="color: #008000;">.</span><span style="color: #0000FF;">SetValue</span><span style="color: #008000;">(</span>property, convertedValue<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>Which provides a more flexible mechanism for setting property values:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;">rect1<span style="color: #008000;">.</span><span style="color: #0000FF;">SetValueEx</span><span style="color: #008000;">(</span>Rectangle<span style="color: #008000;">.</span><span style="color: #0000FF;">FillProperty</span>, Colors<span style="color: #008000;">.</span><span style="color: #0000FF;">Red</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
rect2<span style="color: #008000;">.</span><span style="color: #0000FF;">SetValueEx</span><span style="color: #008000;">(</span>Rectangle<span style="color: #008000;">.</span><span style="color: #0000FF;">FillProperty</span>, <span style="color: #666666;">"Blue"</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
rect3<span style="color: #008000;">.</span><span style="color: #0000FF;">SetValueEx</span><span style="color: #008000;">(</span>Rectangle<span style="color: #008000;">.</span><span style="color: #0000FF;">FillProperty</span>, <span style="color: #666666;">"#FFEE55"</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
rect4<span style="color: #008000;">.</span><span style="color: #0000FF;">SetValueEx</span><span style="color: #008000;">(</span>Rectangle<span style="color: #008000;">.</span><span style="color: #0000FF;">FillProperty</span>, <span style="color: #008000;">new</span> SolidColorBrush<span style="color: #008000;">(</span>Colors<span style="color: #008000;">.</span><span style="color: #0000FF;">Orange</span><span style="color: #008000;">)</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span></pre></td></tr></table></div><h2>… and Silverlight?</h2><p>Unfortunately Silverlight lacks the TypeDescriptor class which is used to obtain TypeConveters. I am guessing that type conversion within Silverlight is ‘baked-in’ to the XAML parser, which means that it is not possible to re-use this logic <img src="http://www.scottlogic.co.uk/blog/colin/wp-includes/images/smilies/icon_sad.gif" alt=":-(" class="wp-smiley" /> </p><p>You can download the full source for this blog post: <a href="{{ site.url }}/blog/colin/wp-content/uploads/2010/07/UniversalValueConverter.zip">UniversalValueConverter.zip</a></p><p>Regards,<br />
Colin E.</p></div>