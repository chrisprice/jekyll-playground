---
author: Colin Eberhardt
tags: codeproject, Windows Phone 7
permalink: /blog/colin/2011/01/windows-phone-7-deferredloadcontentcontrol/index.html
layout: colineberhardt-blog
---
<div class="entry"><div class="topsy_widget_data topsy_theme_light-green" style="float: right; margin-left: 0.75em; background: url(data:,%7B%20%22url%22%3A%20%22http%253A%252F%252Fwww.scottlogic.co.uk%252Fblog%252Fcolin%252F2011%252F01%252Fwindows-phone-7-deferredloadcontentcontrol%252F%22%2C%20%22style%22%3A%20%22big%22%2C%20%22title%22%3A%20%22Windows%20Phone%207%20DeferredLoadContentControl%20%23%22%20%7D);"></div><p><em>This blog post describes a simple content control that can be used to defer the rendering of its contents in order to provide a better user experience on Windows Phone 7.</em></p><p>I think anyone who has made the transition from Emulator to Hardware with developing for Windows Phone 7 has experienced the same performance headaches. a couple of areas where performance hits hard is the rendering of ListBoxes and Images downloaded from the web. Thankfully there are a number of blog posts describing a variety of ways to mitigate the problem. The <a href="http://blogs.msdn.com/b/slmperf/archive/2010/10/06/silverlight-for-windows-phone-7-listbox-scroll-performance.aspx">ListBox performance tips</a> page on the Silverlight WP7 team blog provides links to many useful resources on this topic.</p><p>The bottom line is that real WP7 devices take quite a bit longer to render the visual tree, and as developers we have to work around that.</p><p>One area I think the user experience really suffers is when the user navigates to a new page. If the page contains a reasonably complex UI (perhaps a list of 100 items), it can take quite a long time for the new page to appear. This gives the impression that the phone has locked up and become unresponsive (which I guess it has to a certain extent!). The guys at Telerik noted that using the <a href="http://blogs.telerik.com/blogs/posts/10-11-01/windows_phone_7_performance_-_emulator_vs_physical_device.aspx">Panorama control caused a load time of ~1.6 seconds</a>. Whilst the splash screen will be displayed when you application initially loads, giving the user a feeling that the phone is doing something, subsequent page navigations lack any visual cue to indicate that the phone is doing something and hasn’t just died!</p><h2>DeferredLoadContentControl</h2><p>The <code>DeferredLoadContentControl</code> provides a simple solution to this problem, the content that is placed within this control is initially hidden by setting its <code>Visibility</code> to <code>Collapsed</code>. Elements that are collapsed do not occupy any layout space, and hence if an element with a long ‘render’ time is collapsed, this time is no longer consumed. When the <code>DeferredLoadContentControl</code> is initially loaded, it displays a ‘loading…’ indicator, then sets the visibility of its contents to Visible. When the content is rendered, the loading indicator is hidden.</p><p>The images below compare the user experience with and without the <code>DeferredLoadContentControl</code>:</p><p><img src="http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2011/01/LoadTime.png" alt="" title="LoadTime" width="700" height="292" class="aligncenter size-full wp-image-1162" /></p><p><img src="http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2011/01/DeferredLoad.png" alt="" title="DeferredLoad" width="700" height="292" class="aligncenter size-full wp-image-1161" /></p><p>Whilst this control does not make the page load any quicker, and the phone cannot be interacted with whilst the content is loading, it does mean that the page itself loads much more quickly and hence gives the user the impression that the phone is more responsive.</p><p>The code for the <code>DeferredLoadContentControl</code> is a very simple extension of <code>ContentControl</code>. The template for this control is shown below:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="xml" style="font-family: monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Style</span> <span style="color: #000066;">TargetType</span>=<span style="color: #ff0000;">"local:DeferredLoadContentControl"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Setter</span> <span style="color: #000066;">Property</span>=<span style="color: #ff0000;">"HorizontalContentAlignment"</span> <span style="color: #000066;">Value</span>=<span style="color: #ff0000;">"Stretch"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Setter</span> <span style="color: #000066;">Property</span>=<span style="color: #ff0000;">"verticalContentAlignment"</span> <span style="color: #000066;">Value</span>=<span style="color: #ff0000;">"Stretch"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Setter</span> <span style="color: #000066;">Property</span>=<span style="color: #ff0000;">"Template"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Setter.Value<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;ControlTemplate</span> <span style="color: #000066;">TargetType</span>=<span style="color: #ff0000;">"local:DeferredLoadContentControl"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Grid<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>            
          <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;ContentPresenter</span>  <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"contentPresenter"</span></span>
<span style="color: #009900;">                              <span style="color: #000066;">Content</span>=<span style="color: #ff0000;">"{TemplateBinding Content}"</span></span>
<span style="color: #009900;">                              <span style="color: #000066;">ContentTemplate</span>=<span style="color: #ff0000;">"{TemplateBinding ContentTemplate}"</span></span>
<span style="color: #009900;">                              <span style="color: #000066;">VerticalAlignment</span>=<span style="color: #ff0000;">"{TemplateBinding VerticalContentAlignment}"</span></span>
<span style="color: #009900;">                              <span style="color: #000066;">HorizontalAlignment</span>=<span style="color: #ff0000;">"{TemplateBinding HorizontalContentAlignment}"</span></span>
<span style="color: #009900;">                              <span style="color: #000066;">Margin</span>=<span style="color: #ff0000;">"{TemplateBinding Padding}"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
          <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;TextBlock</span> <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"loadingIndicator"</span></span>
<span style="color: #009900;">                      <span style="color: #000066;">Text</span>=<span style="color: #ff0000;">"Loading ..."</span></span>
<span style="color: #009900;">                      <span style="color: #000066;">VerticalAlignment</span>=<span style="color: #ff0000;">"Top"</span> <span style="color: #000066;">HorizontalAlignment</span>=<span style="color: #ff0000;">"Right"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Grid<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/ControlTemplate<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Setter.Value<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Setter<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Style<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre></td></tr></table></div><p>The template contains a <code>ContentPresenter</code> which is responsible for displaying the controls content, and a <code>TextBlock</code> which displays a discrete message while the content is loading. You can of course re-template this control to add a graphical loading indicator, as long as your element has the name <code>"loadingIndicator"</code> it will be shown / hidden.</p><p>The code is also quite simple, here it is in its entirety:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">class</span> DeferredLoadContentControl <span style="color: #008000;">:</span> ContentControl
<span style="color: #008000;">{</span>
  <span style="color: #0600FF; font-weight: bold;">private</span> ContentPresenter _contentPresenter<span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #0600FF; font-weight: bold;">private</span> FrameworkElement _loadingIndicator<span style="color: #008000;">;</span>
&nbsp;
&nbsp;
  <span style="color: #0600FF; font-weight: bold;">public</span> DeferredLoadContentControl<span style="color: #008000;">(</span><span style="color: #008000;">)</span>
  <span style="color: #008000;">{</span>
    <span style="color: #0600FF; font-weight: bold;">this</span><span style="color: #008000;">.</span><span style="color: #0000FF;">DefaultStyleKey</span> <span style="color: #008000;">=</span> <span style="color: #008000;">typeof</span><span style="color: #008000;">(</span>DeferredLoadContentControl<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
    <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span><span style="color: #008000;">!</span>DesignerProperties<span style="color: #008000;">.</span><span style="color: #0000FF;">IsInDesignTool</span><span style="color: #008000;">)</span>
    <span style="color: #008000;">{</span>
      <span style="color: #0600FF; font-weight: bold;">this</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Loaded</span> <span style="color: #008000;">+=</span> DeferredLoadContentControl_Loaded<span style="color: #008000;">;</span>
    <span style="color: #008000;">}</span>
  <span style="color: #008000;">}</span>
&nbsp;
  <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #0600FF; font-weight: bold;">override</span> <span style="color: #6666cc; font-weight: bold;">void</span> OnApplyTemplate<span style="color: #008000;">(</span><span style="color: #008000;">)</span>
  <span style="color: #008000;">{</span>
    <span style="color: #0600FF; font-weight: bold;">base</span><span style="color: #008000;">.</span><span style="color: #0000FF;">OnApplyTemplate</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
    _contentPresenter <span style="color: #008000;">=</span> <span style="color: #0600FF; font-weight: bold;">this</span><span style="color: #008000;">.</span><span style="color: #0000FF;">GetTemplateChild</span><span style="color: #008000;">(</span><span style="color: #666666;">"contentPresenter"</span><span style="color: #008000;">)</span> <span style="color: #0600FF; font-weight: bold;">as</span> ContentPresenter<span style="color: #008000;">;</span>
    _loadingIndicator <span style="color: #008000;">=</span> <span style="color: #0600FF; font-weight: bold;">this</span><span style="color: #008000;">.</span><span style="color: #0000FF;">GetTemplateChild</span><span style="color: #008000;">(</span><span style="color: #666666;">"loadingIndicator"</span><span style="color: #008000;">)</span> <span style="color: #0600FF; font-weight: bold;">as</span> FrameworkElement<span style="color: #008000;">;</span>
&nbsp;
    <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span><span style="color: #008000;">!</span>DesignerProperties<span style="color: #008000;">.</span><span style="color: #0000FF;">IsInDesignTool</span><span style="color: #008000;">)</span>
    <span style="color: #008000;">{</span>
      _contentPresenter<span style="color: #008000;">.</span><span style="color: #0000FF;">Visibility</span> <span style="color: #008000;">=</span> Visibility<span style="color: #008000;">.</span><span style="color: #0000FF;">Collapsed</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">}</span>
    <span style="color: #0600FF; font-weight: bold;">else</span>
    <span style="color: #008000;">{</span>
      <span style="color: #008080; font-style: italic;">// in design-mode show the contents 'grayed out'</span>
      _contentPresenter<span style="color: #008000;">.</span><span style="color: #0000FF;">Opacity</span> <span style="color: #008000;">=</span> <span style="color: #FF0000;">0.5</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">}</span>
  <span style="color: #008000;">}</span>
&nbsp;
  <span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">void</span> DeferredLoadContentControl_Loaded<span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">object</span> sender, RoutedEventArgs e<span style="color: #008000;">)</span>
  <span style="color: #008000;">{</span>
    <span style="color: #008080; font-style: italic;">// content has loaded, now show our content presenter</span>
    _contentPresenter<span style="color: #008000;">.</span><span style="color: #0000FF;">Visibility</span> <span style="color: #008000;">=</span> Visibility<span style="color: #008000;">.</span><span style="color: #0000FF;">Visible</span><span style="color: #008000;">;</span>
    _contentPresenter<span style="color: #008000;">.</span><span style="color: #0000FF;">LayoutUpdated</span> <span style="color: #008000;">+=</span> ContentPresenter_LayoutUpdated<span style="color: #008000;">;</span>
  <span style="color: #008000;">}</span>
&nbsp;
  <span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">void</span> ContentPresenter_LayoutUpdated<span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">object</span> sender, EventArgs e<span style="color: #008000;">)</span>
  <span style="color: #008000;">{</span>
    <span style="color: #008080; font-style: italic;">// the content presenter has been rendered, hide the loading indicator</span>
    _contentPresenter<span style="color: #008000;">.</span><span style="color: #0000FF;">LayoutUpdated</span> <span style="color: #008000;">-=</span> ContentPresenter_LayoutUpdated<span style="color: #008000;">;</span>
    _loadingIndicator<span style="color: #008000;">.</span><span style="color: #0000FF;">Visibility</span> <span style="color: #008000;">=</span> Visibility<span style="color: #008000;">.</span><span style="color: #0000FF;">Collapsed</span><span style="color: #008000;">;</span>
  <span style="color: #008000;">}</span>    
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>As you can see from the above, the content presenter is initially hidden, when the loaded event is fired, the content is shown. When the <code>LayoutUpdated</code> event is fired we know that the content has now been rendered and hide the loading indicator.</p><p>Using the control couldn’t be simpler. Just place your slow-to-load content inside the  <code>DeferredLoadContentControl</code>:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="xml" style="font-family: monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;local:DeferredLoadContentControl<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
  ... your content goes here ...
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/local:DeferredLoadContentControl<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre></td></tr></table></div><p>One nice feature of this control is that when used within the designer, the content contained within the <code>DeferredLoadContentControl</code> is not hidden, instead it is rendered with a 50% and the loading indicator is shown:</p><p><img src="http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2011/01/DesignTime.png" alt="" title="DesignTime" width="250" height="445" class="aligncenter size-full wp-image-1165" /></p><p>You can download the full sourcecode for this control: <a href="{{ site.url }}/blog/colin/wp-content/uploads/2011/01/DeferredLoadContentControl.zip">DeferredLoadContentControl.zip</a></p><p>Regards,<br />
Colin E.</p></div>