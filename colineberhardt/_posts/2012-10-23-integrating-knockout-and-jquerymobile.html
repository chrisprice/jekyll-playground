---
author: Colin Eberhardt
tags: codeproject, jquery-mobile, knockoutJS, mvvm
permalink: /blog/colin/2012/10/integrating-knockout-and-jquerymobile/index.html
layout: colineberhardt-blog
---
<div class="entry"><div class="topsy_widget_data topsy_theme_light-green" style="float: right; margin-left: 0.75em; background: url(data:,%7B%20%22url%22%3A%20%22http%253A%252F%252Fwww.scottlogic.co.uk%252Fblog%252Fcolin%252F2012%252F10%252Fintegrating-knockout-and-jquerymobile%252F%22%2C%20%22style%22%3A%20%22big%22%2C%20%22title%22%3A%20%22Integrating%20Knockout%20and%20jQueryMobile%20%20%23%22%20%7D);"></div><p><em>This blog post looks at the issues regarding integration of KnockoutJS and jQueryMobile, and provides a simple worked example – a Twitter Search application – where the two technologies play nicely together!</em></p><p><img src="http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2012/10/TwitterSearch.jpg" alt="" title="TwitterSearch" width="500" height="375" class="aligncenter size-full wp-image-2308" /></p><p>The <a href="https://github.com/ColinEberhardt/Knockout-jQueryMobile">code for this blog post can be found on github</a>. You can also <a href="http://colineberhardt.github.com/knockout-jqm/">try it out on your phone or browser</a>.</p><h2>Integration Woes!</h2><p><a href="http://knockoutjs.com/">Knockout</a> is a great JavaScript framework for managing the various UI layers of your application, and I use it wherever possible. Recently, while I was working on an <a href="http://www.codeproject.com/Articles/445361/Property-Finder-a-Cross-Platform-HTML5-Mobile-App">HTML5-based cross platform project</a> Knockout was the obvious choice and for the Windows Phone version it worked very well.</p><p>For the iOS version I wanted to mimic the platform look and feel, which requires quite a lot of CSS, so rather than try to write this all myself I opted for <a href="http://jquerymobile.com/">jQueryMobile</a> (jQM) which is a well established framework for transforming HTML into iOS styled pages.</p><p>However, integrating Knockout and jQM poses something of a challenge. One of the biggest issues is that jQM is more than just a set of stylesheets; In order to support the iOS styling it processes the DOM adding supporting structure. For example, a simple button is transformed from this:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="xml" style="font-family: monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;button</span> <span style="color: #000066;">type</span>=<span style="color: #ff0000;">"submit"</span> <span style="color: #000066;">data-bind</span>=<span style="color: #ff0000;">"enable: isSearchEnabled, click: executeSearch"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>Go<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/button<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre></td></tr></table></div><p>To this:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="xml" style="font-family: monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;div</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">"ui-btn ui-btn-inline ui-btn-corner-all ui-shadow ui-btn-up-c"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;span</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">"ui-btn-inner ui-btn-corner-all"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;span</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">"ui-btn-text"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>Go<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/span<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/span<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;input</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">"ui-btn-hidden"</span> <span style="color: #000066;">type</span>=<span style="color: #ff0000;">"button"</span> <span style="color: #000066;">value</span>=<span style="color: #ff0000;">"Go"</span></span>
<span style="color: #009900;">                  <span style="color: #000066;">data-bind</span>=<span style="color: #ff0000;">"enable: isSearchEnabled, </span>
<span style="color: #009900;">                                    click: executeSearch"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/div<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre></td></tr></table></div><p>This means that any changes to the DOM that occur as a result of changes to the underlying data (via the Knockout bindings), must then be further processed by jQM to add the structures that support the CSS.</p><p>My previous HTML5-based JavaScript applications have included a view model, the <code>ApplicationViewModel</code>, which exposes the top most view-model, which is rendered via a suitable template. This makes sense in that it reflects the way that native applications are written and navigated, making handling the <a href="{{ site.url }}/blog/colin/2011/11/handling-the-back-stack-in-windows-phone-7-phonegap-applications/">Windows Phone back stack</a> an easy task. Although this approach results in a lot of disruption to the DOM as pages are added / removes. Using this approach I was unable to make jQM and Knockout play-nice and opted for simply copying the jQM stylesheets, which is far from ideal (you lose animations and end up with verbose HTML templates).</p><p>I decided it was time to re-visit this issue and see if I could come up with a better solution.</p><h2>Integration -Take Two</h2><p>The application I am going to present in this blog post is a simple Twitter Search application which I originally wrote for an <a href="http://msdn.microsoft.com/en-us/magazine/hh975345.aspx">MSDN Magazine article</a>. It has three view models, each of which has a template which is rendered into the DOM when the user navigates from one page to the next.</p><p>I found anecdotal evidence on the web that it was not advisable to re-bind parts of the DOM using <code>ko.applyBindings</code>, this coupled with the fact that it is best to provide jQM with the entire application markup and allow it to do its ‘thing’ all in one go, lead me to try a different approach …</p><p>I removed all of the templates and placed them directly within the HTML document, using the standard jQM approach of adding an <code>id</code> for each page:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="xml" style="font-family: monospace;"><span style="color: #00bbdd;">&lt;!DOCTYPE html&gt;</span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;html<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;head<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
  ...
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/head<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;body<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
&nbsp;
  <span style="color: #808080; font-style: italic;">&lt;!-- ### A page that renders the TwitterSearchViewModel --&gt;</span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;div</span> <span style="color: #000066;">data-role</span>=<span style="color: #ff0000;">"page"</span> <span style="color: #000066;">data-theme</span>=<span style="color: #ff0000;">"b"</span></span>
<span style="color: #009900;">        <span style="color: #000066;">id</span>=<span style="color: #ff0000;">"twitterSearchView"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;div</span> <span style="color: #000066;">data-role</span>=<span style="color: #ff0000;">"header"</span> <span style="color: #000066;">data-theme</span>=<span style="color: #ff0000;">"b"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;h1<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>Twitter Search<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/h1<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/div<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;div</span> <span style="color: #000066;">data-role</span>=<span style="color: #ff0000;">"content"</span> <span style="color: #000066;">data-theme</span>=<span style="color: #ff0000;">"c"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;div<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #808080; font-style: italic;">&lt;!-- search form --&gt;</span>
        ...
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/div<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/div<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/div<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
&nbsp;
  <span style="color: #808080; font-style: italic;">&lt;!-- ### A page that renders the SearchResultsViewModel --&gt;</span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;div</span> <span style="color: #000066;">data-role</span>=<span style="color: #ff0000;">"page"</span> <span style="color: #000066;">data-theme</span>=<span style="color: #ff0000;">"b"</span> <span style="color: #000066;">data-add-back-btn</span>=<span style="color: #ff0000;">"true"</span></span>
<span style="color: #009900;">       <span style="color: #000066;">id</span>=<span style="color: #ff0000;">"searchResultsView"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;div</span> <span style="color: #000066;">data-role</span>=<span style="color: #ff0000;">"header"</span> <span style="color: #000066;">data-theme</span>=<span style="color: #ff0000;">"b"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;h1<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>Results<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/h1<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/div<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;div</span> <span style="color: #000066;">data-role</span>=<span style="color: #ff0000;">"content"</span> <span style="color: #000066;">data-theme</span>=<span style="color: #ff0000;">"c"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
      ...
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/div<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/div<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
&nbsp;
  <span style="color: #808080; font-style: italic;">&lt;!-- ### A page that renders the TweetViewModel --&gt;</span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;div</span> <span style="color: #000066;">data-role</span>=<span style="color: #ff0000;">"page"</span> <span style="color: #000066;">data-theme</span>=<span style="color: #ff0000;">"b"</span> <span style="color: #000066;">data-add-back-btn</span>=<span style="color: #ff0000;">"true"</span></span>
<span style="color: #009900;">       <span style="color: #000066;">id</span>=<span style="color: #ff0000;">"tweetView"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;div</span> <span style="color: #000066;">data-role</span>=<span style="color: #ff0000;">"header"</span> <span style="color: #000066;">data-theme</span>=<span style="color: #ff0000;">"b"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;h1</span> <span style="color: #000066;">data-bind</span>=<span style="color: #ff0000;">"text: author"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/div<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;div</span> <span style="color: #000066;">data-role</span>=<span style="color: #ff0000;">"content"</span> <span style="color: #000066;">data-theme</span>=<span style="color: #ff0000;">"c"</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">"tweet"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
      <span style="color: #808080; font-style: italic;">&lt;!-- a simple tweet view --&gt;</span>
      ...
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/div<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/div<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
&nbsp;
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/body<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/html<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre></td></tr></table></div><p>Binding to this structure is simply a matter of creating view models that ‘back’ each jQM page and binding them via <code>ko.applyBindings</code>:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family: monospace;"><span style="color: #006600; font-style: italic;">// create the various view models</span>
<span style="color: #000066; font-weight: bold;">var</span> twitterSearchViewModel <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">new</span> TwitterSearchViewModel<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span>
searchResultsViewModel <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">new</span> SearchResultsViewModel<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span>
tweetViewModel <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">new</span> TweetViewModel<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
$<span style="color: #009900;">(</span>document<span style="color: #009900;">)</span>.<span style="color: #660066;">ready</span><span style="color: #009900;">(</span><span style="color: #000066; font-weight: bold;">function</span> <span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
  <span style="color: #006600; font-style: italic;">// bind each view model to a jQueryMobile page</span>
  ko.<span style="color: #660066;">applyBindings</span><span style="color: #009900;">(</span>twitterSearchViewModel<span style="color: #339933;">,</span> document.<span style="color: #660066;">getElementById</span><span style="color: #009900;">(</span><span style="color: #3366CC;">"twitterSearchView"</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
  ko.<span style="color: #660066;">applyBindings</span><span style="color: #009900;">(</span>searchResultsViewModel<span style="color: #339933;">,</span> document.<span style="color: #660066;">getElementById</span><span style="color: #009900;">(</span><span style="color: #3366CC;">"searchResultsView"</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
  ko.<span style="color: #660066;">applyBindings</span><span style="color: #009900;">(</span>tweetViewModel<span style="color: #339933;">,</span> document.<span style="color: #660066;">getElementById</span><span style="color: #009900;">(</span><span style="color: #3366CC;">"tweetView"</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span></pre></td></tr></table></div><p>Note, I <em>could</em> have created a single view model that exposes each of the three view models above and bound this at the <code>body</code> element level. But this would add very little value, it would not make communication between vie models any easier.</p><h2>Page Navigation</h2><p>The next problem to tackle is page navigation. With the Twitter Search application, the HTML for the search form is as follows:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="xml" style="font-family: monospace;"><span style="color: #808080; font-style: italic;">&lt;!-- search form --&gt;</span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;form<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;input</span> <span style="color: #000066;">type</span>=<span style="color: #ff0000;">"search"</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">"search"</span></span>
<span style="color: #009900;">          <span style="color: #000066;">data-bind</span>=<span style="color: #ff0000;">"value: searchTerm, valueUpdate: 'afterkeydown'"</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;input</span> <span style="color: #000066;">type</span>=<span style="color: #ff0000;">"button"</span> <span style="color: #000066;">value</span>=<span style="color: #ff0000;">"Go"</span></span>
<span style="color: #009900;">          <span style="color: #000066;">data-bind</span>=<span style="color: #ff0000;">"click: search"</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/form<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre></td></tr></table></div><p>The <code>TwitterSearchViewModel</code> which this part of the page is bound to exposes the <code>search</code> function which queries twitter and navigates to the results page:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family: monospace;"><span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">search</span> <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">function</span> <span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
  <span style="color: #006600; font-style: italic;">/// &lt;summary&gt;</span>
  <span style="color: #006600; font-style: italic;">/// Searches twitter for the current search term.</span>
  <span style="color: #006600; font-style: italic;">/// &lt;/summary&gt;</span>
&nbsp;
  <span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">(</span>$.<span style="color: #660066;">trim</span><span style="color: #009900;">(</span><span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">searchTerm</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #339933;">===</span> <span style="color: #3366CC;">""</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
    <span style="color: #000066; font-weight: bold;">return</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">}</span>
&nbsp;
  <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">userMessage</span><span style="color: #009900;">(</span><span style="color: #3366CC;">""</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
  <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">isSearching</span><span style="color: #009900;">(</span><span style="color: #003366; font-weight: bold;">true</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
  twitterSearchService.<span style="color: #660066;">searchForKeyword</span><span style="color: #009900;">(</span>that.<span style="color: #660066;">searchTerm</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span> <span style="color: #CC0000;">1</span><span style="color: #339933;">,</span> <span style="color: #000066; font-weight: bold;">function</span> <span style="color: #009900;">(</span>tweets<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
    <span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">(</span>tweets.<span style="color: #660066;">length</span> <span style="color: #339933;">&gt;</span> <span style="color: #CC0000;">0</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
      <span style="color: #006600; font-style: italic;">// store this search</span>
      addSearchTermToRecentSearches<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
      <span style="color: #006600; font-style: italic;">// navigate to the results view model</span>
      searchResultsViewModel.<span style="color: #660066;">init</span><span style="color: #009900;">(</span>that.<span style="color: #660066;">searchTerm</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span> tweets<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
      $.<span style="color: #660066;">mobile</span>.<span style="color: #660066;">changePage</span><span style="color: #009900;">(</span><span style="color: #3366CC;">"#"</span> <span style="color: #339933;">+</span> searchResultsViewModel.<span style="color: #660066;">template</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">}</span> <span style="color: #000066; font-weight: bold;">else</span> <span style="color: #009900;">{</span>
      that.<span style="color: #660066;">userMessage</span><span style="color: #009900;">(</span><span style="color: #3366CC;">"There were no matches for the given search term"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">}</span>
&nbsp;
    that.<span style="color: #660066;">isSearching</span><span style="color: #009900;">(</span><span style="color: #003366; font-weight: bold;">false</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">}</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></td></tr></table></div><p>The interesting code in the above snippet is this part:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family: monospace;"><span style="color: #006600; font-style: italic;">// navigate to the results view model</span>
searchResultsViewModel.<span style="color: #660066;">init</span><span style="color: #009900;">(</span>that.<span style="color: #660066;">searchTerm</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span> tweets<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
$.<span style="color: #660066;">mobile</span>.<span style="color: #660066;">changePage</span><span style="color: #009900;">(</span><span style="color: #3366CC;">"#"</span> <span style="color: #339933;">+</span> searchResultsViewModel.<span style="color: #660066;">template</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span></pre></td></tr></table></div><p>Here we initialise the <code>searchResultsViewModel</code> which is global variable, providing it with the search result. The call to <code>$.mobile.changePage</code> causes jQM to ‘navigate’ to the next page via a fancy slide transition.</p><p>The <code>SearchResultsViewModel</code> takes the valus supplied by the <code>init</code> method and updates its bound observables:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family: monospace;"><span style="color: #000066; font-weight: bold;">function</span> SearchResultsViewModel<span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
  <span style="color: #006600; font-style: italic;">/// &lt;summary&gt;</span>
  <span style="color: #006600; font-style: italic;">/// A view model that renders the results of a twitter search.</span>
  <span style="color: #006600; font-style: italic;">/// &lt;/summary&gt;</span>
&nbsp;
  <span style="color: #000066; font-weight: bold;">var</span> that <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">this</span><span style="color: #339933;">,</span>
      twitterSearchService <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">new</span> TwitterSearchService<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #006600; font-style: italic;">// --- properties</span>
  <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">template</span> <span style="color: #339933;">=</span> <span style="color: #3366CC;">"searchResultsView"</span><span style="color: #339933;">;</span>
  <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">tweets</span> <span style="color: #339933;">=</span> ko.<span style="color: #660066;">observableArray</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
  <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">pageNumber</span> <span style="color: #339933;">=</span> ko.<span style="color: #660066;">observable</span><span style="color: #009900;">(</span><span style="color: #CC0000;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
  <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">searchString</span> <span style="color: #339933;">=</span> <span style="color: #3366CC;">""</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #006600; font-style: italic;">// --- public functions</span>
  <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">init</span> <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">function</span> <span style="color: #009900;">(</span>searchText<span style="color: #339933;">,</span> tweetViewModels<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
    <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">tweets</span><span style="color: #009900;">(</span>tweetViewModels<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
    <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">pageNumber</span> <span style="color: #339933;">=</span> ko.<span style="color: #660066;">observable</span><span style="color: #009900;">(</span><span style="color: #CC0000;">1</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
    <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">searchString</span> <span style="color: #339933;">=</span> searchText<span style="color: #339933;">;</span>
  <span style="color: #009900;">}</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td></tr></table></div><p>Updating the state of the bound view model removes the need for re-binding. The same approach is used for navigating from the <code>SearchResultsViewModel</code> to the <code>TweetViewModel</code>, a single <code>TweetViewModel</code> instance is bound to the UI, with its state updated as required.</p><h2>List binding</h2><p>The above code all works quite nicely apart from one snag – lists. A knockout <code>foreach</code> can result in new elements being added to the DOM, each of which have to be processed. Typically a Knockout <code>foreach</code> would be used to populate a jQM listview, which performs all kinds of extra processing to ensure that each list item has the same height etc …</p><p>The approach I took is very similar to the <a href="http://blog.dee4star.com/integrating-knockoutjs-with-jquery-mobile-1">one presented in this blog post</a>, which adds a custom binding that ensures that the listview is made aware of new items being added. The one problem I found with the approach presented is that it worked for the initial population of the list, but subsequent updates did not update the custom binding. Combining this approach with a <a href="http://stackoverflow.com/questions/10231347/knockout-afterrender-but-just-once">few tips I picked up from StackOverflow</a>, I came up with this solution:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family: monospace;">ko.<span style="color: #660066;">virtualElements</span>.<span style="color: #660066;">allowedBindings</span>.<span style="color: #660066;">updateListviewOnChange</span> <span style="color: #339933;">=</span> <span style="color: #003366; font-weight: bold;">true</span><span style="color: #339933;">;</span>
ko.<span style="color: #660066;">bindingHandlers</span>.<span style="color: #660066;">updateListviewOnChange</span> <span style="color: #339933;">=</span> <span style="color: #009900;">{</span>
  update<span style="color: #339933;">:</span> <span style="color: #000066; font-weight: bold;">function</span> <span style="color: #009900;">(</span>element<span style="color: #339933;">,</span> valueAccessor<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
    ko.<span style="color: #660066;">utils</span>.<span style="color: #660066;">unwrapObservable</span><span style="color: #009900;">(</span>valueAccessor<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>  <span style="color: #006600; font-style: italic;">//grab dependency</span>
&nbsp;
    <span style="color: #006600; font-style: italic;">// locate the listview</span>
    <span style="color: #000066; font-weight: bold;">var</span> listview <span style="color: #339933;">=</span> $<span style="color: #009900;">(</span>element<span style="color: #009900;">)</span>.<span style="color: #660066;">parents</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span>
                             .<span style="color: #660066;">andSelf</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span>
                             .<span style="color: #660066;">filter</span><span style="color: #009900;">(</span><span style="color: #3366CC;">"[data-role='listview']"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">(</span>listview<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
      <span style="color: #000066; font-weight: bold;">try</span> <span style="color: #009900;">{</span>
        $<span style="color: #009900;">(</span>listview<span style="color: #009900;">)</span>.<span style="color: #660066;">listview</span><span style="color: #009900;">(</span><span style="color: #3366CC;">'refresh'</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
      <span style="color: #009900;">}</span> <span style="color: #000066; font-weight: bold;">catch</span> <span style="color: #009900;">(</span>e<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
        <span style="color: #006600; font-style: italic;">// if the listview is not initialised, the above call with throw an exception</span>
        <span style="color: #006600; font-style: italic;">// there doe snot appear to be any way to easily test for this state, so</span>
        <span style="color: #006600; font-style: italic;">// we just swallow the exception here.</span>
      <span style="color: #009900;">}</span>
    <span style="color: #009900;">}</span>
  <span style="color: #009900;">}</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></td></tr></table></div><p>The above is a custom binding that peforms some special logic each time the binding source changes. It locates the jQM listview, which could be the element that the binding is defined upon, or some parent (via a pretty funky jQuery tree traversal ‘query’). When the listview is found, <code>listview('refresh')</code> is invoked, which causes it to re-process all the list items, adding the required jQM markup to any newly added elements.</p><p>The <code>ko.virtualElements.allowedBindings</code> line allows this approach to be used for containerless Knockout bindings. </p><p>You can see this approach used in practice on the front page of the application where it displays the recent search terms:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="xml" style="font-family: monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;ul</span> <span style="color: #000066;">data-role</span>=<span style="color: #ff0000;">"listview"</span></span>
<span style="color: #009900;">    <span style="color: #000066;">data-bind</span>=<span style="color: #ff0000;">"foreach: recentSearches, updateTableEachTimeItChanges:recentSearches"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;li<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;a</span> <span style="color: #000066;">data-bind</span>=<span style="color: #ff0000;">"click: $parent.recentSearchClicked"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;span</span> <span style="color: #000066;">data-bind</span>=<span style="color: #ff0000;">"text: $data"</span><span style="color: #000000; font-weight: bold;">&gt;</span><span style="color: #000000; font-weight: bold;">&lt;/span<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/a<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/li<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/ul<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre></td></tr></table></div><p>And in the search results view where it is used in the containerless form:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="xml" style="font-family: monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;div</span> <span style="color: #000066;">data-role</span>=<span style="color: #ff0000;">"content"</span> <span style="color: #000066;">data-theme</span>=<span style="color: #ff0000;">"c"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
  <span style="color: #808080; font-style: italic;">&lt;!-- twitter search results --&gt;</span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;ul</span> <span style="color: #000066;">data-role</span>=<span style="color: #ff0000;">"listview"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
    <span style="color: #808080; font-style: italic;">&lt;!-- ko foreach: tweets, updateListviewOnChange:tweets --&gt;</span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;li<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;a</span> <span style="color: #000066;">data-bind</span>=<span style="color: #ff0000;">"click: $parent.tweetClicked"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;div</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">"thumbnail-container"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
          <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;img</span> <span style="color: #000066;">data-bind</span>=<span style="color: #ff0000;">"attr: { src: thumbnail }"</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/div<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;h3</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">"author"</span> <span style="color: #000066;">data-bind</span>=<span style="color: #ff0000;">"text: author"</span><span style="color: #000000; font-weight: bold;">&gt;</span><span style="color: #000000; font-weight: bold;">&lt;/h3<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;p</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">"text"</span> <span style="color: #000066;">data-bind</span>=<span style="color: #ff0000;">"text: text"</span><span style="color: #000000; font-weight: bold;">&gt;</span><span style="color: #000000; font-weight: bold;">&lt;/p<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/a<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/li<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
      <span style="color: #808080; font-style: italic;">&lt;!-- /ko --&gt;</span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;li<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;a</span> <span style="color: #000066;">data-bind</span>=<span style="color: #ff0000;">"click: loadMore"</span> <span style="color: #000066;">href</span>=<span style="color: #ff0000;">"#"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;h3</span> <span style="color: #000066;">data-bind</span>=<span style="color: #ff0000;">"visible: !isSearching()"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>Load more ...<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/h3<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;h3</span> <span style="color: #000066;">data-bind</span>=<span style="color: #ff0000;">"visible: isSearching()"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>Loading ...<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/h3<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/a<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/li<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/ul<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/div<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre></td></tr></table></div><p>It’s a pretty simple solution, but it took a lot of trial and error to reach this point!</p><p>Finally, the iScroll integration, which I previously attempted myself is now achieved via the <a href="https://github.com/watusi/jquery-mobile-iscrollview">jquery-mobile-iscrollview plugin</a>, which works like a charm. Just add <code>data-iscroll</code> to any page content and it will scroll.</p><p>The <a href="https://github.com/ColinEberhardt/Knockout-jQueryMobile">code for this blog post can be found on github</a>. You can also <a href="http://colineberhardt.github.com/knockout-jqm/">try it out on your phone or browser</a>.</p><p>Regards, Colin E.</p></div>