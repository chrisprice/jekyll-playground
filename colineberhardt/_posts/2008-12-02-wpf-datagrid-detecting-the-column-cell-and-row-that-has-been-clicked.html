---
author: Colin Eberhardt
tags: DataGrid, WPF
permalink: /blog/colin/2008/12/wpf-datagrid-detecting-clicked-cell-and-row/index.html
layout: colineberhardt-blog
---
<div class="entry"><div class="topsy_widget_data topsy_theme_light-green" style="float: right; margin-left: 0.75em; background: url(data:,%7B%20%22url%22%3A%20%22http%253A%252F%252Fwww.scottlogic.co.uk%252Fblog%252Fcolin%252F2008%252F12%252Fwpf-datagrid-detecting-clicked-cell-and-row%252F%22%2C%20%22style%22%3A%20%22big%22%2C%20%22title%22%3A%20%22WPF%20DataGrid%20-%20detecting%20the%20column%2C%20cell%20and%20row%20that%20has%20been%20clicked%20%23%22%20%7D);"></div><p>The WPF DataGrid is a very flexible tool, however in its current state certain simple tasks can prove to be rather tricky. A fairly common task when working with DataGrid is detecting which row, or cell a user has clicked on, or whether they clicked a column header. You might expect this information to be readily available in the form of events, after all, the Windows Forms DataGridView has <a href="msdn.microsoft.com/en-us/library/system.windows.forms.datagridview.cellclick.aspx">CellClicked</a> and <a href="msdn.microsoft.com/en-us/library/system.windows.forms.datagridview.columnheadermouseclick.aspx">ColumnHeaderMouseClick</a> events (among many others). However, sadly this is not the case. In order to implement this behaviour you have to understand the visual tree of the DataGrid and how it can be navigated.</p><p>Let’s say for example you wanted to find the DataGrid item (cell, row, header) that was clicked when the right mouse button is released. Firstly, we add an event handler for the mouse click in our code-behind:</p><p>XAML:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="xml" style="font-family: monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;dg:DataGrid</span> <span style="color: #000066;">Name</span>=<span style="color: #ff0000;">"DataGrid"</span></span>
<span style="color: #009900;">             <span style="color: #000066;">MouseRightButtonUp</span>=<span style="color: #ff0000;">"DataGrid_MouseRightButtonUp"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span></pre></td></tr></table></div><p>C#:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">void</span> DataGrid_MouseRightButtonUp<span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">object</span> sender,
                                        MouseButtonEventArgs e<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>The above event is a ‘bubbling’ event, which means that it it started on the element that was originally clicked (for example a TextBlock which renders the cell’s value within a DataGridCell), then bubbled up the logical tree until it reaches our event handler in the Window. The e.OriginalSource property gives us access to the element that initiated this event.</p><p>The problem is that while we have access to the lement which was clicked on, this element is part of the control or data template of the element that we are really interested, the cell or header. The WPF rich-content model means that our cells could contain all sorts of visual element, therefore we have no way of guessing exactly what e.OriginalSource will be. However, the one thing of which we can be certain is that this element is a child of the element which we are interested in.</p><p>If you place a bearkpoint within yoru event handler, you can then use the excellent <a href="http://karlshifflett.wordpress.com/mole-for-visual-studio/">Mole</a> debug visualiser to locate the clicked element within the visual tree as illustrated below:</p><p><a href="http://wpfadventures.files.wordpress.com/2008/12/dgvisualtree.png"><img class="alignnone size-full wp-image-60" title="dgvisualtree" src="http://wpfadventures.files.wordpress.com/2008/12/dgvisualtree.png" alt="dgvisualtree" width="450" height="428" /></a></p><p>As you can see, the visual tree is a complex beast! I have highlighted the items of interest:</p><ol>
<li>The <strong>TextBlock</strong>, which is the element I clicked on, which is e.OriginalSource parameter.</li>
<li>The <strong>DataGridCell</strong>, the cell which was clicked on.</li>
<li>The <strong>DataGridRow </strong>which the cell belongs to.</li>
<li>And finally, the <strong>DataGrid</strong>.</li>
</ol><p>Therefore, in order to locate the cell and row that was clicked on we must navigate up the Visual Tree, searching by type:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">void</span> DataGrid_MouseRightButtonUp<span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">object</span> sender,
                                                  MouseButtonEventArgs e<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
    DependencyObject dep <span style="color: #008000;">=</span> <span style="color: #008000;">(</span>DependencyObject<span style="color: #008000;">)</span>e<span style="color: #008000;">.</span><span style="color: #0000FF;">OriginalSource</span><span style="color: #008000;">;</span>
&nbsp;
    <span style="color: #008080; font-style: italic;">// iteratively traverse the visual tree</span>
    <span style="color: #0600FF; font-weight: bold;">while</span> <span style="color: #008000;">(</span><span style="color: #008000;">(</span>dep <span style="color: #008000;">!=</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">)</span> <span style="color: #008000;">&amp;</span>amp<span style="color: #008000;">;&amp;</span>amp<span style="color: #008000;">;</span>
            <span style="color: #008000;">!</span><span style="color: #008000;">(</span>dep <span style="color: #008000;">is</span> DataGridCell<span style="color: #008000;">)</span> <span style="color: #008000;">&amp;</span>amp<span style="color: #008000;">;&amp;</span>amp<span style="color: #008000;">;</span>
            <span style="color: #008000;">!</span><span style="color: #008000;">(</span>dep <span style="color: #008000;">is</span> DataGridColumnHeader<span style="color: #008000;">)</span><span style="color: #008000;">)</span>
    <span style="color: #008000;">{</span>
        dep <span style="color: #008000;">=</span> VisualTreeHelper<span style="color: #008000;">.</span><span style="color: #0000FF;">GetParent</span><span style="color: #008000;">(</span>dep<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">}</span>
&nbsp;
    <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>dep <span style="color: #008000;">==</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">)</span>
        <span style="color: #0600FF; font-weight: bold;">return</span><span style="color: #008000;">;</span>
&nbsp;
    <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>dep <span style="color: #008000;">is</span> DataGridColumnHeader<span style="color: #008000;">)</span>
    <span style="color: #008000;">{</span>
        DataGridColumnHeader columnHeader <span style="color: #008000;">=</span> dep <span style="color: #0600FF; font-weight: bold;">as</span> DataGridColumnHeader<span style="color: #008000;">;</span>
        <span style="color: #008080; font-style: italic;">// do something</span>
    <span style="color: #008000;">}</span>
&nbsp;
    <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>dep <span style="color: #008000;">is</span> DataGridCell<span style="color: #008000;">)</span>
    <span style="color: #008000;">{</span>
        DataGridCell cell <span style="color: #008000;">=</span> dep <span style="color: #0600FF; font-weight: bold;">as</span> DataGridCell<span style="color: #008000;">;</span>
        <span style="color: #008080; font-style: italic;">// do something</span>
    <span style="color: #008000;">}</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>Fantastic, we have now have our header and cell. All that’s left to do is extract the cell’s row and column indices, and cell value. Wait a minute … where are the cell.RowIndex and cell.ColumnIndex properties? It looks like there’s more work to be done.</p><p>Once we have navigated up the tree to the DataGridCell, we can continue our journey upwards to obtain the DataGridRow:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>dep <span style="color: #008000;">is</span> DataGridCell<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
    DataGridCell cell <span style="color: #008000;">=</span> dep <span style="color: #0600FF; font-weight: bold;">as</span> DataGridCell<span style="color: #008000;">;</span>
&nbsp;
    <span style="color: #008080; font-style: italic;">// navigate further up the tree</span>
    <span style="color: #0600FF; font-weight: bold;">while</span> <span style="color: #008000;">(</span><span style="color: #008000;">(</span>dep <span style="color: #008000;">!=</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">)</span> <span style="color: #008000;">&amp;</span>amp<span style="color: #008000;">;&amp;</span>amp<span style="color: #008000;">;</span> <span style="color: #008000;">!</span><span style="color: #008000;">(</span>dep <span style="color: #008000;">is</span> DataGridRow<span style="color: #008000;">)</span><span style="color: #008000;">)</span>
    <span style="color: #008000;">{</span>
        dep <span style="color: #008000;">=</span> VisualTreeHelper<span style="color: #008000;">.</span><span style="color: #0000FF;">GetParent</span><span style="color: #008000;">(</span>dep<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">}</span>
&nbsp;
    DataGridRow row <span style="color: #008000;">=</span> dep <span style="color: #0600FF; font-weight: bold;">as</span> DataGridRow<span style="color: #008000;">;</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>Does the DataGridRow have a RowIndex property? I think you can guess the answer to that question.</p><p>The DataGrid is an <a href="http://msdn.microsoft.com/en-us/library/system.windows.controls.itemscontrol.aspx">ItemsControl</a> – WPF users are probably most familiar with the ListView which is also an ItemsControl whcih has a number of similarities with the DataGrid. In the ItemsControl terminology, the DataGridRow is an ItemContainer and the DataGrid has an ItemContainerGenerator associated with it for generating the rows. I don’t want to go into the details of how ItemContainers work, Dr. WPF has a good <a href="http://www.drwpf.com/blog/ItemsControlSeries/tabid/59/Default.aspx">series on the ItemsControl</a> for those who are interested. The following code can be used to determine the index of a row:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">int</span> FindRowIndex<span style="color: #008000;">(</span>DataGridRow row<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
    DataGrid dataGrid <span style="color: #008000;">=</span>
        ItemsControl<span style="color: #008000;">.</span><span style="color: #0000FF;">ItemsControlFromItemContainer</span><span style="color: #008000;">(</span>row<span style="color: #008000;">)</span>
        <span style="color: #0600FF; font-weight: bold;">as</span> DataGrid<span style="color: #008000;">;</span>
&nbsp;
    <span style="color: #6666cc; font-weight: bold;">int</span> index <span style="color: #008000;">=</span> dataGrid<span style="color: #008000;">.</span><span style="color: #0000FF;">ItemContainerGenerator</span><span style="color: #008000;">.</span>
        <span style="color: #0000FF;">IndexFromContainer</span><span style="color: #008000;">(</span>row<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
    <span style="color: #0600FF; font-weight: bold;">return</span> index<span style="color: #008000;">;</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>Now that we have the row index, the column index is thankfully a little easier to locate, cell.Column.DisplayIndex does the trick. The final piece of information which we might like is the cell value. Is there a cell.Value properly? don’t make me laugh!</p><p>The following method determines the property binding for the cells column, then extracts the value from the data items associated with the row:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">object</span> ExtractBoundValue<span style="color: #008000;">(</span>DataGridRow row,
                                 DataGridCell cell<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
    <span style="color: #008080; font-style: italic;">// find the column that this cell belongs to</span>
    DataGridBoundColumn col <span style="color: #008000;">=</span>
       cell<span style="color: #008000;">.</span><span style="color: #0000FF;">Column</span> <span style="color: #0600FF; font-weight: bold;">as</span> DataGridBoundColumn<span style="color: #008000;">;</span>
&nbsp;
    <span style="color: #008080; font-style: italic;">// find the property that this column is bound to</span>
    Binding binding <span style="color: #008000;">=</span> col<span style="color: #008000;">.</span><span style="color: #0000FF;">Binding</span> <span style="color: #0600FF; font-weight: bold;">as</span> Binding<span style="color: #008000;">;</span>
    <span style="color: #6666cc; font-weight: bold;">string</span> boundPropertyName <span style="color: #008000;">=</span> binding<span style="color: #008000;">.</span><span style="color: #0000FF;">Path</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Path</span><span style="color: #008000;">;</span>
&nbsp;
    <span style="color: #008080; font-style: italic;">// find the object that is related to this row</span>
    <span style="color: #6666cc; font-weight: bold;">object</span> data <span style="color: #008000;">=</span> row<span style="color: #008000;">.</span><span style="color: #0000FF;">Item</span><span style="color: #008000;">;</span>
&nbsp;
    <span style="color: #008080; font-style: italic;">// extract the property value</span>
    PropertyDescriptorCollection properties <span style="color: #008000;">=</span>
        TypeDescriptor<span style="color: #008000;">.</span><span style="color: #0000FF;">GetProperties</span><span style="color: #008000;">(</span>data<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
    PropertyDescriptor property <span style="color: #008000;">=</span> properties<span style="color: #008000;">[</span>boundPropertyName<span style="color: #008000;">]</span><span style="color: #008000;">;</span>
    <span style="color: #6666cc; font-weight: bold;">object</span> <span style="color: #0600FF; font-weight: bold;">value</span> <span style="color: #008000;">=</span> property<span style="color: #008000;">.</span><span style="color: #0000FF;">GetValue</span><span style="color: #008000;">(</span>data<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
    <span style="color: #0600FF; font-weight: bold;">return</span> <span style="color: #0600FF; font-weight: bold;">value</span><span style="color: #008000;">;</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>Putting it all together, this blog post has a small smaple application which displays the header index and value, or cell’s row/column indices and value in response to a right mouse click:</p><p><a href="http://wpfadventures.files.wordpress.com/2008/12/clickedvalue.png"><img class="alignnone size-full wp-image-61" title="clickedvalue" src="http://wpfadventures.files.wordpress.com/2008/12/clickedvalue.png" alt="clickedvalue" width="299" height="299" /></a></p><p>The sample project can be download, <a href="http://wpfadventures.files.wordpress.com/2008/12/wpfdatagridmouseclicks.doc">wpfdatagridmouseclicks</a>, changing the file extension from .doc to .zip.</p><p>Regards, Colin E.</p></div>