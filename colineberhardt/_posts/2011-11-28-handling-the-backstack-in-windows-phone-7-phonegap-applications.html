---
author: Colin Eberhardt
tags: knockoutJS, PhoneGap, Windows Phone 7
permalink: /blog/colin/2011/11/handling-the-back-stack-in-windows-phone-7-phonegap-applications/index.html
layout: colineberhardt-blog
---
<div class="entry"><div class="topsy_widget_data topsy_theme_light-green" style="float: right; margin-left: 0.75em; background: url(data:,%7B%20%22url%22%3A%20%22http%253A%252F%252Fwww.scottlogic.co.uk%252Fblog%252Fcolin%252F2011%252F11%252Fhandling-the-back-stack-in-windows-phone-7-phonegap-applications%252F%22%2C%20%22style%22%3A%20%22big%22%2C%20%22title%22%3A%20%22Handling%20the%20back-stack%20in%20Windows%20Phone%207%20PhoneGap%20applications%20%23%22%20%7D);"></div><p>Recently I have been researching the use of PhoneGap for creating HTML5 Windows Phone 7 applications. I have written an <a href="{{ site.url }}/blog/colin/2011/09/developing-windows-phone-7-html5-apps-with-phonegap/" title="Developing Windows Phone 7 HTML5 apps with PhoneGap">introductory post</a> on the subject and also managed to have a <a href="{{ site.url }}/blog/colin/2011/11/property-finder-the-first-html5-based-windows-phone-7-application/" title="Property Finder – the first HTML5-based Windows Phone 7 Application">HTML5-based application accepted into the marketplace</a>.</p><p>The Windows Phone 7 execution model has a few unique features (when compared to Android and iOS) that need to be considered when developing HTML5 applications. The first one, <a href="{{ site.url }}/blog/colin/2011/10/tombstoning-with-phonegap-for-windows-phone-7-and-knockoutjs/" title="Tombstoning with PhoneGap for Windows Phone 7 (and KnockoutJS)">tombstoning</a>, is something I dealt with in an earlier blogpost. In this post I want to look at how to handle the back-button and the application back-stack.</p><p><img src="http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2011/11/BackStack.png" alt="" title="BackStack" width="600" height="279" class="aligncenter size-full wp-image-1853" /></p><p>With Windows Phone 7, as the user navigates from one page to the next, the latest page is added to the top of a stack (the back-stack). The back-button is used to navigate back through the pages within your application by pulling them from the top of this stack. When the back stack holds a single page, i.e. the initial entry point into your application, pressing the back-button should exit the application.</p><p>So, how do you support this with a HTML5 / PhoneGap application? The PhoneGap APIs expose the <a href="http://docs.phonegap.com/en/1.0.0/phonegap_events_events.md.html#backbutton">back-button as a JavaScript event</a>. If you subscribe to this event, your JavaScript code is notified each time the user hits the back button. Also, if the JavaScript event is subscribed to, the ‘native’ (C#) event is cancelled, which means application back-stack remains unchanged and your PhoneGap application does not exit.</p><p>In order to emulate the back-stack functionality in a PhoneGap application you need to subscribe to the PhoneGap backbutton when back-navigation is possible within your application, and unsubscribe when it is not. This means that when the user hits the back-button at the entry-point of your application, the application is terminated as expected.</p><h2>A JavaScript Back-Stack</h2><p>In order to handle the PhoenGap backbutton event, I felt the easiest approach would be to structure my JavaScript application so that it more closely resembles a Windows Phone 7 application. I have already discussed in my blog post on <a href="{{ site.url }}/blog/colin/2011/10/tombstoning-with-phonegap-for-windows-phone-7-and-knockoutjs/" title="Tombstoning with PhoneGap for Windows Phone 7 (and KnockoutJS)">tombstoning how this task was made easier by using KnockoutJS</a> to structure my code using the Model-View-ViewModel (MVVM) pattern.</p><p>In this blog I’ll add further structure to the code, starting with an <code>ApplicationViewModel</code>. This view model contains a stack of view-models, with the one that is at the top of the stack, exposed via the <code>currentViewModel</code> observable property, being the one which is rendered on screen. The ApplicationViewModel also exposes functions for adding to and removing items from this stack:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family: monospace;"><span style="color: #000066; font-weight: bold;">function</span> ApplicationViewModel<span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
&nbsp;
  <span style="color: #000066; font-weight: bold;">var</span> that <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">this</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">viewModelBackStack</span> <span style="color: #339933;">=</span> ko.<span style="color: #660066;">observableArray</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">backButtonRequired</span> <span style="color: #339933;">=</span> ko.<span style="color: #660066;">dependentObservable</span><span style="color: #009900;">(</span><span style="color: #000066; font-weight: bold;">function</span> <span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>    
    <span style="color: #000066; font-weight: bold;">return</span> <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">viewModelBackStack</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span>.<span style="color: #660066;">length</span> <span style="color: #339933;">&gt;</span> <span style="color: #CC0000;">1</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">}</span><span style="color: #339933;">,</span> <span style="color: #000066; font-weight: bold;">this</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">currentViewModel</span> <span style="color: #339933;">=</span> ko.<span style="color: #660066;">dependentObservable</span><span style="color: #009900;">(</span><span style="color: #000066; font-weight: bold;">function</span> <span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
    <span style="color: #000066; font-weight: bold;">return</span> <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">viewModelBackStack</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #009900;">[</span><span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">viewModelBackStack</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span>.<span style="color: #660066;">length</span><span style="color: #339933;">-</span><span style="color: #CC0000;">1</span><span style="color: #009900;">]</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">}</span><span style="color: #339933;">,</span> <span style="color: #000066; font-weight: bold;">this</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">navigateTo</span> <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">function</span> <span style="color: #009900;">(</span>viewModel<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
    <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">viewModelBackStack</span>.<span style="color: #660066;">push</span><span style="color: #009900;">(</span>viewModel<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">}</span>
&nbsp;
  <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">back</span> <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">function</span> <span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
    <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">viewModelBackStack</span>.<span style="color: #660066;">pop</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
   <span style="color: #009900;">}</span>
<span style="color: #009900;">}</span></pre></td></tr></table></div><p>The <code>currentViewModel</code> is implemented as a <a href="http://knockoutjs.com/documentation/dependentObservables.html">dependent-observable</a>, a really neat KnockoutJS feature where you create a new observable property based on one or more observable properties of a view model. In this case, KnockoutJS does some magic behind the scenes to deduce that<br />
<code>currentViewModel</code> depends upon the <code>viewModelBackStack</code> observable array. Each time the array is modified, bindings that depend on <code>currentViewModel</code> are also updated. That’s pretty neat!</p><p>The UI code needs to be modified so that the view relating to the <code>currentViewModel</code> is rendered and bound to its respective view model. This is simply a matter of subscribing to changes in this observable property in our code:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family: monospace;"><span style="color: #006600; font-style: italic;">// create the view model</span>
application <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">new</span> ApplicationViewModel<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
application.<span style="color: #660066;">currentViewModel</span>.<span style="color: #660066;">subscribe</span><span style="color: #009900;">(</span><span style="color: #000066; font-weight: bold;">function</span> <span style="color: #009900;">(</span>viewModel<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
  <span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">(</span>viewModel <span style="color: #339933;">!==</span> <span style="color: #003366; font-weight: bold;">undefined</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
    $<span style="color: #009900;">(</span><span style="color: #3366CC;">"#app"</span><span style="color: #009900;">)</span>.<span style="color: #660066;">empty</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
    $<span style="color: #009900;">(</span><span style="color: #3366CC;">"#"</span> <span style="color: #339933;">+</span> viewModel.<span style="color: #660066;">template</span><span style="color: #009900;">)</span>.<span style="color: #660066;">tmpl</span><span style="color: #009900;">(</span><span style="color: #3366CC;">""</span><span style="color: #009900;">)</span>.<span style="color: #660066;">appendTo</span><span style="color: #009900;">(</span><span style="color: #3366CC;">"#app"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
    ko.<span style="color: #660066;">applyBindings</span><span style="color: #009900;">(</span>viewModel<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">}</span>
<span style="color: #009900;">}</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
application.<span style="color: #660066;">navigateTo</span><span style="color: #009900;">(</span><span style="color: #000066; font-weight: bold;">new</span> TwitterSearchViewModel<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span></pre></td></tr></table></div><p>For the above code to work, each view model must expose a <code>template</code> property which identified the HTML template which is their corresponding view. The above code creates a view instance and appends it to the <code>#app</code> element.</p><p>The templates for the two view-models within this application are shown below:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="html" style="font-family: monospace;">&lt;script type=text/x-jquery-tmpl" charset="utf-8" id="twitterSearchView"&gt;
  &lt;div&gt;
    &lt;form data-bind="submit: search"&gt;
        &lt;input data-bind="value: searchTerm, valueUpdate: 'afterkeydown'" /&gt;
        &lt;button type="submit" data-bind="enable: searchTerm().length &gt; 0 &amp;&amp; isSearching() == false"&gt;Go&lt;/button&gt;  
    &lt;/form&gt;
    &lt;ul data-bind="template: {name: 'tweetView', foreach: tweets}"&gt; &lt;/ul&gt;
  &lt;/div&gt;
&lt;/script&gt;
&nbsp;
&lt;script type="text/x-jquery-tmpl" charset="utf-8" id="tweetView"&gt;
  &lt;li class="tweet"
    data-bind="click: select"&gt;
    &lt;div class="thumbnailColumn"&gt;
      &lt;img data-bind="attr: { src: thumbnail }" class="thumbnail"/&gt;
    &lt;/div&gt;
    &lt;div class="detailsColumn"&gt;
      &lt;div class="author" data-bind="text: author"/&gt; 
      &lt;div class="text" data-bind="text: text"/&gt; 
      &lt;div class="time" data-bind="text: time"/&gt; 
    &lt;/div&gt;
  &lt;/li&gt;
&lt;/script&gt;
&nbsp;
&lt;script type="text/x-jquery-tmpl" charset="utf-8" id="tweetDetailView"&gt;
  &lt;div class="tweet"&gt;
    &lt;div class="thumbnailColumn"&gt;
      &lt;img data-bind="attr: { src: thumbnail }" class="thumbnail"/&gt;
    &lt;/div&gt;
    &lt;div class="detailsColumn"&gt;
      &lt;div class="author" data-bind="text: author"/&gt; 
      &lt;div class="text" data-bind="text: text"/&gt; 
      &lt;div class="time" data-bind="text: time"/&gt; 
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/script&gt;
&nbsp;
&lt;h1 id="welcomeMsg"&gt;Twitter Search&lt;/h1&gt;   
&lt;div id="app" /&gt;</pre></td></tr></table></div><p>When a tweet is clicked on, the <code>select </code>function is invoked via the Knockout binding. This simply pushes a <code>TweetViewModel</code> instance onto the application stack:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family: monospace;"><span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">select</span> <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">function</span> <span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
  application.<span style="color: #660066;">navigateTo</span><span style="color: #009900;">(</span><span style="color: #000066; font-weight: bold;">this</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></td></tr></table></div><h2>Handling the Back-Button</h2><p>The above code navigates to the given view model, this will cause the <code>currentViewModel</code> dependent observable to notify that a change has occurred and the view that relates to this view model will be rendered. The next step is to wire up the back-button.</p><p>The <code>ApplicationViewModel</code> has a boolean <code>backButtonRequired</code> dependent observable that indicates whether the JavaScript code needs to handle the back-button. This is true whenever there is more than one item in the back-stack:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family: monospace;"><span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">backButtonRequired</span> <span style="color: #339933;">=</span> ko.<span style="color: #660066;">dependentObservable</span><span style="color: #009900;">(</span><span style="color: #000066; font-weight: bold;">function</span> <span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>    
  <span style="color: #000066; font-weight: bold;">return</span> <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">viewModelBackStack</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span>.<span style="color: #660066;">length</span> <span style="color: #339933;">&gt;</span> <span style="color: #CC0000;">1</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span><span style="color: #339933;">,</span> <span style="color: #000066; font-weight: bold;">this</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span></pre></td></tr></table></div><p>When the application is initially created, we handle changes to the observable as follows:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family: monospace;">application.<span style="color: #660066;">backButtonRequired</span>.<span style="color: #660066;">subscribe</span><span style="color: #009900;">(</span><span style="color: #000066; font-weight: bold;">function</span> <span style="color: #009900;">(</span>backButtonRequired<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
  <span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">(</span>backButtonRequired<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
    document.<span style="color: #660066;">addEventListener</span><span style="color: #009900;">(</span><span style="color: #3366CC;">"backbutton"</span><span style="color: #339933;">,</span> onBackButton<span style="color: #339933;">,</span> <span style="color: #003366; font-weight: bold;">false</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">}</span> <span style="color: #000066; font-weight: bold;">else</span> <span style="color: #009900;">{</span>
    document.<span style="color: #660066;">removeEventListener</span><span style="color: #009900;">(</span><span style="color: #3366CC;">"backbutton"</span><span style="color: #339933;">,</span> onBackButton<span style="color: #339933;">,</span> <span style="color: #003366; font-weight: bold;">false</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">}</span>
<span style="color: #009900;">}</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #000066; font-weight: bold;">function</span> onBackButton<span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
  application.<span style="color: #660066;">back</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td></tr></table></div><p>And that’s it! When the JavaScript back-stack has more than one item, the PhoneGap <code>backbutton</code> event is handled and the <code>back</code> function invoked on our application, popping the top item from the stack, with the view updating accordingly. When our JavaScript back-stack has a single item, we no longer handle the PhoneGap <code>backbutton</code> event, this results in the Silverlight container handling the back-button. The Silverlight application back-stack always has a single page, so our application will exit.</p><p>This technique for handling the back-stack is simple and elegant, this example has just two simple pages, however this same pattern should scale well for more complex HTML5 applications.</p><p>You can download the full sourcecode here: <a href="{{ site.url }}/blog/colin/wp-content/uploads/2011/11/PhoneGapBackStack.zip">PhoneGapBackStack.zip</a></p><p>Regards, Colin E.</p></div>