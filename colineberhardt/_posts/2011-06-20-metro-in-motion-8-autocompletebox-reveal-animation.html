---
author: Colin Eberhardt
tags: codeproject, metro, windows ph
permalink: /blog/colin/2011/06/metro-in-motion-8-autocompletebox-reveal-animation/index.html
layout: colineberhardt-blog
---
<div class="entry"><div class="topsy_widget_data topsy_theme_light-green" style="float: right; margin-left: 0.75em; background: url(data:,%7B%20%22url%22%3A%20%22http%253A%252F%252Fwww.scottlogic.co.uk%252Fblog%252Fcolin%252F2011%252F06%252Fmetro-in-motion-8-autocompletebox-reveal-animation%252F%22%2C%20%22style%22%3A%20%22big%22%2C%20%22title%22%3A%20%22Metro%20In%20Motion%20%238%20-%20AutoCompleteBox%20Reveal%20Animation%20%23%22%20%7D);"></div><p>When I started the Metro In Motion series, I thought I would probably post three or four articles and be done. However, every time I use my Windows Phone 7 I seem to spot a new ‘native’ fluid UI effect which I would like to use in my own code. Also, these posts have proven very popular, there appears to be a real developer ‘need’ for this sort of information.</p><p>In this instalment of Metro In Motion I will show how to implement the fluid auto-complete effect that can be seen in the Windows Phone 7 email client. You can see a ‘storyboard’ for this effect below; the items within the auto-complete popup slide gracefully into view when the popup initially renders:</p><p><a href="{{ site.url }}/blog/colin/wp-content/uploads/2011/06/AutoCompleteSlide.png"><img src="http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2011/06/AutoCompleteSlide.png" alt="" title="AutoCompleteSlide" width="650" height="172" class="aligncenter size-full wp-image-1555" /></a></p><p>This effect uses the <code>AutoCompleteBox</code> which is part of the <a href="http://silverlight.codeplex.com/releases/view/60291">Silverlight for Windows Phone Toolkit</a>. I have implemented this effect as a Blend Behaviour, allowing it to be easily added to an AutoCompleteBox either via drag and drop within Expression Blend, or by simply adding the XAML below:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="xml" style="font-family: monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;tk:AutoCompleteBox</span> <span style="color: #000066;">VerticalAlignment</span>=<span style="color: #ff0000;">"Top"</span></span>
<span style="color: #009900;">                    <span style="color: #000066;">ItemsSource</span>=<span style="color: #ff0000;">"{Binding}"</span></span>
<span style="color: #009900;">                    <span style="color: #000066;">ValueMemberPath</span>=<span style="color: #ff0000;">"Surname"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
  <span style="color: #808080; font-style: italic;">&lt;!-- add the metro in motion effect --&gt;</span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;i:Interaction.Behaviors<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;behaviour:AutoCompleteSlideBehaviour</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/i:Interaction.Behaviors<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/tk:AutoCompleteBox<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre></td></tr></table></div><p>Let’s take a look at how this behaviour is implemented …</p><p>In order for this effect to work, we need to handle the <code>Opening</code> event raised by the <code>Popup</code> control that is part of the <code>AutoCompleteBox</code> template. When this event fires, each of the elements within the <code>ListBox</code> that the <code>Popup</code> contains are animated. The first task is to locate the <code>ListBox</code> and the <code>Popup</code>, this is performed when the behaviour is attached:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">protected</span> <span style="color: #0600FF; font-weight: bold;">override</span> <span style="color: #6666cc; font-weight: bold;">void</span> OnAttached<span style="color: #008000;">(</span><span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
  <span style="color: #0600FF; font-weight: bold;">base</span><span style="color: #008000;">.</span><span style="color: #0000FF;">OnAttached</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #008080; font-style: italic;">// locate the listBox, if this fails, the AutoCOmpleteBox is not loaded,</span>
  <span style="color: #008080; font-style: italic;">// so try again after the Loaded event.</span>
  <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span><span style="color: #008000;">!</span>TryFindListBox<span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">)</span>
  <span style="color: #008000;">{</span>
    RoutedEventHandler onLoaded <span style="color: #008000;">=</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">;</span>
    onLoaded <span style="color: #008000;">=</span> <span style="color: #008000;">(</span>s, e<span style="color: #008000;">)</span> <span style="color: #008000;">=&gt;</span>
        <span style="color: #008000;">{</span>
          TryFindListBox<span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
          AssociatedObject<span style="color: #008000;">.</span><span style="color: #0000FF;">Loaded</span> <span style="color: #008000;">-=</span> onLoaded<span style="color: #008000;">;</span>
        <span style="color: #008000;">}</span><span style="color: #008000;">;</span>
    AssociatedObject<span style="color: #008000;">.</span><span style="color: #0000FF;">Loaded</span> <span style="color: #008000;">+=</span> onLoaded<span style="color: #008000;">;</span>
  <span style="color: #008000;">}</span>
<span style="color: #008000;">}</span>
&nbsp;
<span style="color: #008080; font-style: italic;">/// &lt;summary&gt;</span>
<span style="color: #008080; font-style: italic;">/// Tries to locate the Listbox within the auto-completes Popup.</span>
<span style="color: #008080; font-style: italic;">/// &lt;/summary&gt;</span>
<span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">bool</span> TryFindListBox<span style="color: #008000;">(</span><span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
  <span style="color: #008080; font-style: italic;">// locate the auto-complete  popup</span>
  _popup <span style="color: #008000;">=</span> AssociatedObject<span style="color: #008000;">.</span><span style="color: #0000FF;">Descendants</span><span style="color: #008000;">&lt;</span>Popup<span style="color: #008000;">&gt;</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">.</span><span style="color: #0000FF;">SingleOrDefault</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span> <span style="color: #0600FF; font-weight: bold;">as</span> Popup<span style="color: #008000;">;</span>
  <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>_popup <span style="color: #008000;">==</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">)</span>
    <span style="color: #0600FF; font-weight: bold;">return</span> <span style="color: #0600FF; font-weight: bold;">false</span><span style="color: #008000;">;</span>
&nbsp;
  _popup<span style="color: #008000;">.</span><span style="color: #0000FF;">Opened</span> <span style="color: #008000;">+=</span> Popup_Opened<span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #008080; font-style: italic;">// locate the ListBox</span>
  _popUpListbox <span style="color: #008000;">=</span> _popup<span style="color: #008000;">.</span><span style="color: #0000FF;">Child</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Descendants</span><span style="color: #008000;">&lt;</span>ListBox<span style="color: #008000;">&gt;</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">.</span><span style="color: #0000FF;">SingleOrDefault</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span> <span style="color: #0600FF; font-weight: bold;">as</span> ListBox<span style="color: #008000;">;</span>
  <span style="color: #0600FF; font-weight: bold;">return</span> <span style="color: #0600FF; font-weight: bold;">true</span><span style="color: #008000;">;</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>The above code uses some simple <a href="{{ site.url }}/blog/colin/2010/03/linq-to-visual-tree/">Linq-to-VisualTree</a> to locate these elements. Notice that the approach taken first tries to locate these elements, if this fails, the <code>Loaded</code> event is handled, which is fired when elements (and their template components) are added to the visual tree.</p><p>The animation is fired each time the <code>Popup</code> is opened. Creating the animation itself is quite simple, the items within the <code>ListBox</code> are iterated over, with a <code>TranslateTransform</code> created for each, with delayed <code>Storyboard</code> animations used to fire the animations sequentially. However, the container’s (i.e. <code>ListBoxItem</code> instances) may not have been created when the <code>Opened</code> event fires. In order to handle this, the code below checks for the container of the item at the first index. If this container has not yet been generated, the code which creates the animations is deferred until after the next <code>LayoutUpdated</code> event. This should ensure that the containers are now present. The code is shown below:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #008080; font-style: italic;">/// &lt;summary&gt;</span>
<span style="color: #008080; font-style: italic;">/// Handle the Opened even on the Popup in order to animate the contents</span>
<span style="color: #008080; font-style: italic;">/// &lt;/summary&gt;</span>
<span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">void</span> Popup_Opened<span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">object</span> sender, <span style="color: #000000;">System</span><span style="color: #008000;">.</span><span style="color: #0000FF;">EventArgs</span> e<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
  <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>_popUpListbox<span style="color: #008000;">.</span><span style="color: #0000FF;">Items</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Count</span> <span style="color: #008000;">==</span> <span style="color: #FF0000;">0</span><span style="color: #008000;">)</span>
    <span style="color: #0600FF; font-weight: bold;">return</span><span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #008080; font-style: italic;">// an action which fires the required animation for each element</span>
  Action fireAnimations <span style="color: #008000;">=</span> <span style="color: #008000;">(</span><span style="color: #008000;">)</span> <span style="color: #008000;">=&gt;</span>
  <span style="color: #008000;">{</span>
    <span style="color: #008080; font-style: italic;">// locate all the ListBoxItems</span>
    <span style="color: #0600FF; font-weight: bold;">var</span> itemContainers <span style="color: #008000;">=</span> _popUpListbox<span style="color: #008000;">.</span><span style="color: #0000FF;">Items</span>
        <span style="color: #008000;">.</span><span style="color: #0600FF; font-weight: bold;">Select</span><span style="color: #008000;">(</span>i <span style="color: #008000;">=&gt;</span> _popUpListbox<span style="color: #008000;">.</span><span style="color: #0000FF;">ItemContainerGenerator</span><span style="color: #008000;">.</span><span style="color: #0000FF;">ContainerFromItem</span><span style="color: #008000;">(</span>i<span style="color: #008000;">)</span><span style="color: #008000;">)</span>
        <span style="color: #008000;">.</span><span style="color: #0600FF; font-weight: bold;">Where</span><span style="color: #008000;">(</span>i <span style="color: #008000;">=&gt;</span> i <span style="color: #008000;">!=</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">)</span>
        <span style="color: #008000;">.</span><span style="color: #0000FF;">Cast</span><span style="color: #008000;">&lt;</span>ListBoxItem<span style="color: #008000;">&gt;</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
    <span style="color: #008080; font-style: italic;">// animate each item</span>
    <span style="color: #6666cc; font-weight: bold;">double</span> startTime <span style="color: #008000;">=</span> <span style="color: #FF0000;">0</span><span style="color: #008000;">;</span>
    <span style="color: #0600FF; font-weight: bold;">foreach</span> <span style="color: #008000;">(</span><span style="color: #0600FF; font-weight: bold;">var</span> listBoxItem <span style="color: #0600FF; font-weight: bold;">in</span> itemContainers<span style="color: #008000;">)</span>
    <span style="color: #008000;">{</span>
      <span style="color: #008080; font-style: italic;">// add a render transform that offsets the element</span>
      <span style="color: #0600FF; font-weight: bold;">var</span> trans <span style="color: #008000;">=</span> <span style="color: #008000;">new</span> TranslateTransform<span style="color: #008000;">(</span><span style="color: #008000;">)</span>
          <span style="color: #008000;">{</span>
            Y <span style="color: #008000;">=</span> <span style="color: #008000;">-</span><span style="color: #FF0000;">50</span>
          <span style="color: #008000;">}</span><span style="color: #008000;">;</span>
      listBoxItem<span style="color: #008000;">.</span><span style="color: #0000FF;">RenderTransform</span> <span style="color: #008000;">=</span> trans<span style="color: #008000;">;</span>
      listBoxItem<span style="color: #008000;">.</span><span style="color: #0000FF;">Opacity</span> <span style="color: #008000;">=</span> <span style="color: #FF0000;">0.0</span><span style="color: #008000;">;</span>
&nbsp;
      <span style="color: #0600FF; font-weight: bold;">var</span> sb <span style="color: #008000;">=</span> <span style="color: #008000;">new</span> Storyboard<span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
      sb<span style="color: #008000;">.</span><span style="color: #0000FF;">BeginTime</span> <span style="color: #008000;">=</span> TimeSpan<span style="color: #008000;">.</span><span style="color: #0000FF;">FromMilliseconds</span><span style="color: #008000;">(</span>startTime<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
      sb<span style="color: #008000;">.</span><span style="color: #0000FF;">Children</span><span style="color: #008000;">.</span><span style="color: #0600FF; font-weight: bold;">Add</span><span style="color: #008000;">(</span>TiltBehaviour<span style="color: #008000;">.</span><span style="color: #0000FF;">CreateAnimation</span><span style="color: #008000;">(</span><span style="color: #0600FF; font-weight: bold;">null</span>, <span style="color: #FF0000;">0</span>, <span style="color: #FF0000;">0.2</span>, <span style="color: #666666;">"Y"</span>, trans<span style="color: #008000;">)</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
      sb<span style="color: #008000;">.</span><span style="color: #0000FF;">Children</span><span style="color: #008000;">.</span><span style="color: #0600FF; font-weight: bold;">Add</span><span style="color: #008000;">(</span>TiltBehaviour<span style="color: #008000;">.</span><span style="color: #0000FF;">CreateAnimation</span><span style="color: #008000;">(</span><span style="color: #0600FF; font-weight: bold;">null</span>, <span style="color: #FF0000;">1</span>, <span style="color: #FF0000;">0.5</span>, <span style="color: #666666;">"Opacity"</span>, listBoxItem<span style="color: #008000;">)</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
      sb<span style="color: #008000;">.</span><span style="color: #0000FF;">Begin</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
      startTime <span style="color: #008000;">+=</span> <span style="color: #FF0000;">100</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">}</span>
  <span style="color: #008000;">}</span><span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #008080; font-style: italic;">// check if the item container for the first item has been generated</span>
  <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>_popUpListbox<span style="color: #008000;">.</span><span style="color: #0000FF;">ItemContainerGenerator</span><span style="color: #008000;">.</span><span style="color: #0000FF;">ContainerFromIndex</span><span style="color: #008000;">(</span><span style="color: #FF0000;">0</span><span style="color: #008000;">)</span> <span style="color: #008000;">==</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">)</span>
  <span style="color: #008000;">{</span>
    <span style="color: #008080; font-style: italic;">// if not, wait for the next LayoutUpdated event</span>
    EventHandler updateHandler <span style="color: #008000;">=</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">;</span>
    updateHandler <span style="color: #008000;">=</span> <span style="color: #008000;">(</span>s, e2<span style="color: #008000;">)</span> <span style="color: #008000;">=&gt;</span>
    <span style="color: #008000;">{</span>
      fireAnimations<span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
      _popUpListbox<span style="color: #008000;">.</span><span style="color: #0000FF;">LayoutUpdated</span> <span style="color: #008000;">-=</span> updateHandler<span style="color: #008000;">;</span>
    <span style="color: #008000;">}</span><span style="color: #008000;">;</span>
    _popUpListbox<span style="color: #008000;">.</span><span style="color: #0000FF;">LayoutUpdated</span> <span style="color: #008000;">+=</span> updateHandler<span style="color: #008000;">;</span>
  <span style="color: #008000;">}</span>
  <span style="color: #0600FF; font-weight: bold;">else</span>
  <span style="color: #008000;">{</span>
    <span style="color: #008080; font-style: italic;">// otherwise, fire the animations now</span>
    fireAnimations<span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
  <span style="color: #008000;">}</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>The full sourcecode for this behaviour can be found in the <a href="http://wp7contrib.codeplex.com/">WP7Contrib project</a>, within the <code>WP7Contrib.View.Controls</code> assembly.</p><p>You can download a simple working example here: <a href="{{ site.url }}/blog/colin/wp-content/uploads/2011/06/MetroInMotionEight.zip">MetroInMotionEight.zip</a></p><p>I have of course updated the Sandwich Flow, Metro In Motion demo application to include this effect. Again, this is available via the <a href="http://wp7contrib.codeplex.com/">WP7Contrib project</a>:</p><p><iframe width="640" height="510" src="http://www.youtube.com/embed/TtVWLxDDhiE" frameborder="0" allowfullscreen="allowfullscreen"></iframe></p><p>Regards,<br />
Colin E.</p></div>