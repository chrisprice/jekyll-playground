---
author: Colin Eberhardt
tags: validation, WPF
permalink: /blog/colin/2008/11/using-bindinggroups-for-greater-control-over-input-validation/index.html
layout: colineberhardt-blog
---
<div class="entry"><div class="topsy_widget_data topsy_theme_light-green" style="float: right; margin-left: 0.75em; background: url(data:,%7B%20%22url%22%3A%20%22http%253A%252F%252Fwww.scottlogic.co.uk%252Fblog%252Fcolin%252F2008%252F11%252Fusing-bindinggroups-for-greater-control-over-input-validation%252F%22%2C%20%22style%22%3A%20%22big%22%2C%20%22title%22%3A%20%22Using%20BindingGroups%20for%20greater%20control%20over%20input%20validation%20%23%22%20%7D);"></div><p>In a recent post on his blog Josh Smith described a technique for providing more meaningful error messages when the type conversion process fails within the binding framework. Consider the following problem; you bind an integer property of your object (Age for example) to a TextBox within your user interface. If the user enters a non-numeric value into the TextBox an exception is thrown within the binding framework when it attempts to parse this value. The framework provide s a way of catching validation exceptions, by setting ValidatesOnExceptions to true within a binding, however the error message provided is “Input string was not in a correct format.” – this is the sort of error message that a software engineer would understand, but not the majority of the population!</p><p><a href="http://wpfadventures.files.wordpress.com/2008/11/standardvalidation.png"><img class="alignnone size-full wp-image-32" title="standardvalidation" src="http://wpfadventures.files.wordpress.com/2008/11/standardvalidation.png" alt="standardvalidation" width="314" height="159" /></a></p><p>Josh details a technique that can be used to provide <a href="http://joshsmithonwpf.wordpress.com/2008/11/14/using-a-viewmodel-to-provide-meaningful-validation-error-messages/">more meaningful error messages</a>. His technique uses a View-Model (the classes which massage your data into a form which is more amenable to your presentation technology), which binds a text ‘Age’ property to ensure that there are no type conversions issues in the binding, allowing the issue of parsing errors to be managed directly. This blog post illustrates an alternative technique to his approach, using the recently introduced feature of BindingGroups.</p><p>Take for example a very simple example, a Person class which has properties of Name and Age. This class implements IDataErrorInfo, allowing us to manage validation logic within the business objects themselves. This class has a pair of simple rules which are applied to the Age property.</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">class</span> Person <span style="color: #008000;">:</span> IDataErrorInfo, INotifyPropertyChanged
<span style="color: #008000;">{</span>
    <span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">int</span> age<span style="color: #008000;">;</span>
    <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">int</span> Age
    <span style="color: #008000;">{</span>
        <span style="color: #0600FF; font-weight: bold;">get</span> <span style="color: #008000;">{</span> <span style="color: #0600FF; font-weight: bold;">return</span> age<span style="color: #008000;">;</span> <span style="color: #008000;">}</span>
        <span style="color: #0600FF; font-weight: bold;">set</span> <span style="color: #008000;">{</span>
            age <span style="color: #008000;">=</span> <span style="color: #0600FF; font-weight: bold;">value</span><span style="color: #008000;">;</span>
            RaisePropertyChanged<span style="color: #008000;">(</span><span style="color: #666666;">"Age"</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
        <span style="color: #008000;">}</span>
    <span style="color: #008000;">}</span>
&nbsp;
    <span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">string</span> name<span style="color: #008000;">;</span>
    <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">string</span> Name
    <span style="color: #008000;">{</span>
        <span style="color: #0600FF; font-weight: bold;">get</span> <span style="color: #008000;">{</span> <span style="color: #0600FF; font-weight: bold;">return</span> name<span style="color: #008000;">;</span> <span style="color: #008000;">}</span>
        <span style="color: #0600FF; font-weight: bold;">set</span> <span style="color: #008000;">{</span>
            name <span style="color: #008000;">=</span> <span style="color: #0600FF; font-weight: bold;">value</span><span style="color: #008000;">;</span>
            RaisePropertyChanged<span style="color: #008000;">(</span><span style="color: #666666;">"Name"</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
        <span style="color: #008000;">}</span>
    <span style="color: #008000;">}</span>
&nbsp;
    <span style="color: #008080;">#region IDataErrorInfo Members</span>
    <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">string</span> Error
    <span style="color: #008000;">{</span>
        <span style="color: #0600FF; font-weight: bold;">get</span> <span style="color: #008000;">{</span> <span style="color: #0600FF; font-weight: bold;">return</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">;</span> <span style="color: #008000;">}</span>
    <span style="color: #008000;">}</span>
&nbsp;
    <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">string</span> <span style="color: #0600FF; font-weight: bold;">this</span><span style="color: #008000;">[</span><span style="color: #6666cc; font-weight: bold;">string</span> columnName<span style="color: #008000;">]</span>
    <span style="color: #008000;">{</span>
        <span style="color: #0600FF; font-weight: bold;">get</span> <span style="color: #008000;">{</span>
            <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>columnName <span style="color: #008000;">==</span> <span style="color: #666666;">"Age"</span><span style="color: #008000;">)</span>
            <span style="color: #008000;">{</span>
                <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>Age <span style="color: #008000;">&lt;</span> <span style="color: #FF0000;">0</span><span style="color: #008000;">)</span>
                    <span style="color: #0600FF; font-weight: bold;">return</span> <span style="color: #666666;">"Age cannot be less than 0."</span><span style="color: #008000;">;</span>
                <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>Age <span style="color: #008000;">&gt;</span> <span style="color: #FF0000;">120</span><span style="color: #008000;">)</span>
                    <span style="color: #0600FF; font-weight: bold;">return</span> <span style="color: #666666;">"Age cannot be greater than 120."</span><span style="color: #008000;">;</span>
            <span style="color: #008000;">}</span>
            <span style="color: #0600FF; font-weight: bold;">return</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">;</span>
        <span style="color: #008000;">}</span>
    <span style="color: #008000;">}</span>
    <span style="color: #008080;">#endregion</span>
&nbsp;
    <span style="color: #008080;">#region INotifyPropertyChanged Members</span>
    <span style="color: #008000;">...</span>
    <span style="color: #008080;">#endregion</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>An instance of the above class is displayed in a simple form using the following XAML:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="xml" style="font-family: monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Grid</span> <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"RootElement"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Grid.BindingGroup<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;BindingGroup<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;BindingGroup.ValidationRules<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;local:PersonValidationRule</span></span>
<span style="color: #009900;">          <span style="color: #000066;">ValidationStep</span>=<span style="color: #ff0000;">"ConvertedProposedValue"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/BindingGroup.ValidationRules<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/BindingGroup<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Grid.BindingGroup<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
&nbsp;
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Grid.ColumnDefinitions<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;ColumnDefinition</span> <span style="color: #000066;">Width</span>=<span style="color: #ff0000;">"*"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;ColumnDefinition</span> <span style="color: #000066;">Width</span>=<span style="color: #ff0000;">"1.8*"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Grid.ColumnDefinitions<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
&nbsp;
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Grid.RowDefinitions<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;RowDefinition</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;RowDefinition</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;RowDefinition</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Grid.RowDefinitions<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
&nbsp;
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Label</span> <span style="color: #000066;">Content</span>=<span style="color: #ff0000;">"Name:"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;TextBox</span> <span style="color: #000066;">Grid.Column</span>=<span style="color: #ff0000;">"1"</span> <span style="color: #000066;">LostFocus</span>=<span style="color: #ff0000;">"TextBox_LostFocus"</span></span>
<span style="color: #009900;">       <span style="color: #000066;">Text</span>=<span style="color: #ff0000;">"{Binding Name, ValidatesOnDataErrors=true}"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
&nbsp;
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Label</span> <span style="color: #000066;">Grid.Row</span>=<span style="color: #ff0000;">"1"</span> <span style="color: #000066;">Content</span>=<span style="color: #ff0000;">"Age:"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;TextBox</span> <span style="color: #000066;">Grid.Row</span>=<span style="color: #ff0000;">"1"</span> <span style="color: #000066;">Grid.Column</span>=<span style="color: #ff0000;">"1"</span> <span style="color: #000066;">LostFocus</span>=<span style="color: #ff0000;">"TextBox_LostFocus"</span></span>
<span style="color: #009900;">       <span style="color: #000066;">Text</span>=<span style="color: #ff0000;">"{Binding Age, ValidatesOnDataErrors=true}"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
&nbsp;
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Label</span> <span style="color: #000066;">Grid.Row</span>=<span style="color: #ff0000;">"2"</span> <span style="color: #000066;">Grid.ColumnSpan</span>=<span style="color: #ff0000;">"2"</span> <span style="color: #000066;">Foreground</span>=<span style="color: #ff0000;">"Red"</span></span>
<span style="color: #009900;">       <span style="color: #000066;">Content</span>=<span style="color: #ff0000;">"{Binding Path=(Validation.Errors)[0].ErrorContent,</span>
<span style="color: #009900;">               ElementName=RootElement}"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
&nbsp;
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Grid<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre></td></tr></table></div><p>The TextBox bindings use ValidatesOnDataErrors, this ensures that the IDataErrorInfo interface methods on the Person class will be invoked, enforcing our Age rules. However, they do not handle exceptions thrown in the binding process, i.e. ValidatesOnExceptions is absent.</p><p>The interesting part of the above code is the BindingGroup which is present in the Grid element, i.e. at the ‘Form’ level. When you define a BindingGroup it is related to the DataContext of the element that it is defined against. The BindingGroup will then have access to all the other Bindings which relate to this DataContext. In the above example, the bindings inherit the Grid’s DataContext and are members of the same BindingGroup.</p><p>BindingGroups allow group level validation, this is useful for example if you have validation rules which relate to more than one property, for example “StartDate </p><p>In the above example, we do not have complex validation logic, so why use a BindingGroup?</p><p>When a ValidationRule is associated with a BindingGroup it has access to both the BindingExpressions, i.e. the “Name” and “Age” bindings in our example, and the BindingGroup instance itself. This class has some very useful methods like <a href="http://msdn.microsoft.com/en-us/library/system.windows.data.bindinggroup.trygetvalue.aspx">TryGetValue</a>, which will attempt to get the bound value from the TextBox (or other bound UI control). However, the interesting part is that you can determine at what point in the binding pipeline your validation rule is applied, which will in turn determine whether you get back the raw value from the control, for example the string “34″, or the value after it has been parsed, i.e., an integer ’34′.</p><p>When BindingGroup was added to the API in .NET 3.5 SP1, the ValidationRule class was extended to add a ValidationStep property. This enumeration indicates at what stage within the binding pipeline a particular rule is invoked. The four possible enumeration values are <a href="http://msdn.microsoft.com/en-us/library/system.windows.controls.validationstep.aspx">detailed on MSDN</a>. The one which we are interested in here is ConvertedProposedValue, which will mean that our rule is invoked after the binding framework has parsed the input string to an integer.</p><p>Here is our validation rule:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">class</span> PersonValidationRule <span style="color: #008000;">:</span> ValidationRule
<span style="color: #008000;">{</span>
    <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #0600FF; font-weight: bold;">override</span> ValidationResult Validate<span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">object</span> <span style="color: #0600FF; font-weight: bold;">value</span>,
                                             CultureInfo cultureInfo<span style="color: #008000;">)</span>
    <span style="color: #008000;">{</span>
        BindingGroup bindingGroup <span style="color: #008000;">=</span> <span style="color: #008000;">(</span>BindingGroup<span style="color: #008000;">)</span><span style="color: #0600FF; font-weight: bold;">value</span><span style="color: #008000;">;</span>
        Person person <span style="color: #008000;">=</span> <span style="color: #008000;">(</span>Person<span style="color: #008000;">)</span>bindingGroup<span style="color: #008000;">.</span><span style="color: #0000FF;">Items</span><span style="color: #008000;">[</span><span style="color: #FF0000;">0</span><span style="color: #008000;">]</span><span style="color: #008000;">;</span>
&nbsp;
        <span style="color: #008080; font-style: italic;">// validate the age</span>
        <span style="color: #6666cc; font-weight: bold;">object</span> objValue <span style="color: #008000;">=</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">;</span>
        <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span><span style="color: #008000;">!</span>bindingGroup<span style="color: #008000;">.</span><span style="color: #0000FF;">TryGetValue</span><span style="color: #008000;">(</span>person, <span style="color: #666666;">"Age"</span>, <span style="color: #0600FF; font-weight: bold;">out</span> objValue<span style="color: #008000;">)</span><span style="color: #008000;">)</span>
        <span style="color: #008000;">{</span>
            <span style="color: #0600FF; font-weight: bold;">return</span> <span style="color: #008000;">new</span> ValidationResult<span style="color: #008000;">(</span><span style="color: #0600FF; font-weight: bold;">false</span>, <span style="color: #666666;">"Age is not a whole number"</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
        <span style="color: #008000;">}</span>
&nbsp;
        <span style="color: #008080; font-style: italic;">// if we can retrieve the value - can we parse it to an int?</span>
        <span style="color: #6666cc; font-weight: bold;">int</span> parseResult<span style="color: #008000;">;</span>
        <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span><span style="color: #008000;">!</span>Int32<span style="color: #008000;">.</span><span style="color: #0000FF;">TryParse</span><span style="color: #008000;">(</span>objValue <span style="color: #0600FF; font-weight: bold;">as</span> <span style="color: #6666cc; font-weight: bold;">string</span>, <span style="color: #0600FF; font-weight: bold;">out</span> parseResult<span style="color: #008000;">)</span><span style="color: #008000;">)</span>
        <span style="color: #008000;">{</span>
            <span style="color: #0600FF; font-weight: bold;">return</span> <span style="color: #008000;">new</span> ValidationResult<span style="color: #008000;">(</span><span style="color: #0600FF; font-weight: bold;">false</span>,
                            <span style="color: #6666cc; font-weight: bold;">string</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Format</span><span style="color: #008000;">(</span><span style="color: #666666;">"Age is not a whole number"</span><span style="color: #008000;">)</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
        <span style="color: #008000;">}</span>
&nbsp;
        <span style="color: #0600FF; font-weight: bold;">return</span> ValidationResult<span style="color: #008000;">.</span><span style="color: #0000FF;">ValidResult</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">}</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>In the above code we ask the BindingGroup to provide its proposed value for the Age property. If the user has input a non-numeric value, TryParse will fail. We can then catch this failure and provide a suitable error message.</p><p>The final piece of the puzzle is dictating when this BindingGroup runs its associated rules. One of the primary purposes of the bindingGroup is to allow transactional editing of objects, for example within the WPF DataGrid it is used to commit a Row as a ‘atom’. We must manually commit this BindingGroup in order to run our rule, a ‘Submit’ button could be added to our form, but for simplicity in this example I simply commit as each TextBox loses focus:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">void</span> TextBox_LostFocus<span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">object</span> sender, RoutedEventArgs e<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
    RootElement<span style="color: #008000;">.</span><span style="color: #0000FF;">BindingGroup</span><span style="color: #008000;">.</span><span style="color: #0000FF;">CommitEdit</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>When using BindingGroups we can still of course validate each Binding independently, our ValidatesOnDataErrors still works.</p><p>The finished result is shown below, the screenshot on the right shows how our rule within the BindingGroup catches the case where the string cannot be parsed, and on the left where our Age rule enforced via IDataErrorInfo is violated.</p><p><a href="http://wpfadventures.files.wordpress.com/2008/11/bindinggroupvalidation.png"><img class="alignnone size-full wp-image-33" title="bindinggroupvalidation" src="http://wpfadventures.files.wordpress.com/2008/11/bindinggroupvalidation.png" alt="bindinggroupvalidation" width="436" height="140" /></a></p><p>You can download a demo project with all of this code – <a href="http://wpfadventures.files.wordpress.com/2008/11/bindinggroupvalidation1.doc">bindinggroupvalidation</a>, simple change the file extension from .doc to .zip.</p><p>*phew* – I thought I started writing a blog so that I could avoid writing lengthy articles!</p><p>Regards, Colin E.</p></div>