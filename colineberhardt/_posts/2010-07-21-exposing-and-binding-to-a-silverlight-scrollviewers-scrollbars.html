---
author: Colin Eberhardt
tags: attached behaviour, silverlight
permalink: /blog/colin/2010/07/exposing-and-binding-to-a-silverlight-scrollviewer%E2%80%99s-scrollbars/index.html
layout: colineberhardt-blog
---
<div class="entry"><div class="topsy_widget_data topsy_theme_light-green" style="float: right; margin-left: 0.75em; background: url(data:,%7B%20%22url%22%3A%20%22http%253A%252F%252Fwww.scottlogic.co.uk%252Fblog%252Fcolin%252F2010%252F07%252Fexposing-and-binding-to-a-silverlight-scrollviewer%2525e2%252580%252599s-scrollbars%252F%22%2C%20%22style%22%3A%20%22big%22%2C%20%22title%22%3A%20%22Exposing%20and%20Binding%20to%20a%20Silverlight%20ScrollViewer%E2%80%99s%20Scrollbars%20%23%22%20%7D);"></div><p><em>The Silverlight ScrollViewer exposes readonly properties which indicate the current vertical and horizontal scroll offset, and methods for setting the current offset. In this blog post I demonstrate a simple attached behaviour that exposes these offsets as read / write dependency properties allowing them to be bound to.</em></p><p>The Silverlight ScrollViewer is a very useful control, if you have some content that is larger than the space available in your application, just sit it inside a ScrollViewer and it will automatically add vertical or horizontal scrollbars as required. Simple.</p><p>The ScrollViewer exposes readonly properties which indicate the current vertical and horizontal scroll offset. I have been used a ScrollViewer on many occasions without finding this to be an issue, however, recently I was creating an MVVM application which contained a list of items within a ScrollViewer. When the user clicks on an item, they are taken to its ‘details’ page, they then have the option to return to the list. I wanted the list to have the same state when the user returned to it, i.e. the same scroll location. Naturally, with this being an MVVM application, the scroll position belongs on the ViewModel and should be relayed to the View via a binding. However, with the offset properties on the ScrollViewer being readonly, this was not possible. Time to get creative!</p><p>The template of the ScrollViewer contains two ScrollBar instances, one horizontal and one vertical. The basic idea behind my solution is to add an attached behaviour (i.e. an attached property, that on attachment performs some logic on the target element) which walks the visual tree to find these scrollbars exposing their offset values.</p><p>Firstly, we’ll start by defining an attached property called VerticalOffset, which will be used to expose the position of the vertical scrollbar. Dependency property boiler plate code follows:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #0600FF; font-weight: bold;">static</span> <span style="color: #6666cc; font-weight: bold;">class</span> ScrollViewerBinding
<span style="color: #008000;">{</span>
  <span style="color: #008080;">#region VerticalOffset attached property</span>
&nbsp;
  <span style="color: #008080; font-style: italic;">/// &lt;summary&gt;</span>
  <span style="color: #008080; font-style: italic;">/// Gets the vertical offset value</span>
  <span style="color: #008080; font-style: italic;">/// &lt;/summary&gt;</span>
  <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #0600FF; font-weight: bold;">static</span> <span style="color: #6666cc; font-weight: bold;">double</span> GetVerticalOffset<span style="color: #008000;">(</span>DependencyObject depObj<span style="color: #008000;">)</span>
  <span style="color: #008000;">{</span>
    <span style="color: #0600FF; font-weight: bold;">return</span> <span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">double</span><span style="color: #008000;">)</span>depObj<span style="color: #008000;">.</span><span style="color: #0000FF;">GetValue</span><span style="color: #008000;">(</span>VerticalOffsetProperty<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
  <span style="color: #008000;">}</span>
&nbsp;
  <span style="color: #008080; font-style: italic;">/// &lt;summary&gt;</span>
  <span style="color: #008080; font-style: italic;">/// Sets the vertical offset value</span>
  <span style="color: #008080; font-style: italic;">/// &lt;/summary&gt;</span>
  <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #0600FF; font-weight: bold;">static</span> <span style="color: #6666cc; font-weight: bold;">void</span> SetVerticalOffset<span style="color: #008000;">(</span>DependencyObject depObj, <span style="color: #6666cc; font-weight: bold;">double</span> <span style="color: #0600FF; font-weight: bold;">value</span><span style="color: #008000;">)</span>
  <span style="color: #008000;">{</span>
    depObj<span style="color: #008000;">.</span><span style="color: #0000FF;">SetValue</span><span style="color: #008000;">(</span>VerticalOffsetProperty, <span style="color: #0600FF; font-weight: bold;">value</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
  <span style="color: #008000;">}</span>
&nbsp;
  <span style="color: #008080; font-style: italic;">/// &lt;summary&gt;</span>
  <span style="color: #008080; font-style: italic;">/// VerticalOffset attached property</span>
  <span style="color: #008080; font-style: italic;">/// &lt;/summary&gt;</span>
  <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #0600FF; font-weight: bold;">static</span> <span style="color: #0600FF; font-weight: bold;">readonly</span> DependencyProperty VerticalOffsetProperty <span style="color: #008000;">=</span>
      DependencyProperty<span style="color: #008000;">.</span><span style="color: #0000FF;">RegisterAttached</span><span style="color: #008000;">(</span><span style="color: #666666;">"VerticalOffset"</span>, <span style="color: #008000;">typeof</span><span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">double</span><span style="color: #008000;">)</span>,
      <span style="color: #008000;">typeof</span><span style="color: #008000;">(</span>ScrollViewerBinding<span style="color: #008000;">)</span>, <span style="color: #008000;">new</span> PropertyMetadata<span style="color: #008000;">(</span><span style="color: #FF0000;">0.0</span>, OnVerticalOffsetPropertyChanged<span style="color: #008000;">)</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #008080;">#endregion</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>We’ll also define a private attached property of type ScrollBar, which will be used to store a reference to the scrollbar once it has been located within the ScrollViewers visual tree:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #008080; font-style: italic;">/// &lt;summary&gt;</span>
<span style="color: #008080; font-style: italic;">/// An attached property which holds a reference to the vertical scrollbar which</span>
<span style="color: #008080; font-style: italic;">/// is extracted from the visual tree of a ScrollViewer</span>
<span style="color: #008080; font-style: italic;">/// &lt;/summary&gt;</span>
<span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #0600FF; font-weight: bold;">static</span> <span style="color: #0600FF; font-weight: bold;">readonly</span> DependencyProperty VerticalScrollBarProperty <span style="color: #008000;">=</span>
    DependencyProperty<span style="color: #008000;">.</span><span style="color: #0000FF;">RegisterAttached</span><span style="color: #008000;">(</span><span style="color: #666666;">"VerticalScrollBar"</span>, <span style="color: #008000;">typeof</span><span style="color: #008000;">(</span>ScrollBar<span style="color: #008000;">)</span>,
    <span style="color: #008000;">typeof</span><span style="color: #008000;">(</span>ScrollViewerBinding<span style="color: #008000;">)</span>, <span style="color: #008000;">new</span> PropertyMetadata<span style="color: #008000;">(</span><span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">)</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span></pre></td></tr></table></div><p>Because this attached property is private, I haven’t bothered to create CLR property accessors which are only used for convenience.</p><p>The VerticalOffset attached property has a changed event handler. When the property is first attached to a ScrollViewer, this allows us to walk the visual tree constructed from the ScrollViewer’s template and extract the scrollbars. It is this extra logic that adds new functionality to the ScrollViewer which is what makes this an <a href="http://www.codeproject.com/KB/WPF/AttachedBehaviors.aspx">attached behaviour</a>, as opposed to a regular attached property which merely holds state.</p><p>When an attached property is first associated with its target, the visual tree described by the target’s template has not yet been constructed. With WPF, you would typically register for the <a href="http://msdn.microsoft.com/en-us/library/system.windows.frameworkelement.loaded.aspx">Loaded</a> event on the target, and on handling this event walk the visual tree that will have been constructed. However, in Silverlight there is a very subtle difference, apparently <a href="http://blogs.msdn.com/b/silverlight_sdk/archive/2008/10/24/loaded-event-timing-in-silverlight.aspx">the Loaded event is not guaranteed to occur after the template is applied</a>. Oh dear. The only other alternative is to handle the <a href="http://msdn.microsoft.com/en-us/library/system.windows.uielement.layoutupdated.aspx">LayoutUpdated</a> which is fired whenever changes are made to the visual tree. However, there is another complication! The LayoutUpdated event always has a null sender, this might look like a bug, but it is actually <a href="http://connect.microsoft.com/VisualStudio/feedback/details/293803/wpf-layoutupdated-has-sender-always-null">by design</a>. This means that if we handle the LayoutUpdated event on the ScrollViewer element which the property is attached to, the method invoked as the event handler no longer has a reference to the ScrollViewer!</p><p>In order to get around this problem, the attached property changed handler is as follows:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #008080; font-style: italic;">/// &lt;summary&gt;</span>
<span style="color: #008080; font-style: italic;">/// Invoked when the VerticalOffset attached property changes</span>
<span style="color: #008080; font-style: italic;">/// &lt;/summary&gt;</span>
<span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #0600FF; font-weight: bold;">static</span> <span style="color: #6666cc; font-weight: bold;">void</span> OnVerticalOffsetPropertyChanged<span style="color: #008000;">(</span>DependencyObject d,
    DependencyPropertyChangedEventArgs e<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
  ScrollViewer sv <span style="color: #008000;">=</span> d <span style="color: #0600FF; font-weight: bold;">as</span> ScrollViewer<span style="color: #008000;">;</span>
  <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>sv <span style="color: #008000;">!=</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">)</span>
  <span style="color: #008000;">{</span>
    <span style="color: #008080; font-style: italic;">// check whether we have a reference to the vertical scrollbar</span>
    <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>sv<span style="color: #008000;">.</span><span style="color: #0000FF;">GetValue</span><span style="color: #008000;">(</span>VerticalScrollBarProperty<span style="color: #008000;">)</span> <span style="color: #008000;">==</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">)</span>
    <span style="color: #008000;">{</span>
      <span style="color: #008080; font-style: italic;">// if not, handle LayoutUpdated, which will be invoked after the</span>
      <span style="color: #008080; font-style: italic;">// template is applied and extract the scrollbar</span>
      sv<span style="color: #008000;">.</span><span style="color: #0000FF;">LayoutUpdated</span> <span style="color: #008000;">+=</span> <span style="color: #008000;">(</span>s, ev<span style="color: #008000;">)</span> <span style="color: #008000;">=&gt;</span>
        <span style="color: #008000;">{</span>
          <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>sv<span style="color: #008000;">.</span><span style="color: #0000FF;">GetValue</span><span style="color: #008000;">(</span>VerticalScrollBarProperty<span style="color: #008000;">)</span> <span style="color: #008000;">==</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">)</span>
          <span style="color: #008000;">{</span>
            GetScrollBarsForScrollViewer<span style="color: #008000;">(</span>sv<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
          <span style="color: #008000;">}</span>
        <span style="color: #008000;">}</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">}</span>
    <span style="color: #0600FF; font-weight: bold;">else</span>
    <span style="color: #008000;">{</span>
      <span style="color: #008080; font-style: italic;">// update the scrollviewer offset</span>
      sv<span style="color: #008000;">.</span><span style="color: #0000FF;">ScrollToVerticalOffset</span><span style="color: #008000;">(</span><span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">double</span><span style="color: #008000;">)</span>e<span style="color: #008000;">.</span><span style="color: #0000FF;">NewValue</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">}</span>
  <span style="color: #008000;">}</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>Firstly, we check whether we have already got a reference to the scrollbar, if not, we attached a LayoutUpdated event handler. But instead of defining this handler as a method, it is written as an  lambda expression (i.e. an anonymous delegate), so that the ScrollViewer reference is <a href="http://diditwith.net/PermaLink,guid,235646ae-3476-4893-899d-105e4d48c25b.aspx">captured using closure</a>.</p><p>When the LayoutUpdated event is fired the following method is invoked:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #008080; font-style: italic;">/// &lt;summary&gt;</span>
<span style="color: #008080; font-style: italic;">/// Attempts to extract the scrollbars that are within the scrollviewers</span>
<span style="color: #008080; font-style: italic;">/// visual tree. When extracted, event handlers are added to their ValueChanged events.</span>
<span style="color: #008080; font-style: italic;">/// &lt;/summary&gt;</span>
<span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #0600FF; font-weight: bold;">static</span> <span style="color: #6666cc; font-weight: bold;">void</span> GetScrollBarsForScrollViewer<span style="color: #008000;">(</span>ScrollViewer scrollViewer<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
  ScrollBar scroll <span style="color: #008000;">=</span> GetScrollBar<span style="color: #008000;">(</span>scrollViewer, Orientation<span style="color: #008000;">.</span><span style="color: #0000FF;">Vertical</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
  <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>scroll <span style="color: #008000;">!=</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">)</span>
  <span style="color: #008000;">{</span>
    <span style="color: #008080; font-style: italic;">// save a reference to this scrollbar on the attached property</span>
    scrollViewer<span style="color: #008000;">.</span><span style="color: #0000FF;">SetValue</span><span style="color: #008000;">(</span>VerticalScrollBarProperty, scroll<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
    <span style="color: #008080; font-style: italic;">// scroll the scrollviewer</span>
    scrollViewer<span style="color: #008000;">.</span><span style="color: #0000FF;">ScrollToVerticalOffset</span><span style="color: #008000;">(</span>
      ScrollViewerBinding<span style="color: #008000;">.</span><span style="color: #0000FF;">GetVerticalOffset</span><span style="color: #008000;">(</span>scrollViewer<span style="color: #008000;">)</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
&nbsp;
    <span style="color: #008080; font-style: italic;">// handle the changed event to update the exposed VerticalOffset</span>
    scroll<span style="color: #008000;">.</span><span style="color: #0000FF;">ValueChanged</span> <span style="color: #008000;">+=</span> <span style="color: #008000;">(</span>s, e<span style="color: #008000;">)</span> <span style="color: #008000;">=&gt;</span>
      <span style="color: #008000;">{</span>
        SetVerticalOffset<span style="color: #008000;">(</span>scrollViewer, e<span style="color: #008000;">.</span><span style="color: #0000FF;">NewValue</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
      <span style="color: #008000;">}</span><span style="color: #008000;">;</span>
  <span style="color: #008000;">}</span>
<span style="color: #008000;">}</span>
&nbsp;
<span style="color: #008080; font-style: italic;">/// &lt;summary&gt;</span>
<span style="color: #008080; font-style: italic;">/// Searches the descendants of the given element, looking for a scrollbar</span>
<span style="color: #008080; font-style: italic;">/// with the given orientation.</span>
<span style="color: #008080; font-style: italic;">/// &lt;/summary&gt;</span>
<span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #0600FF; font-weight: bold;">static</span> ScrollBar GetScrollBar<span style="color: #008000;">(</span>FrameworkElement fe, Orientation orientation<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
  <span style="color: #0600FF; font-weight: bold;">return</span> fe<span style="color: #008000;">.</span><span style="color: #0000FF;">Descendants</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span>
            <span style="color: #008000;">.</span><span style="color: #0000FF;">OfType</span><span style="color: #008000;">&lt;</span>ScrollBar<span style="color: #008000;">&gt;</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span>
            <span style="color: #008000;">.</span><span style="color: #0600FF; font-weight: bold;">Where</span><span style="color: #008000;">(</span>s <span style="color: #008000;">=&gt;</span> s<span style="color: #008000;">.</span><span style="color: #0000FF;">Orientation</span> <span style="color: #008000;">==</span> orientation<span style="color: #008000;">)</span>
            <span style="color: #008000;">.</span><span style="color: #0000FF;">SingleOrDefault</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>The GetScrollBar method is invoked, which then uses <a href="{{ site.url }}/blog/colin/2010/03/linq-to-visual-tree/">Linq-to-VisualTree</a> to walk the descendants of the ScrollViewer in an attempt  to find scrollbars of a given orientation. If one is found, it is stored in the private attached property. We also subscribe to the events which the scrollbar raises when its value changes, in order to update the VerticalOffsetProperty. Again, a lambda expression is used to capture the ScrollViewer which this scrollbar is associated with, so that we do not have to store a relationship from scrollbar to scrollviewer.</p><p>As an aside, it would have been a bit more elegant to use binding to connect our VerticalScrollOffset to the scrollbar value as follows:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;">scroll<span style="color: #008000;">.</span><span style="color: #0000FF;">SetBinding</span><span style="color: #008000;">(</span>ScrollBar<span style="color: #008000;">.</span><span style="color: #0000FF;">ValueProperty</span>,
  <span style="color: #008000;">new</span> Binding<span style="color: #008000;">(</span><span style="color: #666666;">"(ScrollViewerBinding.VerticalOffset)"</span><span style="color: #008000;">)</span>
  <span style="color: #008000;">{</span>
    Source <span style="color: #008000;">=</span> scrollViewer
  <span style="color: #008000;">}</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span></pre></td></tr></table></div><p>However, it appears that there is a <a href="http://forums.silverlight.net/forums/p/153389/342703.aspx">bug in Silverlight</a> which makes binding to custom attached properties in code behind fail with a critical error. Until this is fixed, we have to take care of the ‘binding’, by handling change events from both properties, manually.</p><p>Using this attached behaviour is as simple as the following:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="xml" style="font-family: monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;ScrollViewer</span> </span>
<span style="color: #009900;">    <span style="color: #000066;">local:ScrollViewerBinding.VerticalOffset</span>=<span style="color: #ff0000;">"{Binding YPosition, Mode=TwoWay}"</span></span>
<span style="color: #009900;">    <span style="color: #000066;">local:ScrollViewerBinding.HorizontalOffset</span>=<span style="color: #ff0000;">"{Binding XPosition, Mode=TwoWay}"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
    <span style="color: #808080; font-style: italic;">&lt;!-- Big content goes here! --&gt;</span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/ScrollViewer<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre></td></tr></table></div><p>The following little demo binds the X &amp; Y offset of the scrollviewer to two CLR properties (with property changed notifications) defined in code behind. These same properties are bound to the text fields below:</p><div id="slPluginHost1"> <object id="SilverlightPlugin1" width="400" height="180" data="data:application/x-silverlight," type="application/x-silverlight-2"><param name="source" value="http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2010/07/ScrollOffsetBinding.xap" /><a href="http://go.microsoft.com/fwlink/?LinkID=124807" style="text-decoration: none;"> <img src="http://go.microsoft.com/fwlink/?LinkId=108181" alt="Get Microsoft Silverlight" style="border-style: none;" /></a></object></div><p>You can download the complete sourcecode for this blog post: <a href="{{ site.url }}/blog/colin/wp-content/uploads/2010/07/ScrollOffsetBinding.zip">ScrollOffsetBinding.zip</a></p><p>Regards, Colin E.</p></div>