---
author: Colin Eberhardt
tags: codeproject, metro, Windows Phone 7, WP7
permalink: /blog/colin/2011/03/metro-in-motion-part-2-peel-animations/index.html
layout: colineberhardt-blog
---
<div class="entry"><div class="topsy_widget_data topsy_theme_light-green" style="float: right; margin-left: 0.75em; background: url(data:,%7B%20%22url%22%3A%20%22http%253A%252F%252Fwww.scottlogic.co.uk%252Fblog%252Fcolin%252F2011%252F03%252Fmetro-in-motion-part-2-peel-animations%252F%22%2C%20%22style%22%3A%20%22big%22%2C%20%22title%22%3A%20%22Metro%20In%20Motion%20Part%20%232%20-%20%27Peel%27%20Animations%20%23%22%20%7D);"></div><p><i>This blog post is part #2 of my Metro In Motion series. In this post I demonstrate how to implement the animated ‘peel’ effect seen when native Windows Phone 7 applications exit.</i></p><p><img src="http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2011/03/peel.jpg" alt="" title="peel" width="603" height="232" class="aligncenter size-full wp-image-1330" /></p><p>In <a href="{{ site.url }}/blog/colin/2011/03/metro-in-motion-fluid-list-animation/">my previous blog post</a> I discussed how the Metro Design Language that heavily influences the Windows Phone 7 style is not just about static graphics, it is also about fluid transitions. In that post I demonstrated a technique for making items within lists slide gracefully as the user moves between pivot pages. The post was pretty popular, so I have decided to turn it into a series, looking at how to implement the various fluid animations that are present in Windows Phone 7 native applications.</p><p>A feature found in most native Windows Phone 7 applications is the ‘peel’ effect where when the application is exited, the various components peel away from the top of the screen to the bottom. You can see my implementation of this effect in action in the video below. You might have to watch it a few times, the animation comes right at the end as is over pretty quickly!</p><p><iframe title="YouTube video player" width="480" height="390" src="http://www.youtube.com/embed/jRYWX_UV9q0?rel=0" frameborder="0" allowfullscreen="allowfullscreen"></iframe></p><p>The implementation of this effect has to be pretty generic – each application user interface is different, and for the peel effect to be useable, it cannot be tightly coupled to a specific UI layout.</p><p>The approach I have come up with is to define an extension method that can be applied to a list of <code>FrameworkElements</code>. This method creates a suitable <code>Storyboard</code> for each element and fires them in order. An Action is invoked when the last animation completes (more on that later!):</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #008080; font-style: italic;">/// &lt;summary&gt;</span>
<span style="color: #008080; font-style: italic;">/// Animates each element in order, creating a 'peel' effect. The supplied action</span>
<span style="color: #008080; font-style: italic;">/// is invoked when the animation ends.</span>
<span style="color: #008080; font-style: italic;">/// &lt;/summary&gt;</span>
<span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #0600FF; font-weight: bold;">static</span> <span style="color: #6666cc; font-weight: bold;">void</span> Peel<span style="color: #008000;">(</span><span style="color: #0600FF; font-weight: bold;">this</span> IEnumerable<span style="color: #008000;">&lt;</span>FrameworkElement<span style="color: #008000;">&gt;</span> elements, Action endAction<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
  <span style="color: #0600FF; font-weight: bold;">var</span> elementList <span style="color: #008000;">=</span> elements<span style="color: #008000;">.</span><span style="color: #0000FF;">ToList</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
  <span style="color: #0600FF; font-weight: bold;">var</span> lastElement <span style="color: #008000;">=</span> elementList<span style="color: #008000;">.</span><span style="color: #0000FF;">Last</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #008080; font-style: italic;">// iterate over all the elements, animating each of them</span>
  <span style="color: #6666cc; font-weight: bold;">double</span> delay <span style="color: #008000;">=</span> <span style="color: #FF0000;">0</span><span style="color: #008000;">;</span>
  <span style="color: #0600FF; font-weight: bold;">foreach</span> <span style="color: #008000;">(</span>FrameworkElement element <span style="color: #0600FF; font-weight: bold;">in</span> elementList<span style="color: #008000;">)</span>
  <span style="color: #008000;">{</span>
    <span style="color: #0600FF; font-weight: bold;">var</span> sb <span style="color: #008000;">=</span> GetPeelAnimation<span style="color: #008000;">(</span>element, delay<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
    <span style="color: #008080; font-style: italic;">// add a Completed event handler to the last element</span>
    <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>element<span style="color: #008000;">.</span><span style="color: #0000FF;">Equals</span><span style="color: #008000;">(</span>lastElement<span style="color: #008000;">)</span><span style="color: #008000;">)</span>
    <span style="color: #008000;">{</span>
      sb<span style="color: #008000;">.</span><span style="color: #0000FF;">Completed</span> <span style="color: #008000;">+=</span> <span style="color: #008000;">(</span>s, e<span style="color: #008000;">)</span> <span style="color: #008000;">=&gt;</span>
        <span style="color: #008000;">{</span>
          endAction<span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
        <span style="color: #008000;">}</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">}</span>
&nbsp;
    sb<span style="color: #008000;">.</span><span style="color: #0000FF;">Begin</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    delay <span style="color: #008000;">+=</span> <span style="color: #FF0000;">50</span><span style="color: #008000;">;</span>
  <span style="color: #008000;">}</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>The peel animation itself works by associating a <code>PlaneProjection</code> with each element and animating its rotation and offset properties:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #008080; font-style: italic;">/// &lt;summary&gt;</span>
<span style="color: #008080; font-style: italic;">/// Creates a PlaneProjection and associates it with the given element, returning</span>
<span style="color: #008080; font-style: italic;">/// a Storyboard which will animate the PlaneProjection to 'peel' the item</span>
<span style="color: #008080; font-style: italic;">/// from the screen.</span>
<span style="color: #008080; font-style: italic;">/// &lt;/summary&gt;</span>
<span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #0600FF; font-weight: bold;">static</span> Storyboard GetPeelAnimation<span style="color: #008000;">(</span>FrameworkElement element, <span style="color: #6666cc; font-weight: bold;">double</span> delay<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
  Storyboard sb<span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #0600FF; font-weight: bold;">var</span> projection <span style="color: #008000;">=</span> <span style="color: #008000;">new</span> PlaneProjection<span style="color: #008000;">(</span><span style="color: #008000;">)</span>
  <span style="color: #008000;">{</span>
    CenterOfRotationX <span style="color: #008000;">=</span> <span style="color: #008000;">-</span><span style="color: #FF0000;">0.1</span>
  <span style="color: #008000;">}</span><span style="color: #008000;">;</span>
  element<span style="color: #008000;">.</span><span style="color: #0000FF;">Projection</span> <span style="color: #008000;">=</span> projection<span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #008080; font-style: italic;">// compute the angle of rotation required to make this element appear</span>
  <span style="color: #008080; font-style: italic;">// at a 90 degree angle at the edge of the screen.</span>
  <span style="color: #0600FF; font-weight: bold;">var</span> width <span style="color: #008000;">=</span> element<span style="color: #008000;">.</span><span style="color: #0000FF;">ActualWidth</span><span style="color: #008000;">;</span>
  <span style="color: #0600FF; font-weight: bold;">var</span> targetAngle <span style="color: #008000;">=</span> Math<span style="color: #008000;">.</span><span style="color: #0000FF;">Atan</span><span style="color: #008000;">(</span><span style="color: #FF0000;">1000</span> <span style="color: #008000;">/</span> <span style="color: #008000;">(</span>width <span style="color: #008000;">/</span> <span style="color: #FF0000;">2</span><span style="color: #008000;">)</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
  targetAngle <span style="color: #008000;">=</span> targetAngle <span style="color: #008000;">*</span> <span style="color: #FF0000;">180</span> <span style="color: #008000;">/</span> Math<span style="color: #008000;">.</span><span style="color: #0000FF;">PI</span><span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #008080; font-style: italic;">// animate the projection</span>
  sb <span style="color: #008000;">=</span> <span style="color: #008000;">new</span> Storyboard<span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
  sb<span style="color: #008000;">.</span><span style="color: #0000FF;">BeginTime</span> <span style="color: #008000;">=</span> TimeSpan<span style="color: #008000;">.</span><span style="color: #0000FF;">FromMilliseconds</span><span style="color: #008000;">(</span>delay<span style="color: #008000;">)</span><span style="color: #008000;">;</span>      
  sb<span style="color: #008000;">.</span><span style="color: #0000FF;">Children</span><span style="color: #008000;">.</span><span style="color: #0600FF; font-weight: bold;">Add</span><span style="color: #008000;">(</span>CreateAnimation<span style="color: #008000;">(</span><span style="color: #FF0000;">0</span>, <span style="color: #008000;">-</span><span style="color: #008000;">(</span><span style="color: #FF0000;">180</span> <span style="color: #008000;">-</span> targetAngle<span style="color: #008000;">)</span>, <span style="color: #FF0000;">0.3</span>, <span style="color: #666666;">"RotationY"</span>, projection<span style="color: #008000;">)</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
  sb<span style="color: #008000;">.</span><span style="color: #0000FF;">Children</span><span style="color: #008000;">.</span><span style="color: #0600FF; font-weight: bold;">Add</span><span style="color: #008000;">(</span>CreateAnimation<span style="color: #008000;">(</span><span style="color: #FF0000;">0</span>, <span style="color: #FF0000;">23</span>, <span style="color: #FF0000;">0.3</span>, <span style="color: #666666;">"RotationZ"</span>, projection<span style="color: #008000;">)</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
  sb<span style="color: #008000;">.</span><span style="color: #0000FF;">Children</span><span style="color: #008000;">.</span><span style="color: #0600FF; font-weight: bold;">Add</span><span style="color: #008000;">(</span>CreateAnimation<span style="color: #008000;">(</span><span style="color: #FF0000;">0</span>, <span style="color: #008000;">-</span><span style="color: #FF0000;">23</span>, <span style="color: #FF0000;">0.3</span>, <span style="color: #666666;">"GlobalOffsetZ"</span>, projection<span style="color: #008000;">)</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>      
  <span style="color: #0600FF; font-weight: bold;">return</span> sb<span style="color: #008000;">;</span>
<span style="color: #008000;">}</span>
&nbsp;
<span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #0600FF; font-weight: bold;">static</span> DoubleAnimation CreateAnimation<span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">double</span> <span style="color: #0600FF; font-weight: bold;">from</span>, <span style="color: #6666cc; font-weight: bold;">double</span> to, <span style="color: #6666cc; font-weight: bold;">double</span> duration,
  <span style="color: #6666cc; font-weight: bold;">string</span> targetProperty, DependencyObject target<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
  <span style="color: #0600FF; font-weight: bold;">var</span> db <span style="color: #008000;">=</span> <span style="color: #008000;">new</span> DoubleAnimation<span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
  db<span style="color: #008000;">.</span><span style="color: #0000FF;">To</span> <span style="color: #008000;">=</span> to<span style="color: #008000;">;</span>
  db<span style="color: #008000;">.</span><span style="color: #0600FF; font-weight: bold;">From</span> <span style="color: #008000;">=</span> <span style="color: #0600FF; font-weight: bold;">from</span><span style="color: #008000;">;</span>
  db<span style="color: #008000;">.</span><span style="color: #0000FF;">EasingFunction</span> <span style="color: #008000;">=</span> <span style="color: #008000;">new</span> SineEase<span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
  db<span style="color: #008000;">.</span><span style="color: #0000FF;">Duration</span> <span style="color: #008000;">=</span> TimeSpan<span style="color: #008000;">.</span><span style="color: #0000FF;">FromSeconds</span><span style="color: #008000;">(</span>duration<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
  Storyboard<span style="color: #008000;">.</span><span style="color: #0000FF;">SetTarget</span><span style="color: #008000;">(</span>db, target<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
  Storyboard<span style="color: #008000;">.</span><span style="color: #0000FF;">SetTargetProperty</span><span style="color: #008000;">(</span>db, <span style="color: #008000;">new</span> PropertyPath<span style="color: #008000;">(</span>targetProperty<span style="color: #008000;">)</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
  <span style="color: #0600FF; font-weight: bold;">return</span> db<span style="color: #008000;">;</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>Thanks to the genius Charles Petzold for <a href="http://groups.google.com/group/wpf-disciples/msg/d30cb6eb660d0061">explaining to me how PlaneProjections work</a>! rotating an element around any point other than its centre is not quite as easy as it might seem!</p><p>As an aside, I would love to come up with an animation that more closely matches the native applications. I think what I have come up with is close, but noticeably different. If anyone is up for a challenge, please have a go at tweaking this animation and let me know what you come up with!</p><p>The above code gives us all we need in order to peel our UI, however, we now need to work out how to apply this in practice. Using the application developed in the previous post, we can see that the UI is composed of three discrete parts, the title, the pivot header and the list which resides within the currently visible pivot-item:</p><p><img src="http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2011/03/uiComponents.jpg" alt="" title="uiComponents" width="300" height="545" class="aligncenter size-full wp-image-1334" /></p><p>We’ll start with the trickiest part -the list. In my previous blog post I showed how it was possible to enumerate all the items which are currently visible within a <code>ListBox</code> (or <code>ItemsControl</code>). To make this code more re-useable I have refactored it as an extension method on ItemsControl:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #008080; font-style: italic;">/// &lt;summary&gt;</span>
<span style="color: #008080; font-style: italic;">/// Enumerates all the items that are currently visible in am ItemsControl.</span>
<span style="color: #008080; font-style: italic;">/// This implementation assumes that a VirtualizingStackPanel is</span>
<span style="color: #008080; font-style: italic;">/// being used as the ItemsPanel.</span>
<span style="color: #008080; font-style: italic;">/// &lt;/summary&gt;</span>
<span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #0600FF; font-weight: bold;">static</span> IEnumerable<span style="color: #008000;">&lt;</span>FrameworkElement<span style="color: #008000;">&gt;</span> GetItemsInView<span style="color: #008000;">(</span><span style="color: #0600FF; font-weight: bold;">this</span> ItemsControl itemsControl<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
    <span style="color: #008080; font-style: italic;">// locate the stack panel that hosts the items</span>
  VirtualizingStackPanel vsp <span style="color: #008000;">=</span> itemsControl<span style="color: #008000;">.</span><span style="color: #0000FF;">Descendants</span><span style="color: #008000;">&lt;</span>VirtualizingStackPanel<span style="color: #008000;">&gt;</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span>
                                           <span style="color: #008000;">.</span><span style="color: #0000FF;">First</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span> <span style="color: #0600FF; font-weight: bold;">as</span> VirtualizingStackPanel<span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #008080; font-style: italic;">// iterate over each of the items in view</span>
  <span style="color: #6666cc; font-weight: bold;">int</span> firstVisibleItem <span style="color: #008000;">=</span> <span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">int</span><span style="color: #008000;">)</span>vsp<span style="color: #008000;">.</span><span style="color: #0000FF;">VerticalOffset</span><span style="color: #008000;">;</span>
  <span style="color: #6666cc; font-weight: bold;">int</span> visibleItemCount <span style="color: #008000;">=</span> <span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">int</span><span style="color: #008000;">)</span>vsp<span style="color: #008000;">.</span><span style="color: #0000FF;">ViewportHeight</span><span style="color: #008000;">;</span>
  <span style="color: #0600FF; font-weight: bold;">for</span> <span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">int</span> index <span style="color: #008000;">=</span> firstVisibleItem<span style="color: #008000;">;</span> index <span style="color: #008000;">&lt;=</span> firstVisibleItem <span style="color: #008000;">+</span> visibleItemCount <span style="color: #008000;">+</span> <span style="color: #FF0000;">1</span><span style="color: #008000;">;</span> index<span style="color: #008000;">++</span><span style="color: #008000;">)</span>
  <span style="color: #008000;">{</span>
    <span style="color: #0600FF; font-weight: bold;">var</span> item <span style="color: #008000;">=</span> itemsControl<span style="color: #008000;">.</span><span style="color: #0000FF;">ItemContainerGenerator</span><span style="color: #008000;">.</span><span style="color: #0000FF;">ContainerFromIndex</span><span style="color: #008000;">(</span>index<span style="color: #008000;">)</span> <span style="color: #0600FF; font-weight: bold;">as</span> FrameworkElement<span style="color: #008000;">;</span>
    <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>item <span style="color: #008000;">==</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">)</span>
      <span style="color: #0600FF; font-weight: bold;">continue</span><span style="color: #008000;">;</span>
&nbsp;
    <span style="color: #0600FF; font-weight: bold;">yield</span> <span style="color: #0600FF; font-weight: bold;">return</span> item<span style="color: #008000;">;</span>
  <span style="color: #008000;">}</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>When the back button is pressed, we can locate the list which is located in the visible pivot-item, using <a href="{{ site.url }}/blog/colin/2010/03/linq-to-visual-tree/">Linq-to-VisualTree</a>, and use the extension method above to extract its visible items:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">var</span> listInView <span style="color: #008000;">=</span> <span style="color: #008000;">(</span><span style="color: #008000;">(</span>PivotItem<span style="color: #008000;">)</span>pivot<span style="color: #008000;">.</span><span style="color: #0000FF;">SelectedItem</span><span style="color: #008000;">)</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Descendants</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">.</span><span style="color: #0000FF;">OfType</span><span style="color: #008000;">&lt;</span>ItemsControl<span style="color: #008000;">&gt;</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Single</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
<span style="color: #0600FF; font-weight: bold;">var</span> listItems <span style="color: #008000;">=</span> listInView<span style="color: #008000;">.</span><span style="color: #0000FF;">GetItemsInView</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">.</span><span style="color: #0000FF;">ToList</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span></pre></td></tr></table></div><p>By inspecting the <code>Pivot</code> control’s template, we can see that the header is named “HeadersListElement”, making it easy to locate using Linq again:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">var</span> header <span style="color: #008000;">=</span> <span style="color: #0600FF; font-weight: bold;">this</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Descendants</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">.</span><span style="color: #0000FF;">OfType</span><span style="color: #008000;">&lt;</span>FrameworkElement<span style="color: #008000;">&gt;</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span>
                  <span style="color: #008000;">.</span><span style="color: #0000FF;">Single</span><span style="color: #008000;">(</span>d <span style="color: #008000;">=&gt;</span> d<span style="color: #008000;">.</span><span style="color: #0000FF;">Name</span> <span style="color: #008000;">==</span> <span style="color: #666666;">"HeadersListElement"</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span></pre></td></tr></table></div><p>Finally, the small text which indicates the name of the application is a named element in the XAML markup, so we already have a reference to this one. Putting all the above together, with a simple Linq <code>Union</code>, gives the following:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">protected</span> <span style="color: #0600FF; font-weight: bold;">override</span> <span style="color: #6666cc; font-weight: bold;">void</span> OnBackKeyPress<span style="color: #008000;">(</span><span style="color: #000000;">System.<span style="color: #0000FF;">ComponentModel</span></span><span style="color: #008000;">.</span><span style="color: #0000FF;">CancelEventArgs</span> e<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
  e<span style="color: #008000;">.</span><span style="color: #0000FF;">Cancel</span> <span style="color: #008000;">=</span> <span style="color: #0600FF; font-weight: bold;">true</span><span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #008080; font-style: italic;">// obtain the list from the current pivot item - and the items currently visible in this list</span>
  <span style="color: #0600FF; font-weight: bold;">var</span> listInView <span style="color: #008000;">=</span> <span style="color: #008000;">(</span><span style="color: #008000;">(</span>PivotItem<span style="color: #008000;">)</span>pivot<span style="color: #008000;">.</span><span style="color: #0000FF;">SelectedItem</span><span style="color: #008000;">)</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Descendants</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">.</span><span style="color: #0000FF;">OfType</span><span style="color: #008000;">&lt;</span>ItemsControl<span style="color: #008000;">&gt;</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Single</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
  <span style="color: #0600FF; font-weight: bold;">var</span> listItems <span style="color: #008000;">=</span> listInView<span style="color: #008000;">.</span><span style="color: #0000FF;">GetItemsInView</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">.</span><span style="color: #0000FF;">ToList</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #008080; font-style: italic;">// locate the pivot control  header</span>
  <span style="color: #0600FF; font-weight: bold;">var</span> header <span style="color: #008000;">=</span> <span style="color: #0600FF; font-weight: bold;">this</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Descendants</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">.</span><span style="color: #0000FF;">OfType</span><span style="color: #008000;">&lt;</span>FrameworkElement<span style="color: #008000;">&gt;</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span>
              <span style="color: #008000;">.</span><span style="color: #0000FF;">Single</span><span style="color: #008000;">(</span>d <span style="color: #008000;">=&gt;</span> d<span style="color: #008000;">.</span><span style="color: #0000FF;">Name</span> <span style="color: #008000;">==</span> <span style="color: #666666;">"HeadersListElement"</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #008080; font-style: italic;">// create the list of items to peel</span>
  <span style="color: #0600FF; font-weight: bold;">var</span> peelList <span style="color: #008000;">=</span> <span style="color: #008000;">new</span> FrameworkElement<span style="color: #008000;">[</span><span style="color: #008000;">]</span> <span style="color: #008000;">{</span> TitlePanel, header <span style="color: #008000;">}</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Union</span><span style="color: #008000;">(</span>listItems<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
  peelList<span style="color: #008000;">.</span><span style="color: #0000FF;">Peel</span><span style="color: #008000;">(</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span> <span style="color: #008000;">=&gt;</span>
    <span style="color: #008000;">{</span>
      App<span style="color: #008000;">.</span><span style="color: #0000FF;">Quit</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">}</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #0600FF; font-weight: bold;">base</span><span style="color: #008000;">.</span><span style="color: #0000FF;">OnBackKeyPress</span><span style="color: #008000;">(</span>e<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>The final twist is that when the back ‘key’ is pressed the application exits immediately. To avoid this, we cancel the event. However, we need a way to exit the application when the animation has finished. Unfortunately Silverlight for WP7 does not have a mechanism for programatically exiting! This has been <a href="http://social.msdn.microsoft.com/Forums/en/windowsphone7series/thread/8961eac4-880d-4c61-9bd5-8771347514ab">the subject of much debate</a>. I opted for the popular <a href="http://www.pchenry.com/Home/tabid/36/EntryId/345/The-way-to-Exit-a-WP7-app-just-seems-wrong-to-me-is-it-just-me.aspx">throw-an-unhandled-exception</a> route. Yes it is ugly, no, I do not like it, but let’s not get distracted. The ‘peel’ effect is now done!</p><p>To use this code in your own application, you will have to assemble your own list of elements based on your UI, however, this does give a lot of flexibility.</p><p>You can download the project sourcecode here: <a href="{{ site.url }}/blog/colin/wp-content/uploads/2011/03/MetroInMotion2.zip">MetroInMotion2.zip</a></p><p>Regards,<br />
Colin E.</p></div>