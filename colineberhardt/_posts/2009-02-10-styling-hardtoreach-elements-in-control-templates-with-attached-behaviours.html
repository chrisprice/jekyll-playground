---
author: Colin Eberhardt
tags: DataGrid, styling, templates, WPF
permalink: /blog/colin/2009/02/styling-hard-to-reach-elements-in-control-templates-with-attached-behaviours/index.html
layout: colineberhardt-blog
---
<div class="entry"><div class="topsy_widget_data topsy_theme_light-green" style="float: right; margin-left: 0.75em; background: url(data:,%7B%20%22url%22%3A%20%22http%253A%252F%252Fwww.scottlogic.co.uk%252Fblog%252Fcolin%252F2009%252F02%252Fstyling-hard-to-reach-elements-in-control-templates-with-attached-behaviours%252F%22%2C%20%22style%22%3A%20%22big%22%2C%20%22title%22%3A%20%22Styling%20hard-to-reach%20elements%20in%20control%20templates%20with%20attached%20behaviours%20%23%22%20%7D);"></div><p>OK, the title of this blog post is not very snappy, but it is not an easy problem to describe in a few short words. Here’s the rub, the WPF DataGrid has a select-all button located in the top-left corner, just like Excel and many other grid controls / applications. However, with the default style, this button is barely visible and I would not be surprised if a user of the grid failed to see it.</p><p><a href="{{ site.url }}/blog/colin/wp-content/uploads/2009/02/select-all.png"><img class="alignnone size-full wp-image-119" title="select-all" src="http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2009/02/select-all.png" alt="select-all" width="418" height="220" /></a></p><p>Unfortunately restyling this button is not all that straightforward. The more complex WPF controls like the DataGrid and ListView typically expose the template used to construct, and the style applied to their various visual elements.&nbsp; However, the DataGrid does not expose a style or template for the select-all button.</p><p>Fortunately, all is not lost. With WPF, if a control does not expose a style for one of its component parts, you can replicate and replace its entire template. Sometimes this approach feels a little heavy-handed … “I can’t seem to find a way to fit those flashy alloy wheels to my car, so I’ll just by a new car that already has the wheels I like”.</p><p>I want to explore a more lightweight approach.</p><p>Whilst it is usually preferable to modify a controls template from XAML, in cases like this, I prefer the more concise approach of modifying them in code-behind. In order to do this, you need to handle the <a href="http://msdn.microsoft.com/en-us/library/system.windows.frameworkelement.loaded.aspx">FrameworkElement.Loaded</a> event on the control whos template you wish to modify. This event is fired after the control’s visual tree has been constructed, to verify this add a breakpoint in the event handler and inspect the visual tree with <a href="http://www.codeproject.com/KB/WPF/MoleForWPF.aspx">Mole</a>. The image below shows the visual tree of my DataGrid which I have expanded to locate the select-all button.</p><p><a href="{{ site.url }}/blog/colin/wp-content/uploads/2009/02/datagrid-mole.png"><img class="alignnone size-full wp-image-120" title="datagrid-mole" src="http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2009/02/datagrid-mole.png" alt="datagrid-mole" width="343" height="297" /></a></p><p>You can see that the button is the first element, four steps down the visual tree, therefore it should be easy to locate by walking the visual tree. Once it has been reached we can simply replace its template to the one which we desire:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">void</span> Grid_Loaded<span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">object</span> sender, RoutedEventArgs e<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
    DependencyObject dep <span style="color: #008000;">=</span> sender <span style="color: #0600FF; font-weight: bold;">as</span> DependencyObject<span style="color: #008000;">;</span>
&nbsp;
    <span style="color: #008080; font-style: italic;">// Navigate down the visual tree to the button</span>
    <span style="color: #0600FF; font-weight: bold;">while</span> <span style="color: #008000;">(</span><span style="color: #008000;">!</span><span style="color: #008000;">(</span>dep <span style="color: #008000;">is</span> Button<span style="color: #008000;">)</span><span style="color: #008000;">)</span>
    <span style="color: #008000;">{</span>
        dep <span style="color: #008000;">=</span> VisualTreeHelper<span style="color: #008000;">.</span><span style="color: #0000FF;">GetChild</span><span style="color: #008000;">(</span>dep, <span style="color: #FF0000;">0</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">}</span>
    Button button <span style="color: #008000;">=</span> dep <span style="color: #0600FF; font-weight: bold;">as</span> Button<span style="color: #008000;">;</span>
&nbsp;
    <span style="color: #008080; font-style: italic;">// apply our new template</span>
    <span style="color: #6666cc; font-weight: bold;">object</span> res <span style="color: #008000;">=</span> FindResource<span style="color: #008000;">(</span><span style="color: #666666;">"SelectAllButtonTemplate"</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    button<span style="color: #008000;">.</span><span style="color: #0000FF;">Template</span> <span style="color: #008000;">=</span> res <span style="color: #0600FF; font-weight: bold;">as</span> ControlTemplate
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>The template SelectAllButtonTemplate is simply defined as a resource of our Window.</p><p>This works just fine for our single grid, but what if we want to use the same trick on multiple DataGrids? (Besides, we have code-behind, which in WPF is a bit of a dirty word!).</p><p>The <a href="http://www.codeproject.com/KB/WPF/AttachedBehaviors.aspx">Attached Behaviour</a> pattern is a useful WPF pattern that proves very useful in this situation. In brief, attached properties add state to a your WPF elements, whereas attached behaviours add behaviour. When an attached property becomes associated with a dependency object, an event is raised. We can handle this event and register handlers on the events of the object being attached to, in this case, our DataGrid’s Loaded event.</p><p>The following code is our attached behaviour in its entirety:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #0600FF; font-weight: bold;">static</span> <span style="color: #6666cc; font-weight: bold;">class</span> DataGridStyleBehaviour
<span style="color: #008000;">{</span>
    <span style="color: #008080;">#region attached property</span>
&nbsp;
    <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #0600FF; font-weight: bold;">static</span> ControlTemplate GetSelectAllButtonTemplate<span style="color: #008000;">(</span>DataGrid obj<span style="color: #008000;">)</span>
    <span style="color: #008000;">{</span>
        <span style="color: #0600FF; font-weight: bold;">return</span> <span style="color: #008000;">(</span>ControlTemplate<span style="color: #008000;">)</span>obj<span style="color: #008000;">.</span><span style="color: #0000FF;">GetValue</span><span style="color: #008000;">(</span>SelectAllButtonTemplateProperty<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">}</span>
&nbsp;
    <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #0600FF; font-weight: bold;">static</span> <span style="color: #6666cc; font-weight: bold;">void</span> SetSelectAllButtonTemplate<span style="color: #008000;">(</span>DataGrid obj, ControlTemplate <span style="color: #0600FF; font-weight: bold;">value</span><span style="color: #008000;">)</span>
    <span style="color: #008000;">{</span>
        obj<span style="color: #008000;">.</span><span style="color: #0000FF;">SetValue</span><span style="color: #008000;">(</span>SelectAllButtonTemplateProperty, <span style="color: #0600FF; font-weight: bold;">value</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">}</span>
&nbsp;
    <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #0600FF; font-weight: bold;">static</span> <span style="color: #0600FF; font-weight: bold;">readonly</span> DependencyProperty SelectAllButtonTemplateProperty <span style="color: #008000;">=</span>
        DependencyProperty<span style="color: #008000;">.</span><span style="color: #0000FF;">RegisterAttached</span><span style="color: #008000;">(</span><span style="color: #666666;">"SelectAllButtonTemplate"</span>,
        <span style="color: #008000;">typeof</span><span style="color: #008000;">(</span>ControlTemplate<span style="color: #008000;">)</span>, <span style="color: #008000;">typeof</span><span style="color: #008000;">(</span>DataGridStyleBehaviour<span style="color: #008000;">)</span>,
        <span style="color: #008000;">new</span> UIPropertyMetadata<span style="color: #008000;">(</span><span style="color: #0600FF; font-weight: bold;">null</span>, OnSelectAllButtonTemplateChanged<span style="color: #008000;">)</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
    <span style="color: #008080;">#endregion</span>
&nbsp;
    <span style="color: #008080;">#region property behaviour</span>
&nbsp;
    <span style="color: #008080; font-style: italic;">// property change event handler for SelectAllButtonTemplate</span>
    <span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #0600FF; font-weight: bold;">static</span> <span style="color: #6666cc; font-weight: bold;">void</span> OnSelectAllButtonTemplateChanged<span style="color: #008000;">(</span>
        DependencyObject depObj, DependencyPropertyChangedEventArgs e<span style="color: #008000;">)</span>
    <span style="color: #008000;">{</span>
        DataGrid grid <span style="color: #008000;">=</span> depObj <span style="color: #0600FF; font-weight: bold;">as</span> DataGrid<span style="color: #008000;">;</span>
        <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>grid <span style="color: #008000;">==</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">)</span>
            <span style="color: #0600FF; font-weight: bold;">return</span><span style="color: #008000;">;</span>
&nbsp;
        <span style="color: #008080; font-style: italic;">// handle the grid's Loaded event</span>
        grid<span style="color: #008000;">.</span><span style="color: #0000FF;">Loaded</span> <span style="color: #008000;">+=</span> <span style="color: #008000;">new</span> RoutedEventHandler<span style="color: #008000;">(</span>Grid_Loaded<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">}</span>
&nbsp;
    <span style="color: #008080; font-style: italic;">// Handles the DataGrid's Loaded event</span>
    <span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #0600FF; font-weight: bold;">static</span> <span style="color: #6666cc; font-weight: bold;">void</span> Grid_Loaded<span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">object</span> sender, RoutedEventArgs e<span style="color: #008000;">)</span>
    <span style="color: #008000;">{</span>
        DataGrid grid <span style="color: #008000;">=</span> sender <span style="color: #0600FF; font-weight: bold;">as</span> DataGrid<span style="color: #008000;">;</span>
        DependencyObject dep <span style="color: #008000;">=</span> grid<span style="color: #008000;">;</span>
&nbsp;
        <span style="color: #008080; font-style: italic;">// Navigate down the visual tree to the button</span>
        <span style="color: #0600FF; font-weight: bold;">while</span> <span style="color: #008000;">(</span><span style="color: #008000;">!</span><span style="color: #008000;">(</span>dep <span style="color: #008000;">is</span> Button<span style="color: #008000;">)</span><span style="color: #008000;">)</span>
        <span style="color: #008000;">{</span>
            dep <span style="color: #008000;">=</span> VisualTreeHelper<span style="color: #008000;">.</span><span style="color: #0000FF;">GetChild</span><span style="color: #008000;">(</span>dep, <span style="color: #FF0000;">0</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
        <span style="color: #008000;">}</span>
        Button button <span style="color: #008000;">=</span> dep <span style="color: #0600FF; font-weight: bold;">as</span> Button<span style="color: #008000;">;</span>
&nbsp;
        <span style="color: #008080; font-style: italic;">// apply our new template</span>
        ControlTemplate template <span style="color: #008000;">=</span> GetSelectAllButtonTemplate<span style="color: #008000;">(</span>grid<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
        button<span style="color: #008000;">.</span><span style="color: #0000FF;">Template</span> <span style="color: #008000;">=</span> template<span style="color: #008000;">;</span>
    <span style="color: #008000;">}</span>
&nbsp;
    <span style="color: #008080;">#endregion</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>This attached property can be used as illustrated below, where we apply the SelectAllButtonTemplate from our Window’s resources to a DataGrid:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="xml" style="font-family: monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Window</span> ...</span>
<span style="color: #009900;">    <span style="color: #000066;">Title</span>=<span style="color: #ff0000;">"BBC News RSS"</span> <span style="color: #000066;">Height</span>=<span style="color: #ff0000;">"300"</span> <span style="color: #000066;">Width</span>=<span style="color: #ff0000;">"400"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
&nbsp;
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Window.Resources<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;XmlDataProvider</span> <span style="color: #000066;">x:Key</span>=<span style="color: #ff0000;">"NewsFeed"</span></span>
<span style="color: #009900;">                     <span style="color: #000066;">Source</span>=<span style="color: #ff0000;">"http://newsrss.bbc.co.uk/rss/newsonline_uk_edition/front_page/rss.xml"</span>  </span>
<span style="color: #009900;">                     <span style="color: #000066;">XPath</span>=<span style="color: #ff0000;">"//item"</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>
&nbsp;
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;ControlTemplate</span> <span style="color: #000066;">x:Key</span>=<span style="color: #ff0000;">"SelectAllButtonTemplate"</span> <span style="color: #000066;">TargetType</span>=<span style="color: #ff0000;">"{x:Type Button}"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
            <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Grid<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
                <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Rectangle</span>  <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"Border"</span></span>
<span style="color: #009900;">                            <span style="color: #000066;">Fill</span>=<span style="color: #ff0000;">"Pink"</span> </span>
<span style="color: #009900;">                            <span style="color: #000066;">SnapsToDevicePixels</span>=<span style="color: #ff0000;">"True"</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>
                <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Polygon</span>   <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"Arrow"</span></span>
<span style="color: #009900;">                           <span style="color: #000066;">HorizontalAlignment</span>=<span style="color: #ff0000;">"Right"</span></span>
<span style="color: #009900;">                           <span style="color: #000066;">VerticalAlignment</span>=<span style="color: #ff0000;">"Bottom"</span></span>
<span style="color: #009900;">                           <span style="color: #000066;">Margin</span>=<span style="color: #ff0000;">"8,8,3,3"</span></span>
<span style="color: #009900;">                           <span style="color: #000066;">Opacity</span>=<span style="color: #ff0000;">"0.15"</span></span>
<span style="color: #009900;">                           <span style="color: #000066;">Fill</span>=<span style="color: #ff0000;">"Black"</span></span>
<span style="color: #009900;">                           <span style="color: #000066;">Stretch</span>=<span style="color: #ff0000;">"Uniform"</span></span>
<span style="color: #009900;">                           <span style="color: #000066;">Points</span>=<span style="color: #ff0000;">"0,10 10,10 10,0"</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>
            <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Grid<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>            
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/ControlTemplate<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Window.Resources<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
&nbsp;
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Grid<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;dg:DataGrid</span> <span style="color: #000066;">Name</span>=<span style="color: #ff0000;">"dataGrid"</span> <span style="color: #000066;">AutoGenerateColumns</span>=<span style="color: #ff0000;">"False"</span> </span>
<span style="color: #009900;">                     <span style="color: #000066;">local:DataGridStyleBehaviour.SelectAllButtonTemplate</span>=<span style="color: #ff0000;">"{StaticResource SelectAllButtonTemplate}"</span></span>
<span style="color: #009900;">                     <span style="color: #000066;">ItemsSource</span>=<span style="color: #ff0000;">"{Binding Source={StaticResource NewsFeed}}"</span> <span style="color: #000066;">RowHeaderWidth</span>=<span style="color: #ff0000;">"25"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
            <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;dg:DataGrid.Columns<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
                <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;dg:DataGridTextColumn</span> <span style="color: #000066;">Header</span>=<span style="color: #ff0000;">"Title"</span> <span style="color: #000066;">Binding</span>=<span style="color: #ff0000;">"{Binding XPath=title}"</span> <span style="color: #000066;">Width</span>=<span style="color: #ff0000;">"*"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
                <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;dg:DataGridHyperlinkColumn</span>   <span style="color: #000066;">Header</span>=<span style="color: #ff0000;">"Url"</span> <span style="color: #000066;">Binding</span>=<span style="color: #ff0000;">"{Binding XPath=link}"</span> <span style="color: #000066;">Width</span>=<span style="color: #ff0000;">"*"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
                <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;dg:DataGridTextColumn</span> <span style="color: #000066;">Header</span>=<span style="color: #ff0000;">"Date"</span> <span style="color: #000066;">Binding</span>=<span style="color: #ff0000;">"{Binding XPath=pubDate}"</span> <span style="color: #000066;">Width</span>=<span style="color: #ff0000;">"*"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
            <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/dg:DataGrid.Columns<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/dg:DataGrid<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Grid<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Window<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre></td></tr></table></div><p>The result is a beautiful pink select-all button that I don’t think any user would miss in a hurry:</p><p><a href="{{ site.url }}/blog/colin/wp-content/uploads/2009/02/pinkbutton.png"><img class="alignnone size-full wp-image-121" title="pinkbutton" src="http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2009/02/pinkbutton.png" alt="pinkbutton" width="368" height="205" /></a></p><p>And a clean code-behind file for our Window <img src="http://www.scottlogic.co.uk/blog/colin/wp-includes/images/smilies/icon_smile.gif" alt=":-)" class="wp-smiley" /> </p><p>You can download the demo project for this blog post in the following zip file, <a href="{{ site.url }}/blog/colin/wp-content/uploads/2009/02/wpfstylinghiddenelements.zip">wpfstylinghiddenelements</a>.</p><p>One last thing … if you are implementing a WPF / Silverlight control, please expose the styles and templates for all component parts of your control!</p><p>Regards, Colin E.</p></div>