---
author: Colin Eberhardt
tags: gestures, WP7
permalink: /blog/colin/2012/06/a-gesture-driven-windows-phone-todo-application-part-two-drag-re-ordering/index.html
layout: colineberhardt-blog
---
<div class="entry"><div class="topsy_widget_data topsy_theme_light-green" style="float: right; margin-left: 0.75em; background: url(data:,%7B%20%22url%22%3A%20%22http%253A%252F%252Fwww.scottlogic.co.uk%252Fblog%252Fcolin%252F2012%252F06%252Fa-gesture-driven-windows-phone-todo-application-part-two-drag-re-ordering%252F%22%2C%20%22style%22%3A%20%22big%22%2C%20%22title%22%3A%20%22A%20gesture-driven%20Windows%20Phone%20to-do%20application%20Part%20Two%20%E2%80%93%20drag%20re-ordering%20%23%22%20%7D);"></div><p><em>A couple of weeks ago <a href="{{ site.url }}/blog/colin/2012/06/a-gesture-driven-windows-phone-to-do-application/" title="A gesture-driven Windows Phone to-do application">I blogged about a todo list application</a> which uses gestures to achieve its basic functions, a left swipe deletes an item, while a right-swipe marks it as complete. In this blog post I am adding re-ordering which is initiated via a tap-and-hold gesture and performed via a drag.</em></p><p>As mentioned previously, this application is heavily inspired by the <a href="http://www.realmacsoftware.com/clear/">iPhone application Clear</a>, who I give full credit for coming up with such an innovative user-interface design. This blog post is for fun an education, you are strictly prohibited from using this as the basis of a ‘Clear’ clone for WP7.</p><p>The video below shows the application so far, with the new re-order functionality:</p><p><iframe width="480" height="360" src="http://www.youtube.com/embed/Hd2szlUmwyA" frameborder="0" allowfullscreen="allowfullscreen"></iframe></p><h3>Initiating a Drag</h3><p>In the <a href="{{ site.url }}/blog/colin/2012/06/a-gesture-driven-windows-phone-to-do-application/" title="A gesture-driven Windows Phone to-do application">previous blog post</a> we saw how the Toolkit <code>GestureListener </code>can be used to convert the low-level manipulation events into high level gestures. In order to initiate an item drag we could use the Hold event that the <code>GestureListener </code>exposes. The Hold event is fired when the user taps and holds the location of their finger for a few seconds. When I published my previous blogpost one of my readers <a href="{{ site.url }}/blog/colin/2012/06/a-gesture-driven-windows-phone-to-do-application/#comment-104611">Simon (Darkside) Jackson kindly pointed out</a> that some of the gesture events are now supported by <code>FrameworkElement </code>directly, <code>Hold </code>is one such event. For this reason I’ll use <code>FrameworkElement.Hold</code>, the equivalent event on <code>GestureListener </code>should be considered deprecated. </p><p>The easiest way to allow the user to ‘pick up’ and drag the item is to clone it using a <code>WriteableBitmap</code>, hiding the original. This technique allows us to place the item at a higher Z-index than the list which it comes from, so that it will always be top-most as it is moved up and down the list.</p><p>We’ll add the element that is used to render the dragged item to the XAML:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="xml" style="font-family: monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Grid<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;ItemsControl</span> <span style="color: #000066;">ItemsSource</span>=<span style="color: #ff0000;">"{Binding}"</span> <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"todoList"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
    ... markup from previous blog post
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/ItemsControl<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
&nbsp;
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Grid</span> <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"dragImageContainer"</span></span>
<span style="color: #009900;">        <span style="color: #000066;">VerticalAlignment</span>=<span style="color: #ff0000;">"Top"</span></span>
<span style="color: #009900;">        <span style="color: #000066;">Visibility</span>=<span style="color: #ff0000;">"Collapsed"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
    <span style="color: #808080; font-style: italic;">&lt;!-- the image that displays the dragged item --&gt;</span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Image</span> <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"dragImage"</span></span>
<span style="color: #009900;">          <span style="color: #000066;">VerticalAlignment</span>=<span style="color: #ff0000;">"Top"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Image<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
&nbsp;
    <span style="color: #808080; font-style: italic;">&lt;!-- lower drop shadow --&gt;</span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Rectangle</span> <span style="color: #000066;">Height</span>=<span style="color: #ff0000;">"10"</span></span>
<span style="color: #009900;">                <span style="color: #000066;">VerticalAlignment</span>=<span style="color: #ff0000;">"Bottom"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Rectangle.Fill<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;LinearGradientBrush</span> <span style="color: #000066;">EndPoint</span>=<span style="color: #ff0000;">"0,1"</span> <span style="color: #000066;">StartPoint</span>=<span style="color: #ff0000;">"0,0"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
          <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;GradientStop</span> <span style="color: #000066;">Color</span>=<span style="color: #ff0000;">"#AA000000"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
          <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;GradientStop</span> <span style="color: #000066;">Color</span>=<span style="color: #ff0000;">"#00000000"</span> <span style="color: #000066;">Offset</span>=<span style="color: #ff0000;">"1"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/LinearGradientBrush<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Rectangle.Fill<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Rectangle.RenderTransform<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;TranslateTransform</span> <span style="color: #000066;">Y</span>=<span style="color: #ff0000;">"10"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Rectangle.RenderTransform<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Rectangle<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
&nbsp;
    <span style="color: #808080; font-style: italic;">&lt;!-- upper drop shadow --&gt;</span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Rectangle</span> <span style="color: #000066;">Height</span>=<span style="color: #ff0000;">"10"</span></span>
<span style="color: #009900;">               <span style="color: #000066;">VerticalAlignment</span>=<span style="color: #ff0000;">"Top"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Rectangle.Fill<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;LinearGradientBrush</span> <span style="color: #000066;">EndPoint</span>=<span style="color: #ff0000;">"0,1"</span> <span style="color: #000066;">StartPoint</span>=<span style="color: #ff0000;">"0,0"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
          <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;GradientStop</span> <span style="color: #000066;">Color</span>=<span style="color: #ff0000;">"#00000000"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
          <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;GradientStop</span> <span style="color: #000066;">Color</span>=<span style="color: #ff0000;">"#AA000000"</span> <span style="color: #000066;">Offset</span>=<span style="color: #ff0000;">"1"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/LinearGradientBrush<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Rectangle.Fill<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Rectangle.RenderTransform<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;TranslateTransform</span> <span style="color: #000066;">Y</span>=<span style="color: #ff0000;">"-10"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Rectangle.RenderTransform<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Rectangle<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Grid<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Grid<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre></td></tr></table></div><p>The markup contains an image, and a couple of <code>Rectangle </code>elements, each of which is filled with a subtle opacity gradient and offset in order to give the impression of a drop shadow. The Source of the image is set in the Hold event handler as shown:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">void</span> GestureListener_Hold<span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">object</span> sender, Microsoft<span style="color: #008000;">.</span><span style="color: #0000FF;">Phone</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Controls</span><span style="color: #008000;">.</span><span style="color: #0000FF;">GestureEventArgs</span> e<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
  _dragReOrder <span style="color: #008000;">=</span> <span style="color: #0600FF; font-weight: bold;">true</span><span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #008080; font-style: italic;">// copy the dragged item to our 'dragImage' </span>
  FrameworkElement draggedItem <span style="color: #008000;">=</span> sender <span style="color: #0600FF; font-weight: bold;">as</span> FrameworkElement<span style="color: #008000;">;</span>
  <span style="color: #0600FF; font-weight: bold;">var</span> bitmap <span style="color: #008000;">=</span> <span style="color: #008000;">new</span> WriteableBitmap<span style="color: #008000;">(</span>draggedItem, <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
  dragImage<span style="color: #008000;">.</span><span style="color: #0000FF;">Source</span> <span style="color: #008000;">=</span> bitmap<span style="color: #008000;">;</span>
  dragImageContainer<span style="color: #008000;">.</span><span style="color: #0000FF;">Visibility</span> <span style="color: #008000;">=</span> Visibility<span style="color: #008000;">.</span><span style="color: #0000FF;">Visible</span><span style="color: #008000;">;</span>
  dragImageContainer<span style="color: #008000;">.</span><span style="color: #0000FF;">Opacity</span> <span style="color: #008000;">=</span> <span style="color: #FF0000;">1.0</span><span style="color: #008000;">;</span>\
  dragImageContainer<span style="color: #008000;">.</span><span style="color: #0000FF;">SetVerticalOffset</span><span style="color: #008000;">(</span>draggedItem<span style="color: #008000;">.</span><span style="color: #0000FF;">GetRelativePosition</span><span style="color: #008000;">(</span>todoList<span style="color: #008000;">)</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Y</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #008080; font-style: italic;">// hide the real item</span>
  draggedItem<span style="color: #008000;">.</span><span style="color: #0000FF;">Opacity</span> <span style="color: #008000;">=</span> <span style="color: #FF0000;">0.0</span><span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #008080; font-style: italic;">// fade out the list</span>
  todoList<span style="color: #008000;">.</span><span style="color: #0000FF;">Animate</span><span style="color: #008000;">(</span><span style="color: #FF0000;">1.0</span>, <span style="color: #FF0000;">0.7</span>, FrameworkElement<span style="color: #008000;">.</span><span style="color: #0000FF;">OpacityProperty</span>, <span style="color: #FF0000;">300</span>, <span style="color: #FF0000;">0</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
  _initialDragIndex <span style="color: #008000;">=</span> _todoItems<span style="color: #008000;">.</span><span style="color: #0000FF;">IndexOf</span><span style="color: #008000;">(</span><span style="color: #008000;">(</span><span style="color: #008000;">(</span>ToDoItem<span style="color: #008000;">)</span>draggedItem<span style="color: #008000;">.</span><span style="color: #0000FF;">DataContext</span><span style="color: #008000;">)</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>The code above also hides the real object and offsets our ‘fake’ vertically so that it occupies the same position as the original. The list is also faded slightly to give a visual indication that the dragged item is now above the rest of the list:</p><p><img src="http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2012/06/holdToDrag.jpg" alt="" title="holdToDrag" width="450" height="382" class="aligncenter size-full wp-image-2210" /></p><h3>Dragging the item</h3><p>In order to allow the user to support dragging of the item we also need to handle <code>ManipulationDelta </code>on the <code>Border </code>element, as shown below:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="xml" style="font-family: monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;ItemsControl.ItemTemplate<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;DataTemplate<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Border</span> <span style="color: #000066;">Background</span>=<span style="color: #ff0000;">"{Binding Path=Color, Converter={StaticResource ColorToBrushConverter}}"</span></span>
<span style="color: #009900;">            <span style="color: #000066;">ManipulationDelta</span>=<span style="color: #ff0000;">"Border_ManipulationDelta"</span></span>
<span style="color: #009900;">            <span style="color: #000066;">ManipulationCompleted</span>=<span style="color: #ff0000;">"Border_ManipulationCompleted"</span></span>
<span style="color: #009900;">            <span style="color: #000066;">Hold</span>=<span style="color: #ff0000;">"Border_Hold"</span></span>
<span style="color: #009900;">            <span style="color: #000066;">Canvas.ZIndex</span>=<span style="color: #ff0000;">"0"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
      <span style="color: #808080; font-style: italic;">&lt;!-- gestures that were added in the last blog post to support delete / complete --&gt;</span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;toolkit:GestureService.GestureListener<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;toolkit:GestureListener</span></span>
<span style="color: #009900;">                  <span style="color: #000066;">DragStarted</span>=<span style="color: #ff0000;">"GestureListener_DragStarted"</span></span>
<span style="color: #009900;">                  <span style="color: #000066;">DragDelta</span>=<span style="color: #ff0000;">"GestureListener_DragDelta"</span></span>
<span style="color: #009900;">                  <span style="color: #000066;">DragCompleted</span>=<span style="color: #ff0000;">"GestureListener_DragCompleted"</span></span>
<span style="color: #009900;">                  <span style="color: #000066;">GestureCompleted</span>=<span style="color: #ff0000;">"GestureListener_GestureCompleted"</span></span>
<span style="color: #009900;">                  <span style="color: #000066;">Flick</span>=<span style="color: #ff0000;">"GestureListener_Flick"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/toolkit:GestureService.GestureListener<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
&nbsp;
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Grid<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #808080; font-style: italic;">&lt;!-- the todo item XAML from the previous blog post --&gt;</span>        
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Grid<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Border<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/DataTemplate<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/ItemsControl.ItemTemplate<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre></td></tr></table></div><p>So why am I handling these events on the <code>Border </code>rather than re-using the <code>DragDelta </code>/ <code>GestureComplete </code>on the <code>GestureListener</code>? There are a couple of reasons:</p><ol>
<li>The <code>GestureListener </code>‘drag’ has a tolerance (as discussed in the previous blog post). The user has to move their finger beyond a certain distance before a drag is started. In the current context we want a drag to occur as soon as the <code>Hold</code> event fires.</li>
<li>When handling the element ‘drag’ we need to suppress the event by setting <code>e.Handled=true</code>, otherwise a drag will bubble up to the <code>ScrollViewer</code> that hosts our elements causing it to scroll. I found (through trial and error) that the<code> GestureListener.DragDelta.Handled</code> property doesn’t appear to have any effect.</li>
</ol><p>The handler for the drag event is pretty simple, moving the copy of our item by the required distance:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">void</span> Border_ManipulationDelta<span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">object</span> sender, ManipulationDeltaEventArgs e<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
  Debug<span style="color: #008000;">.</span><span style="color: #0000FF;">WriteLine</span><span style="color: #008000;">(</span><span style="color: #666666;">"ManipulationDelta"</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span><span style="color: #008000;">!</span>_dragReOrder<span style="color: #008000;">)</span>
    <span style="color: #0600FF; font-weight: bold;">return</span><span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #008080; font-style: italic;">// set the event to handled in order to avoid scrolling the ScrollViewer</span>
  e<span style="color: #008000;">.</span><span style="color: #0000FF;">Handled</span> <span style="color: #008000;">=</span> <span style="color: #0600FF; font-weight: bold;">true</span><span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #008080; font-style: italic;">// move our 'drag image'.</span>
  dragImageContainer<span style="color: #008000;">.</span><span style="color: #0000FF;">SetVerticalOffset</span><span style="color: #008000;">(</span>dragImageContainer<span style="color: #008000;">.</span><span style="color: #0000FF;">GetVerticalOffset</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">.</span><span style="color: #0600FF; font-weight: bold;">Value</span> <span style="color: #008000;">+</span> e<span style="color: #008000;">.</span><span style="color: #0000FF;">DeltaManipulation</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Translation</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Y</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
  ShuffleItemsOnDrag<span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><h3>Offsetting the items underneath</h3><p>The <code>ShuffleItemsOnDrag </code>method is where the fun starts, we’ll get to that shortly. First we’ll take a look at a simple utility method that is used to determine the index that the item being dragged would occupy if it were dropped at the present location. This is achieved by a simple measurement:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #008080; font-style: italic;">// Determines the index that the dragged item would occupy when dropped</span>
<span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">int</span> GetDragIndex<span style="color: #008000;">(</span><span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
  <span style="color: #6666cc; font-weight: bold;">double</span> dragLocation <span style="color: #008000;">=</span> dragImageContainer<span style="color: #008000;">.</span><span style="color: #0000FF;">GetRelativePosition</span><span style="color: #008000;">(</span>todoList<span style="color: #008000;">)</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Y</span> <span style="color: #008000;">+</span>
                          VerticalScrollViewer<span style="color: #008000;">.</span><span style="color: #0000FF;">VerticalOffset</span> <span style="color: #008000;">+</span>
                          dragImage<span style="color: #008000;">.</span><span style="color: #0000FF;">ActualHeight</span> <span style="color: #008000;">/</span> <span style="color: #FF0000;">2</span><span style="color: #008000;">;</span>
  <span style="color: #6666cc; font-weight: bold;">int</span> dragIndex <span style="color: #008000;">=</span> <span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">int</span><span style="color: #008000;">)</span><span style="color: #008000;">(</span>dragLocation <span style="color: #008000;">/</span> dragImage<span style="color: #008000;">.</span><span style="color: #0000FF;">ActualHeight</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
  <span style="color: #0600FF; font-weight: bold;">return</span> dragIndex<span style="color: #008000;">;</span>
<span style="color: #008000;">}</span>
&nbsp;
<span style="color: #0600FF; font-weight: bold;">private</span> ScrollViewer _scrollViewer<span style="color: #008000;">;</span>
&nbsp;
&nbsp;
<span style="color: #008080; font-style: italic;">// gets the scrollviewer from the ItemsControl template</span>
<span style="color: #0600FF; font-weight: bold;">private</span> ScrollViewer VerticalScrollViewer
<span style="color: #008000;">{</span>
  <span style="color: #0600FF; font-weight: bold;">get</span>
  <span style="color: #008000;">{</span>
    <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>_scrollViewer <span style="color: #008000;">==</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">)</span>
    <span style="color: #008000;">{</span>
      _scrollViewer <span style="color: #008000;">=</span> todoList<span style="color: #008000;">.</span><span style="color: #0000FF;">Descendants</span><span style="color: #008000;">&lt;</span>ScrollViewer<span style="color: #008000;">&gt;</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span>
                              <span style="color: #008000;">.</span><span style="color: #0000FF;">Cast</span><span style="color: #008000;">&lt;</span>ScrollViewer<span style="color: #008000;">&gt;</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span>
                              <span style="color: #008000;">.</span><span style="color: #0000FF;">Single</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">}</span>
    <span style="color: #0600FF; font-weight: bold;">return</span> _scrollViewer<span style="color: #008000;">;</span>
  <span style="color: #008000;">}</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>The above code needs to take the current scroll location into consideration, which is why the ScrollViewer property above uses <a href="{{ site.url }}/blog/colin/2010/03/linq-to-visual-tree/" title="Linq to Visual Tree">Linq-to-VisualTree</a> to find the <code>ScrollViewer </code>that the <code>ItemsControl </code>generates to hosts our elements.</p><p><code>ShuffleItemsOnDrag </code>is where the fun begins, we want to create an effect where the dragged item ‘pushes’ the other items out of the way as it hovers over them, giving the impression that the list is re-ordering as we drag.</p><p>The method below iterates over all of the items in the list to determine whether they need to be offset. An item needs to be offset if it is between the current dragged item index and the items original location.</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">void</span> ShuffleItemsOnDrag<span style="color: #008000;">(</span><span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
  <span style="color: #008080; font-style: italic;">// find its current index</span>
  <span style="color: #6666cc; font-weight: bold;">int</span> dragIndex <span style="color: #008000;">=</span> GetDragIndex<span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #008080; font-style: italic;">// iterate over the items in the list and offset as required</span>
  <span style="color: #6666cc; font-weight: bold;">double</span> offset <span style="color: #008000;">=</span> dragImage<span style="color: #008000;">.</span><span style="color: #0000FF;">ActualHeight</span><span style="color: #008000;">;</span>
  <span style="color: #0600FF; font-weight: bold;">for</span> <span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">int</span> i <span style="color: #008000;">=</span> <span style="color: #FF0000;">0</span><span style="color: #008000;">;</span> i <span style="color: #008000;">&lt;</span> _todoItems<span style="color: #008000;">.</span><span style="color: #0000FF;">Count</span><span style="color: #008000;">;</span> i<span style="color: #008000;">++</span><span style="color: #008000;">)</span>
  <span style="color: #008000;">{</span>
    FrameworkElement item <span style="color: #008000;">=</span> todoList<span style="color: #008000;">.</span><span style="color: #0000FF;">ItemContainerGenerator</span><span style="color: #008000;">.</span><span style="color: #0000FF;">ContainerFromIndex</span><span style="color: #008000;">(</span>i<span style="color: #008000;">)</span> <span style="color: #0600FF; font-weight: bold;">as</span> FrameworkElement<span style="color: #008000;">;</span>
&nbsp;
    <span style="color: #008080; font-style: italic;">// determine which direction to offset this item by</span>
    <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>i <span style="color: #008000;">&lt;=</span> dragIndex <span style="color: #008000;">&amp;&amp;</span> i <span style="color: #008000;">&gt;</span> _initialDragIndex<span style="color: #008000;">)</span>
    <span style="color: #008000;">{</span>
      OffsetItem<span style="color: #008000;">(</span><span style="color: #008000;">-</span>offset, item<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">}</span>
    <span style="color: #0600FF; font-weight: bold;">else</span> <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>i <span style="color: #008000;">&gt;=</span> dragIndex <span style="color: #008000;">&amp;&amp;</span> i <span style="color: #008000;">&lt;</span> _initialDragIndex<span style="color: #008000;">)</span>
    <span style="color: #008000;">{</span>
      OffsetItem<span style="color: #008000;">(</span>offset, item<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">}</span>
    <span style="color: #0600FF; font-weight: bold;">else</span>
    <span style="color: #008000;">{</span>
      OffsetItem<span style="color: #008000;">(</span><span style="color: #FF0000;">0</span>, item<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">}</span>
  <span style="color: #008000;">}</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>The <code>OffsetItem </code>method performs the actual offset by animating the Y position of each item. The target location is stored in the elements <code>Tag</code> property so that we don’t repeatedly fire the same animation on an element.</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">void</span> OffsetItem<span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">double</span> offset, FrameworkElement item<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
  <span style="color: #6666cc; font-weight: bold;">double</span> targetLocation <span style="color: #008000;">=</span> item<span style="color: #008000;">.</span><span style="color: #0000FF;">Tag</span> <span style="color: #008000;">!=</span> <span style="color: #0600FF; font-weight: bold;">null</span> <span style="color: #008000;">?</span> <span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">double</span><span style="color: #008000;">)</span>item<span style="color: #008000;">.</span><span style="color: #0000FF;">Tag</span> <span style="color: #008000;">:</span> <span style="color: #FF0000;">0</span><span style="color: #008000;">;</span>
  <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>targetLocation <span style="color: #008000;">!=</span> offset<span style="color: #008000;">)</span>
  <span style="color: #008000;">{</span>
    <span style="color: #0600FF; font-weight: bold;">var</span> trans <span style="color: #008000;">=</span> item<span style="color: #008000;">.</span><span style="color: #0000FF;">GetVerticalOffset</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Transform</span><span style="color: #008000;">;</span>
    trans<span style="color: #008000;">.</span><span style="color: #0000FF;">Animate</span><span style="color: #008000;">(</span><span style="color: #0600FF; font-weight: bold;">null</span>, offset, TranslateTransform<span style="color: #008000;">.</span><span style="color: #0000FF;">YProperty</span>, <span style="color: #FF0000;">500</span>, <span style="color: #FF0000;">0</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    item<span style="color: #008000;">.</span><span style="color: #0000FF;">Tag</span> <span style="color: #008000;">=</span> offset<span style="color: #008000;">;</span>
    _moveSound<span style="color: #008000;">.</span><span style="color: #0000FF;">Play</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
  <span style="color: #008000;">}</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p><img src="http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2012/06/drag.jpg" alt="" title="drag" width="300" height="545" class="aligncenter size-full wp-image-2211" /></p><h3>Completing the drag</h3><p>When the user stops dragging the item, the <code>ManipulationCompleted</code> event is fired. Here we perform a number of tasks:</p><ol>
<li>Fade the list back to full opacity</li>
<li>Animate the dragged item so that it ‘snaps’ into location</li>
<li>When the above is complete, we need to re-order the underlying collection of model items, then re-populate the <code>ObservableCollection </code>exposed to the view. This causes all the items to be re-rendered, removing all of the <code>TranslateTransforms </code>that have been applied.</li>
<li>Finally, remove the image which is our copy of the dragged item.</li>
</ol><p>This sounds like a lot of work, but our <code>Animate</code> utility method makes it quite simple:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">void</span> Border_ManipulationCompleted<span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">object</span> sender, ManipulationCompletedEventArgs e<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
  <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span><span style="color: #008000;">!</span>_dragReOrder<span style="color: #008000;">)</span>
    <span style="color: #0600FF; font-weight: bold;">return</span><span style="color: #008000;">;</span>
&nbsp;
  _dragReOrder <span style="color: #008000;">=</span> <span style="color: #0600FF; font-weight: bold;">false</span><span style="color: #008000;">;</span>
  _autoScrollTimer<span style="color: #008000;">.</span><span style="color: #0000FF;">Stop</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #6666cc; font-weight: bold;">int</span> dragIndex <span style="color: #008000;">=</span> GetDragIndex<span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #008080; font-style: italic;">// fade in the list</span>
  todoList<span style="color: #008000;">.</span><span style="color: #0000FF;">Animate</span><span style="color: #008000;">(</span><span style="color: #0600FF; font-weight: bold;">null</span>, <span style="color: #FF0000;">1.0</span>, FrameworkElement<span style="color: #008000;">.</span><span style="color: #0000FF;">OpacityProperty</span>, <span style="color: #FF0000;">200</span>, <span style="color: #FF0000;">0</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #008080; font-style: italic;">// animated the dragged item into location</span>
  <span style="color: #6666cc; font-weight: bold;">double</span> targetLocation <span style="color: #008000;">=</span> dragIndex <span style="color: #008000;">*</span> dragImage<span style="color: #008000;">.</span><span style="color: #0000FF;">ActualHeight</span> <span style="color: #008000;">-</span> VerticalScrollViewer<span style="color: #008000;">.</span><span style="color: #0000FF;">VerticalOffset</span><span style="color: #008000;">;</span>
  <span style="color: #0600FF; font-weight: bold;">var</span> trans <span style="color: #008000;">=</span> dragImageContainer<span style="color: #008000;">.</span><span style="color: #0000FF;">GetVerticalOffset</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Transform</span><span style="color: #008000;">;</span>
  trans<span style="color: #008000;">.</span><span style="color: #0000FF;">Animate</span><span style="color: #008000;">(</span><span style="color: #0600FF; font-weight: bold;">null</span>, targetLocation, TranslateTransform<span style="color: #008000;">.</span><span style="color: #0000FF;">YProperty</span>, <span style="color: #FF0000;">200</span>, <span style="color: #FF0000;">0</span>, <span style="color: #0600FF; font-weight: bold;">null</span>,
    <span style="color: #008000;">(</span><span style="color: #008000;">)</span> <span style="color: #008000;">=&gt;</span>
    <span style="color: #008000;">{</span>
      <span style="color: #008080; font-style: italic;">// clone the list and move the dragged item</span>
      <span style="color: #0600FF; font-weight: bold;">var</span> items <span style="color: #008000;">=</span> _todoItems<span style="color: #008000;">.</span><span style="color: #0000FF;">ToList</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
      <span style="color: #0600FF; font-weight: bold;">var</span> draggedItem <span style="color: #008000;">=</span> items<span style="color: #008000;">[</span>_initialDragIndex<span style="color: #008000;">]</span><span style="color: #008000;">;</span>
      items<span style="color: #008000;">.</span><span style="color: #0600FF; font-weight: bold;">Remove</span><span style="color: #008000;">(</span>draggedItem<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
      items<span style="color: #008000;">.</span><span style="color: #0000FF;">Insert</span><span style="color: #008000;">(</span>dragIndex, draggedItem<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
      <span style="color: #008080; font-style: italic;">// re-populate our ObservableCollection</span>
      _todoItems<span style="color: #008000;">.</span><span style="color: #0000FF;">Clear</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
      _todoItems<span style="color: #008000;">.</span><span style="color: #0000FF;">AddRange</span><span style="color: #008000;">(</span>items<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
      UpdateToDoColors<span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
      <span style="color: #008080; font-style: italic;">// fade out the dragged image and collapse on completion</span>
      dragImageContainer<span style="color: #008000;">.</span><span style="color: #0000FF;">Animate</span><span style="color: #008000;">(</span><span style="color: #0600FF; font-weight: bold;">null</span>, <span style="color: #FF0000;">0.0</span>, FrameworkElement<span style="color: #008000;">.</span><span style="color: #0000FF;">OpacityProperty</span>, <span style="color: #FF0000;">1000</span>, <span style="color: #FF0000;">0</span>, <span style="color: #0600FF; font-weight: bold;">null</span>, <span style="color: #008000;">(</span><span style="color: #008000;">)</span>
        <span style="color: #008000;">=&gt;</span> dragImageContainer<span style="color: #008000;">.</span><span style="color: #0000FF;">Visibility</span> <span style="color: #008000;">=</span> Visibility<span style="color: #008000;">.</span><span style="color: #0000FF;">Collapsed</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">}</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
<span style="color: #008000;">}</span></pre></td></tr></table></div><h3>Scrolling the list</h3><p>The current implementation only allows the user to drag the item within the bounds of the current screen. What if the list is larger than the screen and the users want to drag right from the bottom to the top?</p><p>A common solution to this problem is to auto-scroll the list if the item is dragged near to the top. The following method is invoked periodically by a timer to see whether the item has been dragged within the top or bottom ‘scroll zones’. The velocity of the scroll is proportional to just how far within these zones the item has been dragged. Scrolling is simply a matter of setting the scroll location on the <code>ScrollViewer </code>we located earlier:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #008080; font-style: italic;">// checks the current location of the item being dragged, and scrolls if it is</span>
<span style="color: #008080; font-style: italic;">// close to the top or the bottom</span>
<span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">void</span> AutoScrollList<span style="color: #008000;">(</span><span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
  <span style="color: #008080; font-style: italic;">// where is the dragged item relative to the list bounds?</span>
  <span style="color: #6666cc; font-weight: bold;">double</span> draglocation <span style="color: #008000;">=</span> dragImage<span style="color: #008000;">.</span><span style="color: #0000FF;">GetRelativePosition</span><span style="color: #008000;">(</span>todoList<span style="color: #008000;">)</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Y</span> <span style="color: #008000;">+</span> dragImage<span style="color: #008000;">.</span><span style="color: #0000FF;">ActualHeight</span> <span style="color: #008000;">/</span> <span style="color: #FF0000;">2</span><span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>draglocation <span style="color: #008000;">&lt;</span> AutoScrollHitRegionSize<span style="color: #008000;">)</span>
  <span style="color: #008000;">{</span>
    <span style="color: #008080; font-style: italic;">// if close to the top, scroll up</span>
    <span style="color: #6666cc; font-weight: bold;">double</span> velocity <span style="color: #008000;">=</span> <span style="color: #008000;">(</span>AutoScrollHitRegionSize <span style="color: #008000;">-</span> draglocation<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    VerticalScrollViewer<span style="color: #008000;">.</span><span style="color: #0000FF;">ScrollToVerticalOffset</span><span style="color: #008000;">(</span>VerticalScrollViewer<span style="color: #008000;">.</span><span style="color: #0000FF;">VerticalOffset</span> <span style="color: #008000;">-</span> velocity<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
  <span style="color: #008000;">}</span>
  <span style="color: #0600FF; font-weight: bold;">else</span> <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>draglocation <span style="color: #008000;">&gt;</span> todoList<span style="color: #008000;">.</span><span style="color: #0000FF;">ActualHeight</span> <span style="color: #008000;">-</span> AutoScrollHitRegionSize<span style="color: #008000;">)</span>
  <span style="color: #008000;">{</span>
    <span style="color: #008080; font-style: italic;">// if close to the bottom, scroll down</span>
    <span style="color: #6666cc; font-weight: bold;">double</span> velocity <span style="color: #008000;">=</span> <span style="color: #008000;">(</span>AutoScrollHitRegionSize <span style="color: #008000;">-</span> <span style="color: #008000;">(</span>todoList<span style="color: #008000;">.</span><span style="color: #0000FF;">ActualHeight</span> <span style="color: #008000;">-</span> draglocation<span style="color: #008000;">)</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    VerticalScrollViewer<span style="color: #008000;">.</span><span style="color: #0000FF;">ScrollToVerticalOffset</span><span style="color: #008000;">(</span>VerticalScrollViewer<span style="color: #008000;">.</span><span style="color: #0000FF;">VerticalOffset</span> <span style="color: #008000;">+</span> velocity<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
  <span style="color: #008000;">}</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>You can see the scroll zones illustrated below:</p><p><img src="http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2012/06/scrollZones.jpg" alt="" title="scrollZones" width="300" height="545" class="aligncenter size-full wp-image-2212" /></p><p>And finally, we are all done! With our todo application you can use flick and drag gestures to mark items as complete or delete them, and now use hold and drag to re-order. I think it’s about time I made it so that you can add or edit items. We’ll get to that next time!</p><p>You can download the sourcecode here: <a href="{{ site.url }}/blog/colin/wp-content/uploads/2012/06/ClearStyle1.zip">ClearStyle.zip</a></p><p>Regards, Colin E.</p></div>