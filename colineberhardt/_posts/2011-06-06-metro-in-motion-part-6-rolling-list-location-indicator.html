---
author: Colin Eberhardt
tags: codeproject, metro, WP7
permalink: /blog/colin/2011/06/metro-in-motion-part-6-rolling-list-location-indicator/index.html
layout: colineberhardt-blog
---
<div class="entry"><div class="topsy_widget_data topsy_theme_light-green" style="float: right; margin-left: 0.75em; background: url(data:,%7B%20%22url%22%3A%20%22http%253A%252F%252Fwww.scottlogic.co.uk%252Fblog%252Fcolin%252F2011%252F06%252Fmetro-in-motion-part-6-rolling-list-location-indicator%252F%22%2C%20%22style%22%3A%20%22big%22%2C%20%22title%22%3A%20%22Metro%20In%20Motion%20Part%20%236%20-%20Rolling%20List%20Location%20Indicator%20%23%22%20%7D);"></div><p><em>This blog post describes the development of a rolling list location indicator. This indicator mirrors the behaviour seen in the native Windows Phone 7 calendar which rolls from one date to the next as the user scrolls.</em></p><p>For those of you who have not been following my Metro-In-Motion series, I’ll briefly recap. My aim is to provide an implementation of the ‘fluid’ UI transitions and effects seen in native Windows Phone 7 applications but absent from the Silverlight APIs. So far I have covered <a href="{{ site.url }}/blog/colin/2011/03/metro-in-motion-fluid-list-animation/">fluid list animations</a>, <a href="{{ site.url }}/blog/colin/2011/03/metro-in-motion-part-2-peel-animations/">‘peel’ animations</a>, <a href="{{ site.url }}/blog/colin/2011/04/metro-in-motion-3-flying-titles/">flying titles</a> , a <a href="{{ site.url }}/blog/colin/2011/05/metro-in-motion-part-4-tilt-effect/">’tilt’ effect</a> and finally <a href="{{ site.url }}/blog/colin/2011/05/metro-in-motion-5-sandwichflow/">SandwichFlow</a> which brought all these effects together and the series to a close. However, a recent <a href="http://stackoverflow.com/questions/6046408/apply-slidetransition-effect-to-a-textblock-in-xaml">StackOverflow</a> questions inspired me to implement another fluid UI effect found in the native calendar application. When scrolling your list of appointments, the small day indicator at the top of the page displays the current date, with graceful roll transitions as you move from day-to-day:</p><p><img src="http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2011/06/WP7Calendar.png" alt="" title="WP7Calendar" width="275" height="203" class="aligncenter size-full wp-image-1525" /></p><p>It’s a subtle but the effect is very pleasing!</p><p>You can see my implementation of this effect in the video below:</p><p></p><p><iframe width="480" height="390" src="http://www.youtube.com/embed/3w3Jp97a8OA" frameborder="0" allowfullscreen="allowfullscreen"></iframe></p><p></p><p>In order to create this indicator, we need to determine the item that is currently at the top of the list while it is being scrolled, and the direction of scrolling. Once we have this data at our disposal, the rest is all just visualisation!</p><h2></h2><p>The Silverlight <code>ListBox</code> and <code>ItemsControl</code> do not expose a property which indicates the first visible item, so we need to add this functionality. Adding the properties themselves is simply a matter of defining a <code>FirstVisibleItem</code> and a <code>IsScrollingUpwards</code> attached properties. The logic that computes these properties is a little more complicated!</p><p>I have created a boolean <code>ExposeFirstVisibleItem</code> attached property (which acts as an attached behaviour). When this property is set to true, we navigate the visual tree to locate the vertical scrollbar that is located within the <code>ScrollViewer</code> which is part of the <code>ListBox</code> template.</p><p>The changed event handler for this attached property is shown below:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #0600FF; font-weight: bold;">static</span> <span style="color: #6666cc; font-weight: bold;">void</span> OnExposeFirstVisibleItemPropertyChanged<span style="color: #008000;">(</span>DependencyObject d,
    DependencyPropertyChangedEventArgs e<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
  <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>e<span style="color: #008000;">.</span><span style="color: #0000FF;">NewValue</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Equals</span><span style="color: #008000;">(</span><span style="color: #0600FF; font-weight: bold;">true</span><span style="color: #008000;">)</span><span style="color: #008000;">)</span>
  <span style="color: #008000;">{</span>
    ItemsControl itemsControl <span style="color: #008000;">=</span> d <span style="color: #0600FF; font-weight: bold;">as</span> ItemsControl<span style="color: #008000;">;</span>
&nbsp;
    <span style="color: #008080; font-style: italic;">// wire up the scrollbar, handling ValueChanged events</span>
    <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span><span style="color: #008000;">!</span>WireUpScrollbar<span style="color: #008000;">(</span>itemsControl<span style="color: #008000;">)</span><span style="color: #008000;">)</span>
    <span style="color: #008000;">{</span>
      <span style="color: #008080; font-style: italic;">// if wire-up fails, try again on LayoutUpdated</span>
      EventHandler tryFindScrollBar <span style="color: #008000;">=</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">;</span>
      tryFindScrollBar <span style="color: #008000;">=</span> <span style="color: #008000;">(</span>s2, e2<span style="color: #008000;">)</span> <span style="color: #008000;">=&gt;</span>
      <span style="color: #008000;">{</span>
        <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>WireUpScrollbar<span style="color: #008000;">(</span>itemsControl<span style="color: #008000;">)</span><span style="color: #008000;">)</span>
        <span style="color: #008000;">{</span>
          itemsControl<span style="color: #008000;">.</span><span style="color: #0000FF;">LayoutUpdated</span> <span style="color: #008000;">-=</span> tryFindScrollBar<span style="color: #008000;">;</span>
        <span style="color: #008000;">}</span>
      <span style="color: #008000;">}</span><span style="color: #008000;">;</span>
&nbsp;
      itemsControl<span style="color: #008000;">.</span><span style="color: #0000FF;">LayoutUpdated</span> <span style="color: #008000;">+=</span> tryFindScrollBar<span style="color: #008000;">;</span>
    <span style="color: #008000;">}</span>
  <span style="color: #008000;">}</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>Note, the method <code>WireUpScrollbar</code> returns true if it has located the scrollbar. However, if the template for our <code>ListBox</code> has not yet been instantiated this will fail. In this case, we handle the <code>LayoutUpdated</code> event and retry until this method returns a success. Note, the <code>EventHandler</code> that removes its own subscription to the <code>LayoutUpdated</code> event, a neat pattern that I will certainly use again!</p><p>The <code>WireUpScrollbar</code> method uses <a href="{{ site.url }}/blog/colin/2010/03/linq-to-visual-tree/">Linq-to-VisualTree</a> to locate the <code>ScrollBar</code>.</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #0600FF; font-weight: bold;">static</span> <span style="color: #6666cc; font-weight: bold;">bool</span> WireUpScrollbar<span style="color: #008000;">(</span>ItemsControl itemsControl<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
  <span style="color: #0600FF; font-weight: bold;">var</span> sb <span style="color: #008000;">=</span> itemsControl<span style="color: #008000;">.</span><span style="color: #0000FF;">Descendants</span><span style="color: #008000;">&lt;</span>ScrollBar<span style="color: #008000;">&gt;</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span>
                      <span style="color: #008000;">.</span><span style="color: #0000FF;">Cast</span><span style="color: #008000;">&lt;</span>ScrollBar<span style="color: #008000;">&gt;</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span>
                      <span style="color: #008000;">.</span><span style="color: #0600FF; font-weight: bold;">Where</span><span style="color: #008000;">(</span>s <span style="color: #008000;">=&gt;</span> s<span style="color: #008000;">.</span><span style="color: #0000FF;">Orientation</span> <span style="color: #008000;">==</span> Orientation<span style="color: #008000;">.</span><span style="color: #0000FF;">Vertical</span><span style="color: #008000;">)</span>
                      <span style="color: #008000;">.</span><span style="color: #0000FF;">SingleOrDefault</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span> <span style="color: #0600FF; font-weight: bold;">as</span> ScrollBar<span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>sb <span style="color: #008000;">==</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">)</span>
    <span style="color: #0600FF; font-weight: bold;">return</span> <span style="color: #0600FF; font-weight: bold;">false</span><span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #008080; font-style: italic;">// set to the initial value</span>
  SetFirstVisibleItem<span style="color: #008000;">(</span>itemsControl<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
  sb<span style="color: #008000;">.</span><span style="color: #0000FF;">Tag</span> <span style="color: #008000;">=</span> sb<span style="color: #008000;">.</span><span style="color: #0600FF; font-weight: bold;">Value</span><span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #008080; font-style: italic;">// update value on scroll ...</span>
  sb<span style="color: #008000;">.</span><span style="color: #0000FF;">ValueChanged</span> <span style="color: #008000;">+=</span> <span style="color: #008000;">(</span>s, e2<span style="color: #008000;">)</span> <span style="color: #008000;">=&gt;</span>
  <span style="color: #008000;">{</span>
    SetFirstVisibleItem<span style="color: #008000;">(</span>itemsControl<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    SetIsScrollingUpwards<span style="color: #008000;">(</span>itemsControl, sb<span style="color: #008000;">.</span><span style="color: #0600FF; font-weight: bold;">Value</span> <span style="color: #008000;">&lt;</span> <span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">double</span><span style="color: #008000;">)</span>sb<span style="color: #008000;">.</span><span style="color: #0000FF;">Tag</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
    <span style="color: #008080; font-style: italic;">// store the previous scroll position in the Tag</span>
    sb<span style="color: #008000;">.</span><span style="color: #0000FF;">Tag</span> <span style="color: #008000;">=</span> sb<span style="color: #008000;">.</span><span style="color: #0600FF; font-weight: bold;">Value</span><span style="color: #008000;">;</span>
  <span style="color: #008000;">}</span><span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #0600FF; font-weight: bold;">return</span> <span style="color: #0600FF; font-weight: bold;">true</span><span style="color: #008000;">;</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>The <code>ScrollBar.Tag</code> is used to store the previous scroll location so that we can determine the scroll direction, with <code>SetIsScrollingUpwards</code> setting the attached property on our <code>ListBox</code> (or <code>ItemsControl</code>).</p><p>Finally <code>SetFirstVisibleItem</code> locates the first visible item within the list and updated the <code>FirstVisibleItem</code> attached property:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #0600FF; font-weight: bold;">static</span> <span style="color: #6666cc; font-weight: bold;">void</span> SetFirstVisibleItem<span style="color: #008000;">(</span>ItemsControl itemsControl<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
  itemsControl<span style="color: #008000;">.</span><span style="color: #0000FF;">Dispatcher</span><span style="color: #008000;">.</span><span style="color: #0000FF;">BeginInvoke</span><span style="color: #008000;">(</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span> <span style="color: #008000;">=&gt;</span>
  <span style="color: #008000;">{</span>
    <span style="color: #0600FF; font-weight: bold;">var</span> item <span style="color: #008000;">=</span> itemsControl<span style="color: #008000;">.</span><span style="color: #0000FF;">GetItemsInView</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">.</span><span style="color: #0000FF;">First</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
    ListUtils<span style="color: #008000;">.</span><span style="color: #0000FF;">SetFirstVisibleItem</span><span style="color: #008000;">(</span>itemsControl, item<span style="color: #008000;">.</span><span style="color: #0000FF;">DataContext</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
  <span style="color: #008000;">}</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>Note the <code>GetItemsInView</code> extension method which enumerates the visible items. This was implemented in an earlier Metro-In-Motion blog post, however I have extended this implementation to support both virtualizing and non-virtualizing panels, you can see the latest version on codeplex within the <a href="http://wp7contrib.codeplex.com/SourceControl/changeset/view/66149#1469275">Windows Phone 7 Contrib</a> (WP7Contrib) project. The <code>FirstVisibleItem</code> exposes the <code>DataContext</code> of the first visible item, which will be the first visible model object.</p><h2></h2><p>With the above code, we simply set the following attached property to true on a <code>ListBox</code> or <code>ItemsControl</code> in order for it to expose teh first visible item and scroll direction:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="xml" style="font-family: monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;ListBox</span> <span style="color: #000066;">mim:ListUtils.ExposeFirstVisibleItem</span>=<span style="color: #ff0000;">"true"</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span></pre></td></tr></table></div><p>The rollover effect seen in the native control is very easy to reproduce with the <a href="http://silverlight.codeplex.com/">Silverlight Toolkit</a> TransitioningContentControl, which has proven popular with Silverlight developers wishing to create page transitions. The only problem is that this control has not made it into the WP7 version of the toolkit. So I simply grabbed the source of and placed it directly into my project.</p><p>If we look at the calendar example that is shown in the video at the start of this blog post, it has the following XAML:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="xml" style="font-family: monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;StackPanel</span> <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"TitlePanel"</span> <span style="color: #000066;">Grid.Row</span>=<span style="color: #ff0000;">"0"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
&nbsp;
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;layout:TransitioningContentControl</span></span>
<span style="color: #009900;">                <span style="color: #000066;">Content</span>=<span style="color: #ff0000;">"{Binding Path=(mim:ListUtils.FirstVisibleItem).Time,</span>
<span style="color: #009900;">                                   ElementName=list,</span>
<span style="color: #009900;">                                   Converter={StaticResource StringFormatConverter},</span>
<span style="color: #009900;">                                   ConverterParameter='dd MMM yy'}"</span></span>
<span style="color: #009900;">                <span style="color: #000066;">Transition</span>=<span style="color: #ff0000;">"{Binding Path=(mim:ListUtils.IsScrollingUpwards),</span>
<span style="color: #009900;">                                   ElementName=list,</span>
<span style="color: #009900;">                                   Converter={StaticResource BooleanToTransitionConverter}}"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;layout:TransitioningContentControl.ContentTemplate<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;DataTemplate<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;TextBlock</span> <span style="color: #000066;">Text</span>=<span style="color: #ff0000;">"{Binding}"</span></span>
<span style="color: #009900;">                        <span style="color: #000066;">FontSize</span>=<span style="color: #ff0000;">"60"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/DataTemplate<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/layout:TransitioningContentControl.ContentTemplate<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/layout:TransitioningContentControl<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/StackPanel<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
&nbsp;
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Grid</span> <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"ContentPanel"</span> <span style="color: #000066;">Grid.Row</span>=<span style="color: #ff0000;">"1"</span> <span style="color: #000000; font-weight: bold;">&gt;</span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;ListBox</span> <span style="color: #000066;">ItemsSource</span>=<span style="color: #ff0000;">"{Binding}"</span></span>
<span style="color: #009900;">            <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"list"</span></span>
<span style="color: #009900;">            <span style="color: #000066;">mim:ListUtils.ExposeFirstVisibleItem</span>=<span style="color: #ff0000;">"true"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
    <span style="color: #808080; font-style: italic;">&lt;!-- template goes here --&gt;</span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/ListBox<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Grid<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre></td></tr></table></div><p>Which gives the following layout:</p><p><img src="http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2011/06/RolloverImage.png" alt="" title="RolloverImage" width="244" height="443" class="aligncenter size-full wp-image-1534" /></p><p>The <code>Content</code> property of our <code>TransitioningContentControl</code> uses <code>ElementName</code> binding and a property path of <code>(mim:ListUtils.FirstVisibleItem).Time</code>, in order to bind to the <code>Time</code> property of the first visible model object. Note that the list contains multiple items that are on the same day but have different times. The <code>Converter</code> associated with this binding (which is a simple implementation of the Silverlight 4 <code>StringFormat</code> binding property), uses the string <code>'dd MMM yy'</code>, which will give the same value for all appointments on the same day. Therefore the content of the <code>TransitioningContentControl</code> control will only change as we navigate between day boundaries.</p><p>The <code>TransitioningContentControl</code> already has suitable transitions which give a nice roll-up and roll-down effect. These are selected by setting the <code>Transition</code> property to the named transition. In the example above, this is bound to the attached boolean <code>IsScrollingUpwards</code> property of our list, with a simple value converter that converts this into the required string transition identifier.</p><p>And we’re done!</p><p>I quite like the way that the implementation of this effect is split into two halves, the one which extends the functionality of the list, and the other which visualises the output. This should give great flexibility, as can be seen in the example which indicates the list location within a contacts list.</p><p>This code also works with the <a href="{{ site.url }}/blog/colin/2011/01/a-windows-phone-7-jump-list-control/">Jump List</a> I created a few months ago, however, it did require a few changes to that code. My current plan is to move all of the WP7 controls and effects I have created into the <a href="http://wp7contrib.codeplex.com/">WP7Contrib</a> project, so watch this (or that) space!).</p><p>You can download the sourcecode for this blog here: <a href="{{ site.url }}/blog/colin/wp-content/uploads/2011/06/MetroInMotionSix.zip">MetroInMotionSix.zip</a></p><p>Regards,<br />
Colin E.</p></div>