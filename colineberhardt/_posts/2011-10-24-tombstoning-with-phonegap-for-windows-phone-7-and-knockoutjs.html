---
author: Colin Eberhardt
tags: codeproject, mvvm, PhoneGap, tombstoning, WP7
permalink: /blog/colin/2011/10/tombstoning-with-phonegap-for-windows-phone-7-and-knockoutjs/index.html
layout: colineberhardt-blog
---
<div class="entry"><div class="topsy_widget_data topsy_theme_light-green" style="float: right; margin-left: 0.75em; background: url(data:,%7B%20%22url%22%3A%20%22http%253A%252F%252Fwww.scottlogic.co.uk%252Fblog%252Fcolin%252F2011%252F10%252Ftombstoning-with-phonegap-for-windows-phone-7-and-knockoutjs%252F%22%2C%20%22style%22%3A%20%22big%22%2C%20%22title%22%3A%20%22Tombstoning%20with%20PhoneGap%20for%20Windows%20Phone%207%20%28and%20KnockoutJS%29%20%23%22%20%7D);"></div><p>A few weeks back I wrote <a href="{{ site.url }}/blog/colin/2011/09/developing-windows-phone-7-html5-apps-with-phonegap/" title="Developing Windows Phone 7 HTML5 apps with PhoneGap">a blog post</a> about how the recent announcement of PhoneGap support for Windows Phone 7 (WP7) which makes it possible to develop HTML5-based applications. In my previous blog post I showed the development of a simple HTML5 / JavaScript application which PhoneGap wraps up within a Silverlight application ‘shell’ allowing it to be deployed to your phone and potentially submitted to the Marketplace.</p><p>However, in order to pass the various Marketplace requirements and gain certification, your application must correctly handle the application lifecycle. With the recent Mango release, the lifecycle has become a little more complicated (although better! in that it adds multi-tasking / fast-app switching). I have also covered the lifecycle in a previous blog post and demonstrated how you can  <a href="{{ site.url }}/blog/colin/2011/10/a-windows-phone-7-1-mango-mvvm-tombstoning-example/" title="A Windows Phone 7.1 (Mango) MVVM Tombstoning Example">handle the various lifecycle events within an MVVM application</a>. </p><p>The most tricky part of the application lifecycle that as a developer you need to handle is the tombstoned state, where your application is terminated (i.e. stopped and removed from memory). It is your responsibility to save enough state in order that when your tombstoned application is restarted, it looks to the user as if your application never stopped running, i.e. you restore your application UI to its original state. </p><p>The Mango application lifecycle is illustrated below:</p><p><img src="http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2011/10/WP7Lifecycle1.png" alt="" title="WP7Lifecycle" width="600" height="475" class="aligncenter size-full wp-image-1785" /></p><p>The <a href="http://docs.phonegap.com/en/1.0.0/phonegap_events_events.md.html">PhoneGap events</a> API includes pause and resume events, which can be used to detect when the application transitions to and from the dormant state, however, for WP7 these events do not give us enough information. When resuming, we need to know whether it has resumed from a dormant or a tombstoned state. Considering that the tombstoned state is peculiar to WP7 (Android, and iPhone simply have a suspend / resume model), I don’t think it makes sense for the PhoneGap APIs to change in order to accommodate this. In this blog post I will show how the WP7 PhoneGap application host can be modified in order to support tombstoning.</p><p>But before we get there, I want to digress a while and look at using the MVVM pattern with JavaScript …</p><h2>Using the MVVM pattern in JavaScript</h2><p>Handling tombstoning is much easier if you have a good separation between your view and your logic, with the MVVM pattern being a sensible choice for achieving this. When your application is tombstoned (and your application terminated), then re-activated, it is your responsibility to recreate the original state. Your view-model, is a model-of-a-view, so technically should provide all the information required to fulfil this requirement. See my <a href="{{ site.url }}/blog/colin/2011/10/a-windows-phone-7-1-mango-mvvm-tombstoning-example/">previous blog</a> post for details.</p><p>There are numerous JavaScript UI frameworks available (MVC, MVP, MVVM), however, because I feel tombstoning lends itself particularly well to the MVVM pattern, I decided to give <a href="http://knockoutjs.com/">KnockoutJS</a> a try. When reading about this framework you will find references to WPF and Silverlight, it is clear that it has been heavily inspired by the Microsoft XAML frameworks.</p><p>The application I have built to demonstrate tombstoning is a very simple, single page twitter search application.</p><p>The Knockout view model is a JavaScript object where the properties are defined as ‘observables’. These are JavaScript functions which provide change notification, much like CLR properties with <code>INotifyPropergtyChanged</code> within Silverlight / WPF.</p><h3>The View-Model</h3><p>The view model for my twitter search application is shown below:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family: monospace;"><span style="color: #006600; font-style: italic;">/// &lt;summary&gt;</span>
<span style="color: #006600; font-style: italic;">/// A view model for searching twitter for a given term</span>
<span style="color: #006600; font-style: italic;">/// &lt;/summary&gt;</span>
<span style="color: #000066; font-weight: bold;">function</span> TwitterSearchViewModel<span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
&nbsp;
  <span style="color: #000066; font-weight: bold;">var</span> that <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">this</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #006600; font-style: italic;">// --- properties</span>
&nbsp;
  <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">isSearching</span> <span style="color: #339933;">=</span> ko.<span style="color: #660066;">observable</span><span style="color: #009900;">(</span><span style="color: #003366; font-weight: bold;">false</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">searchTerm</span> <span style="color: #339933;">=</span> ko.<span style="color: #660066;">observable</span><span style="color: #009900;">(</span><span style="color: #3366CC;">"#wp7dev"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">tweets</span> <span style="color: #339933;">=</span> ko.<span style="color: #660066;">observableArray</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #006600; font-style: italic;">// --- functions</span>
&nbsp;
  <span style="color: #006600; font-style: italic;">// search twitter for the given string</span>
  <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">search</span> <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">function</span> <span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
    <span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">(</span>that.<span style="color: #660066;">searchTerm</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #339933;">!=</span> <span style="color: #3366CC;">""</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
&nbsp;
      that.<span style="color: #660066;">isSearching</span><span style="color: #009900;">(</span><span style="color: #003366; font-weight: bold;">true</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
      <span style="color: #000066; font-weight: bold;">var</span> url <span style="color: #339933;">=</span> <span style="color: #3366CC;">"http://search.twitter.com/search.json?q="</span> <span style="color: #339933;">+</span>
            encodeURIComponent<span style="color: #009900;">(</span>that.<span style="color: #660066;">searchTerm</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
      $.<span style="color: #660066;">ajax</span><span style="color: #009900;">(</span><span style="color: #009900;">{</span>
        dataType<span style="color: #339933;">:</span> <span style="color: #3366CC;">"jsonp"</span><span style="color: #339933;">,</span>
        url<span style="color: #339933;">:</span> url<span style="color: #339933;">,</span>
        success<span style="color: #339933;">:</span> <span style="color: #000066; font-weight: bold;">function</span> <span style="color: #009900;">(</span>response<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
          <span style="color: #006600; font-style: italic;">// clear the results</span>
          that.<span style="color: #660066;">tweets</span>.<span style="color: #660066;">removeAll</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
          <span style="color: #006600; font-style: italic;">// add the new items</span>
          $.<span style="color: #660066;">each</span><span style="color: #009900;">(</span>response.<span style="color: #660066;">results</span><span style="color: #339933;">,</span> <span style="color: #000066; font-weight: bold;">function</span> <span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
            <span style="color: #000066; font-weight: bold;">var</span> tweet <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">new</span> TweetViewModel<span style="color: #009900;">(</span><span style="color: #000066; font-weight: bold;">this</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
            that.<span style="color: #660066;">tweets</span>.<span style="color: #660066;">push</span><span style="color: #009900;">(</span>tweet<span style="color: #009900;">)</span><span style="color: #339933;">;</span>
          <span style="color: #009900;">}</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
          that.<span style="color: #660066;">isSearching</span><span style="color: #009900;">(</span><span style="color: #003366; font-weight: bold;">false</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
        <span style="color: #009900;">}</span>
      <span style="color: #009900;">}</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">}</span>
  <span style="color: #009900;">}</span>
<span style="color: #009900;">}</span></pre></td></tr></table></div><p>It comprises a few simple properties and a search function. Note, the <code>items</code> property is an <code>observableArray</code>, this is analogous to the WPF / Silverlight <code>ObservableCollection</code>, which raises events when its contents are modified, allowing the UI to update automatically. The <code>search</code> function queries the twitter APIs to find matching tweets, updating the observable <code>items</code> array with the results.</p><p>The <code>TwitterSearchViewModel</code> <code>items</code> collection is populated with <code>TweetViewModel</code> instances:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family: monospace;"><span style="color: #006600; font-style: italic;">/// &lt;summary&gt;</span>
<span style="color: #006600; font-style: italic;">/// A view model that represents a single tweet</span>
<span style="color: #006600; font-style: italic;">/// &lt;/summary&gt;</span>
<span style="color: #000066; font-weight: bold;">function</span> TweetViewModel<span style="color: #009900;">(</span>tweet<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
&nbsp;
    <span style="color: #006600; font-style: italic;">// --- properties</span>
&nbsp;
    <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">author</span> <span style="color: #339933;">=</span> tweet.<span style="color: #660066;">from_user</span><span style="color: #339933;">,</span>
    <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">text</span> <span style="color: #339933;">=</span> tweet.<span style="color: #660066;">text</span><span style="color: #339933;">,</span>
    <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">time</span> <span style="color: #339933;">=</span> parseDate<span style="color: #009900;">(</span>tweet.<span style="color: #660066;">created_at</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
    <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">thumbnail</span> <span style="color: #339933;">=</span> tweet.<span style="color: #660066;">profile_image_url</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #006600; font-style: italic;">// --- functions</span>
&nbsp;
    <span style="color: #006600; font-style: italic;">// parses the tweet date to give a more readable format</span>
    <span style="color: #000066; font-weight: bold;">function</span> parseDate<span style="color: #009900;">(</span>date<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
      <span style="color: #000066; font-weight: bold;">var</span> diff <span style="color: #339933;">=</span> <span style="color: #009900;">(</span><span style="color: #000066; font-weight: bold;">new</span> <span style="">Date</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #339933;">-</span> <span style="color: #000066; font-weight: bold;">new</span> <span style="">Date</span><span style="color: #009900;">(</span>date<span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #339933;">/</span> <span style="color: #CC0000;">1000</span><span style="color: #339933;">;</span>
&nbsp;
      <span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">(</span>diff <span style="color: #339933;">&lt;</span> <span style="color: #CC0000;">60</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
        <span style="color: #000066; font-weight: bold;">return</span> diff.<span style="color: #660066;">toFixed</span><span style="color: #009900;">(</span><span style="color: #CC0000;">0</span><span style="color: #009900;">)</span> <span style="color: #339933;">+</span> <span style="color: #3366CC;">" seconds ago"</span><span style="color: #339933;">;</span>
      <span style="color: #009900;">}</span>
&nbsp;
      diff <span style="color: #339933;">=</span> diff <span style="color: #339933;">/</span> <span style="color: #CC0000;">60</span><span style="color: #339933;">;</span>
      <span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">(</span>diff <span style="color: #339933;">&lt;</span> <span style="color: #CC0000;">60</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
        <span style="color: #000066; font-weight: bold;">return</span> diff.<span style="color: #660066;">toFixed</span><span style="color: #009900;">(</span><span style="color: #CC0000;">0</span><span style="color: #009900;">)</span> <span style="color: #339933;">+</span> <span style="color: #3366CC;">" minutes ago"</span><span style="color: #339933;">;</span>
      <span style="color: #009900;">}</span>
&nbsp;
      diff <span style="color: #339933;">=</span> diff <span style="color: #339933;">/</span> <span style="color: #CC0000;">60</span><span style="color: #339933;">;</span>
      <span style="color: #000066; font-weight: bold;">if</span> <span style="color: #009900;">(</span>diff <span style="color: #339933;">&lt;</span> <span style="color: #CC0000;">10</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
        <span style="color: #000066; font-weight: bold;">return</span> diff.<span style="color: #660066;">toFixed</span><span style="color: #009900;">(</span><span style="color: #CC0000;">0</span><span style="color: #009900;">)</span> <span style="color: #339933;">+</span> <span style="color: #3366CC;">" hours ago"</span><span style="color: #339933;">;</span>
      <span style="color: #009900;">}</span>
&nbsp;
      diff <span style="color: #339933;">=</span> diff <span style="color: #339933;">/</span> <span style="color: #CC0000;">24</span><span style="color: #339933;">;</span>
      <span style="color: #000066; font-weight: bold;">return</span> diff.<span style="color: #660066;">toFixed</span><span style="color: #009900;">(</span><span style="color: #CC0000;">0</span><span style="color: #009900;">)</span> <span style="color: #339933;">+</span> <span style="color: #3366CC;">" days ago"</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">}</span>
<span style="color: #009900;">}</span><span style="color: #339933;">;</span></pre></td></tr></table></div><p>Note, here the properties are <em>not</em> observables, again much like WPF / Silverlight you can bind to a property that does not notify of changes if this is not required.</p><p>Also, the Knockout documentation typically defines view-models as literal objects. I prefer to use <a href="http://groups.google.com/group/knockoutjs/browse_thread/thread/78ec2119146f6571">constructor functions</a>, allowing the creation of multiple instances of the same view model.</p><h3>The View</h3><p>With Knockout the view is defined in HTML, you can create it directly, or via a template. I have created the following templates:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="xml" style="font-family: monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;script</span> <span style="color: #000066;">type</span>=text/x-jquery-tmpl<span style="color: #ff0000;">" charset="</span>utf-8<span style="color: #ff0000;">" id="</span>twitterSearchView<span style="color: #ff0000;">"&gt;</span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;form</span> <span style="color: #000066;">data-bind</span>=<span style="color: #ff0000;">"submit: search"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;input</span> <span style="color: #000066;">data-bind</span>=<span style="color: #ff0000;">"value: searchTerm, valueUpdate: 'afterkeydown'"</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;button</span> <span style="color: #000066;">type</span>=<span style="color: #ff0000;">"submit"</span> <span style="color: #000066;">data-bind</span>=<span style="color: #ff0000;">"enable: searchTerm().length &gt;</span></span> 0 <span style="color: #ddbb00;">&amp;amp;&amp;amp;</span> isSearching() == false"&gt;Go<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/button<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>  
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/form<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>    
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;ul</span> <span style="color: #000066;">data-bind</span>=<span style="color: #ff0000;">"template: {name: 'tweetView', foreach: tweets}"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span> <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/ul<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/script<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre></td></tr></table></div><div class="wp_syntax"><table><tr><td class="code"><pre class="xml" style="font-family: monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;script</span> <span style="color: #000066;">type</span>=<span style="color: #ff0000;">"text/x-jquery-tmpl"</span> <span style="color: #000066;">charset</span>=<span style="color: #ff0000;">"utf-8"</span> <span style="color: #000066;">id</span>=<span style="color: #ff0000;">"tweetView"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;li</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">"tweet"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;div</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">"thumbnailColumn"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;img</span> <span style="color: #000066;">data-bind</span>=<span style="color: #ff0000;">"attr: { src: thumbnail }"</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">"thumbnail"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/div<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;div</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">"detailsColumn"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;div</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">"author"</span> <span style="color: #000066;">data-bind</span>=<span style="color: #ff0000;">"text: author"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span> 
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;div</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">"text"</span> <span style="color: #000066;">data-bind</span>=<span style="color: #ff0000;">"text: text"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span> 
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;div</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">"time"</span> <span style="color: #000066;">data-bind</span>=<span style="color: #ff0000;">"text: time"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span> 
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/div<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/li<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/script<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre></td></tr></table></div><p>The <code>data-bind</code> attribute is used by Knockout to set up the various bindings, connecting your view model properties and observables to the UI.It also defines functions to invoke when DOM events are raised, in much the same way as commands do in WPF / Silverlight.</p><h3>The application code</h3><p>Instantiating the view-model and the view is as simple as the following:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family: monospace;">$<span style="color: #009900;">(</span>document<span style="color: #009900;">)</span>.<span style="color: #660066;">ready</span><span style="color: #009900;">(</span><span style="color: #000066; font-weight: bold;">function</span> <span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
  document.<span style="color: #660066;">addEventListener</span><span style="color: #009900;">(</span><span style="color: #3366CC;">"deviceready"</span><span style="color: #339933;">,</span> onDeviceReady<span style="color: #339933;">,</span> <span style="color: #003366; font-weight: bold;">false</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #006600; font-style: italic;">// phonegap is initialised</span>
<span style="color: #000066; font-weight: bold;">function</span> onDeviceReady<span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
&nbsp;
  <span style="color: #006600; font-style: italic;">// create the view model</span>
  twitterSearchViewModel <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">new</span> TwitterSearchViewModel<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #006600; font-style: italic;">// create an instance of the view</span>
  $<span style="color: #009900;">(</span><span style="color: #3366CC;">"#twitterSearchView"</span><span style="color: #009900;">)</span>.<span style="color: #660066;">tmpl</span><span style="color: #009900;">(</span><span style="color: #3366CC;">""</span><span style="color: #009900;">)</span>.<span style="color: #660066;">appendTo</span><span style="color: #009900;">(</span><span style="color: #3366CC;">"#app"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #006600; font-style: italic;">// wire-up</span>
  ko.<span style="color: #660066;">applyBindings</span><span style="color: #009900;">(</span>twitterSearchViewModel<span style="color: #009900;">)</span>
<span style="color: #009900;">}</span></pre></td></tr></table></div><p>Originally I wanted to have the HTML for each view within a separate file, loading them via jQuery as <a href="http://www.knockmeout.net/2011/03/using-external-jquery-template-files.html">described in this blog post</a>. However, I just couldn’t get this to work within the embedded WP7 browser.</p><p>The <code>tweetView</code> tempate is used via the <code>template </code>/ <code>foreach</code> Knockout binding, mimicking the Silverlight / WPF <code>ItemsControl.ItemTemplate</code> concept.</p><p>The application, after a bit of styling, looks like this:</p><p><img src="http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2011/10/PhoneGapTwitterSearch.png" alt="" title="PhoneGapTwitterSearch" width="300" height="546" class="aligncenter size-full wp-image-1793" /></p><h2>Tombstoning</h2><p>Now that the application has a decent structure, we can tackle the application-lifecycle. We need a way to store the view model state when the application transitions into a dormant state. Fortunately Knockout makes this very easy by supplying a <code>toJSON</code> function, which can create a JSON representation of your view-model graph (minus the observables). I have added a <code>getState</code> function to the <code>TwitterSearchViewModel</code> as follows:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family: monospace;"><span style="color: #006600; font-style: italic;">// gets the view model state as a JSON string</span>
<span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">getState</span> <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">function</span> <span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
  <span style="color: #000066; font-weight: bold;">return</span> ko.<span style="color: #660066;">toJSON</span><span style="color: #009900;">(</span><span style="color: #000066; font-weight: bold;">this</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td></tr></table></div><p>Now we need a way to invoke this function when the application pauses. PhoneGap provides a <code>pause</code> lifecycle event, however, we need to store the output of this function in the WP7 <code>PhoneApplicationService.Current.State</code> dictionary. Because this is a very much WP7 specific feature, I decided to do this outside of the PhoneGap lifecycle events.</p><p>My handler for the <code>Deactivated </code>event simply invokes the above method, storing the state in the application state dictionary:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">void</span> Application_Deactivated<span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">object</span> sender, DeactivatedEventArgs e<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
  <span style="color: #0600FF; font-weight: bold;">var</span> viewModelState <span style="color: #008000;">=</span> PhoneGapView<span style="color: #008000;">.</span><span style="color: #0000FF;">Browser</span><span style="color: #008000;">.</span><span style="color: #0000FF;">InvokeScript</span><span style="color: #008000;">(</span><span style="color: #666666;">"getState"</span><span style="color: #008000;">)</span> <span style="color: #0600FF; font-weight: bold;">as</span> <span style="color: #6666cc; font-weight: bold;">string</span><span style="color: #008000;">;</span>
  PhoneApplicationService<span style="color: #008000;">.</span><span style="color: #0000FF;">Current</span><span style="color: #008000;">.</span><span style="color: #0000FF;">State</span><span style="color: #008000;">[</span>ModelKey<span style="color: #008000;">]</span> <span style="color: #008000;">=</span> viewModelState<span style="color: #008000;">;</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>Note, to do this I have had to modify the current PhoneGap WP7 library to provide access to the underlying WebBrowser control, I have <a href="https://github.com/phonegap/phonegap-wp7/issues/35">raised an issue requesting this change to the PhoenGap library</a>.</p><p>The application now stores it state when it becomes dormant, the next step is to use this state when an application is activated from a tombstoned state. Within the <code>Activated</code> handler we can read this state as follows:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #008080; font-style: italic;">/// &lt;summary&gt;</span>
<span style="color: #008080; font-style: italic;">/// Gets the state that has been retrieved from isolated storage</span>
<span style="color: #008080; font-style: italic;">/// in order to re-activated after tombstoning.</span>
<span style="color: #008080; font-style: italic;">/// &lt;/summary&gt;</span>
<span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">string</span> TombstoneState <span style="color: #008000;">{</span> <span style="color: #0600FF; font-weight: bold;">get</span><span style="color: #008000;">;</span> <span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #0600FF; font-weight: bold;">set</span><span style="color: #008000;">;</span> <span style="color: #008000;">}</span>
&nbsp;
<span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">void</span> Application_Activated<span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">object</span> sender, ActivatedEventArgs e<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
  <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span><span style="color: #008000;">!</span>e<span style="color: #008000;">.</span><span style="color: #0000FF;">IsApplicationInstancePreserved</span><span style="color: #008000;">)</span>
  <span style="color: #008000;">{</span>
    <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>PhoneApplicationService<span style="color: #008000;">.</span><span style="color: #0000FF;">Current</span><span style="color: #008000;">.</span><span style="color: #0000FF;">State</span><span style="color: #008000;">.</span><span style="color: #0000FF;">ContainsKey</span><span style="color: #008000;">(</span>ModelKey<span style="color: #008000;">)</span><span style="color: #008000;">)</span>
    <span style="color: #008000;">{</span>
      <span style="color: #0600FF; font-weight: bold;">var</span> viewModelState <span style="color: #008000;">=</span> PhoneApplicationService<span style="color: #008000;">.</span><span style="color: #0000FF;">Current</span><span style="color: #008000;">.</span><span style="color: #0000FF;">State</span><span style="color: #008000;">[</span>ModelKey<span style="color: #008000;">]</span> <span style="color: #0600FF; font-weight: bold;">as</span> <span style="color: #6666cc; font-weight: bold;">string</span><span style="color: #008000;">;</span>
      TombstoneState <span style="color: #008000;">=</span> viewModelState<span style="color: #008000;">;</span>
    <span style="color: #008000;">}</span>
  <span style="color: #008000;">}</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>Note, we check <code>IsApplicationInstancePreserved</code>, if this is true, we do not need to use the state that was saved during deactivation, this allows for fast-application switching. </p><p>Unfortunately as this point our UI has not been created and our JavaScript application code is not running, which is why the tombstoned state is simply stored in a public property of our application. To pick this state up, we add a new step to our JavaScript view model creation code:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family: monospace;"><span style="color: #006600; font-style: italic;">// phonegap is initialised</span>
<span style="color: #000066; font-weight: bold;">function</span> onDeviceReady<span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
&nbsp;
  <span style="color: #006600; font-style: italic;">// create the view model</span>
  twitterSearchViewModel <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">new</span> TwitterSearchViewModel<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #006600; font-style: italic;">// ---&gt; check for tombstoned state</span>
  window.<span style="color: #660066;">external</span>.<span style="color: #660066;">Notify</span><span style="color: #009900;">(</span><span style="color: #3366CC;">"getState"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #006600; font-style: italic;">// instantiate the view an bind</span>
  $<span style="color: #009900;">(</span><span style="color: #3366CC;">"#twitterSearchView"</span><span style="color: #009900;">)</span>.<span style="color: #660066;">tmpl</span><span style="color: #009900;">(</span><span style="color: #3366CC;">""</span><span style="color: #009900;">)</span>.<span style="color: #660066;">appendTo</span><span style="color: #009900;">(</span><span style="color: #3366CC;">"#app"</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
  ko.<span style="color: #660066;">applyBindings</span><span style="color: #009900;">(</span>twitterSearchViewModel<span style="color: #009900;">)</span>
<span style="color: #009900;">}</span></pre></td></tr></table></div><p>When the PhoneGap view is created, we add a handler to the <code>ScriptNotify</code> event, allowing us to handle this <code>getState </code>notification:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #008080; font-style: italic;">// Constructor</span>
<span style="color: #0600FF; font-weight: bold;">public</span> MainPage<span style="color: #008000;">(</span><span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
  InitializeComponent<span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
  phoneGapView<span style="color: #008000;">.</span><span style="color: #0000FF;">Browser</span><span style="color: #008000;">.</span><span style="color: #0000FF;">ScriptNotify</span> <span style="color: #008000;">+=</span> Browser_ScriptNotify<span style="color: #008000;">;</span>
<span style="color: #008000;">}</span>
&nbsp;
&nbsp;
<span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">void</span> Browser_ScriptNotify<span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">object</span> sender, NotifyEventArgs e<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
  <span style="color: #6666cc; font-weight: bold;">string</span> commandStr <span style="color: #008000;">=</span> e<span style="color: #008000;">.</span><span style="color: #0600FF; font-weight: bold;">Value</span><span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>commandStr <span style="color: #008000;">==</span> <span style="color: #666666;">"getState"</span> <span style="color: #008000;">&amp;&amp;</span> App<span style="color: #008000;">.</span><span style="color: #0000FF;">Current</span><span style="color: #008000;">.</span><span style="color: #0000FF;">TombstoneState</span> <span style="color: #008000;">!=</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">)</span>
  <span style="color: #008000;">{</span>
    phoneGapView<span style="color: #008000;">.</span><span style="color: #0000FF;">Browser</span><span style="color: #008000;">.</span><span style="color: #0000FF;">InvokeScript</span><span style="color: #008000;">(</span><span style="color: #666666;">"setState"</span>, <span style="color: #008000;">new</span> <span style="color: #6666cc; font-weight: bold;">string</span><span style="color: #008000;">[</span><span style="color: #008000;">]</span> <span style="color: #008000;">{</span> App<span style="color: #008000;">.</span><span style="color: #0000FF;">Current</span><span style="color: #008000;">.</span><span style="color: #0000FF;">TombstoneState</span> <span style="color: #008000;">}</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
  <span style="color: #008000;">}</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>This checks for the presence of tombstone state, and if found, invokes setState back on our JavaScript view model:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family: monospace;"><span style="color: #006600; font-style: italic;">// sets the view model state based on the given JSON string.</span>
<span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">setState</span> <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">function</span> <span style="color: #009900;">(</span>stateString<span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
  <span style="color: #000066; font-weight: bold;">var</span> state <span style="color: #339933;">=</span> $.<span style="color: #660066;">parseJSON</span><span style="color: #009900;">(</span>stateString<span style="color: #009900;">)</span><span style="color: #339933;">,</span>
      that <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">this</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">isSearching</span><span style="color: #009900;">(</span>state.<span style="color: #660066;">isSearching</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
  <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">searchTerm</span><span style="color: #009900;">(</span>state.<span style="color: #660066;">searchTerm</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #000066; font-weight: bold;">this</span>.<span style="color: #660066;">tweets</span>.<span style="color: #660066;">removeAll</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
  $.<span style="color: #660066;">each</span><span style="color: #009900;">(</span>state.<span style="color: #660066;">tweets</span><span style="color: #339933;">,</span> <span style="color: #000066; font-weight: bold;">function</span> <span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
    that.<span style="color: #660066;">tweets</span>.<span style="color: #660066;">push</span><span style="color: #009900;">(</span><span style="color: #000066; font-weight: bold;">this</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">}</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td></tr></table></div><p>Note, re-creating our view-model form JSON data is a little more involved than the opposite. I have also cheated a little here, rather than re-creating each <code>TweetViewModel</code> I am using the JSON representation, because this view model has no public functions (i.e. commands).</p><h2>Conclusions</h2><p>With the above code the PhoneGap application now successfully handles all of the WP7 lifecycle states and transitions. There are a couple of things to note if you try to run this code yourself:</p><ol>
<li>You can force tombstoning via the Debug properties, “Tombstone upon deactiviation while debugging”.</li>
<li>I have fund that the WebBrowser on the emulator does not tombstone correctly, when your application resumes the WebBrowser control fails to execute <strong>any</strong> JavaScript! Fortunately on  a real device it works just fine.</li>
</ol><p>Now that I can tombstone a PhoneGap application, I feel that it is one step closer to be a viable solution for application development. The final thing that I still haven’t quite worked out yet is navigation and back-button support. Fortunately Knockout has a lot to offer in this area as well, but more on that later …</p><p>You can download the full sourcecode (including PhoneGap library mods) here: <a href="{{ site.url }}/blog/colin/wp-content/uploads/2011/10/PhoneGapExample.zip">PhoneGapExample.zip</a></p><p>Regards, Colin E.</p></div>