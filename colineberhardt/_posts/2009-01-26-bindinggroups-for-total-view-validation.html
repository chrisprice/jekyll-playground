---
author: Colin Eberhardt
tags: validation, WPF
permalink: /blog/colin/2009/01/bindinggroups-for-total-view-validation/index.html
layout: colineberhardt-blog
---
<div class="entry"><div class="topsy_widget_data topsy_theme_light-green" style="float: right; margin-left: 0.75em; background: url(data:,%7B%20%22url%22%3A%20%22http%253A%252F%252Fwww.scottlogic.co.uk%252Fblog%252Fcolin%252F2009%252F01%252Fbindinggroups-for-total-view-validation%252F%22%2C%20%22style%22%3A%20%22big%22%2C%20%22title%22%3A%20%22BindingGroups%20for%20Total%20View%20Validation%20%23%22%20%7D);"></div><p>Over the weekend Sacha published a new article on codeproject, <a href="http://www.codeproject.com/KB/WPF/GlobalWPFValidation.aspx">Total View Validation</a> (does Sacha ever sleep?).  This article addresses some of the perceived problems with the WPF binding framework, firstly, that the standard solution of using the <a href="http://msdn.microsoft.com/en-us/library/system.windows.data.binding.validatesondataerrors.aspx">ValidatesOnDataErrors</a> property forces you to place validation logic into your bound business objects, and secondly, that there is no way to perform validation across multiple objects. His solution to both these problems was to construct a view model which contains the validation rules and applies them to all the objects within the form. A collection of validation failures are associated with the view model. These can either be rendered in their entirety or each control within the view can render errors relating to their context.</p><p>This blog post describes how BindingGroups can be used to address the problem of applying validation rules to multiple objects.</p><p>BindingGroups were introduced as part of .NET 3.5 SP1, Vincent Sibal provides a good introduction to this new features <a href="http://blogs.msdn.com/vinsibal/archive/2008/08/11/wpf-3-5-sp1-feature-bindinggroups-with-item-level-validation.aspx">on his blog</a>. I have previously blogged on the subject of BindingGroups, where I demonstrated how they can be used to provide <a href="{{ site.url }}/blog/colin/2008/11/using-bindinggroups-for-greater-control-over-input-validation/"> improved error messages when type conversion fails during the binding process</a>.</p><p>In this post I will take the application from Sacha’s article and modify it to use BindingGroups. The following is a screenshot of the application:</p><p><img class="alignnone size-full wp-image-93" title="form" src="http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2009/01/form.png" alt="form" width="302" height="415" /></p><p>The form displays the details of two People (two instances of the Person class). The user inputs data using the above controls then clicks the Validate button to run all the Form’s validation rules. Most of the validation rules relate to a single property of the bound object, e.g. FullName cannot be empty. However there is one trick validation rule:</p><p><strong>“If Person 1′s age is less than 18, Person 2′s age cannot be zero”</strong></p><p>This rule cannot be evaluated by assocaiting it with the Age property of either person. It requires access to both Person instances, hence it really belongs at the scope of the form itself. This is where BindingGroups come in …</p><p>The XAML below shows our form which consists of a pair of StackPanels that contain fields bound to our Person instances by setting their DataContext properties in the code-behind. The ‘root’ element of the Window contains our BindingGroup.</p><div class="wp_syntax"><table><tr><td class="code"><pre class="xml" style="font-family: monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;StackPanel</span> <span style="color: #000066;">Name</span>=<span style="color: #ff0000;">"RootElement"</span> <span style="color: #000066;">Orientation</span>=<span style="color: #ff0000;">"Vertical"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
    <span style="color: #808080; font-style: italic;">&lt;!-- the binding group for this form --&gt;</span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;StackPanel.BindingGroup<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;BindingGroup</span> <span style="color: #000066;">Name</span>=<span style="color: #ff0000;">"FormBindingGroup"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
            <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;BindingGroup.ValidationRules<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
                <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;local:PersonValidationRule</span></span>
<span style="color: #009900;">                            <span style="color: #000066;">ValidationStep</span>=<span style="color: #ff0000;">"CommittedValue"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
            <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/BindingGroup.ValidationRules<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/BindingGroup<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/StackPanel.BindingGroup<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
&nbsp;
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Border<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
&nbsp;
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;StackPanel</span> <span style="color: #000066;">Orientation</span>=<span style="color: #ff0000;">"Vertical"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
&nbsp;
            <span style="color: #808080; font-style: italic;">&lt;!-- Person One fields --&gt;</span>
            <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;StackPanel</span> <span style="color: #000066;">Name</span>=<span style="color: #ff0000;">"personOnePanel"</span> <span style="color: #000066;">Orientation</span>=<span style="color: #ff0000;">"Vertical"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
                <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Label</span> <span style="color: #000066;">Content</span>=<span style="color: #ff0000;">"Person1"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
&nbsp;
                <span style="color: #808080; font-style: italic;">&lt;!-- FirstName Property--&gt;</span>
                <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;StackPanel</span> <span style="color: #000066;">Orientation</span>=<span style="color: #ff0000;">"Horizontal"</span> <span style="color: #000000; font-weight: bold;">&gt;</span></span>
                    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Label</span> <span style="color: #000066;">Content</span>=<span style="color: #ff0000;">"FirstName"</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>
                    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;TextBox</span> <span style="color: #000066;">Text</span>=<span style="color: #ff0000;">"{Binding Path=FirstName, </span>
<span style="color: #009900;">                                           BindingGroupName=FormBindingGroup,</span>
<span style="color: #009900;">                                           ValidatesOnDataErrors=true}"</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>                            
                <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/StackPanel<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
&nbsp;
                <span style="color: #808080; font-style: italic;">&lt;!-- LastName Property--&gt;</span>
                ...
            <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/StackPanel<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
&nbsp;
            <span style="color: #808080; font-style: italic;">&lt;!-- Person Twofields --&gt;</span>
            <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;StackPanel</span> <span style="color: #000066;">Name</span>=<span style="color: #ff0000;">"personTwoPanel"</span>  <span style="color: #000066;">Orientation</span>=<span style="color: #ff0000;">"Vertical"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
                <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Label</span> <span style="color: #000066;">Content</span>=<span style="color: #ff0000;">"Person2"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
&nbsp;
                <span style="color: #808080; font-style: italic;">&lt;!-- FirstName Property--&gt;</span>
                <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;StackPanel</span> <span style="color: #000066;">Orientation</span>=<span style="color: #ff0000;">"Horizontal"</span> <span style="color: #000000; font-weight: bold;">&gt;</span></span>
                    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Label</span> <span style="color: #000066;">Content</span>=<span style="color: #ff0000;">"FirstName"</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>
                    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;TextBox</span> <span style="color: #000066;">Text</span>=<span style="color: #ff0000;">"{Binding Path=FirstName, </span>
<span style="color: #009900;">                                           BindingGroupName=FormBindingGroup,</span>
<span style="color: #009900;">                                           ValidatesOnDataErrors=true}"</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>                            
                <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/StackPanel<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
&nbsp;
                <span style="color: #808080; font-style: italic;">&lt;!-- LastName Property--&gt;</span>
                ...
            <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/StackPanel<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
&nbsp;
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/StackPanel<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
&nbsp;
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Border<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
&nbsp;
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;StackPanel</span> <span style="color: #000066;">Orientation</span>=<span style="color: #ff0000;">"Vertical"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
&nbsp;
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Button</span> <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"btnValidate"</span> <span style="color: #000066;">Content</span>=<span style="color: #ff0000;">"Validate"</span> <span style="color: #000066;">Margin</span>=<span style="color: #ff0000;">"5"</span>  <span style="color: #000000; font-weight: bold;">/&gt;</span></span>
&nbsp;
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/StackPanel<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/StackPanel<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre></td></tr></table></div><p>Rules associated with a BindingGroup have access to both their associated binding expressions, and the source objects used by these bindings. A BindingGroup becomes associated with a collection of binding expressions if it shares the same DataContext. However, in the above example we have a pair of objects, therefore we cannot share a DataContext across all the elements in our XAML (this is not strictly true, we could construct a view model for this purpose, however I really want to illustrate one of the other features of BindingGroups). BindingGroups can also be explicitly associated with a Binding via its BindingGroupName property.</p><p>So just what exactly can we do with our BindingGroup? It is possible to execute this rule at various different steps of the binding process, for example, it is possible to evaluate the rule before type conversion has occurred. In this instance, we are only interested in the converted value, hence the ValidationStep property is set to CommittedValue. The rule itself is very simple:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">class</span> PersonValidationRule <span style="color: #008000;">:</span> ValidationRule
<span style="color: #008000;">{</span>
    <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #0600FF; font-weight: bold;">override</span> ValidationResult Validate<span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">object</span> <span style="color: #0600FF; font-weight: bold;">value</span>, CultureInfo cultureInfo<span style="color: #008000;">)</span>
    <span style="color: #008000;">{</span>
        BindingGroup bindingGroup <span style="color: #008000;">=</span> <span style="color: #008000;">(</span>BindingGroup<span style="color: #008000;">)</span><span style="color: #0600FF; font-weight: bold;">value</span><span style="color: #008000;">;</span>
&nbsp;
        <span style="color: #008080; font-style: italic;">// extract the two bound Person instances.</span>
        Person personOne <span style="color: #008000;">=</span> bindingGroup<span style="color: #008000;">.</span><span style="color: #0000FF;">Items</span><span style="color: #008000;">[</span><span style="color: #FF0000;">0</span><span style="color: #008000;">]</span> <span style="color: #0600FF; font-weight: bold;">as</span> Person<span style="color: #008000;">;</span>
        Person personTwo <span style="color: #008000;">=</span> bindingGroup<span style="color: #008000;">.</span><span style="color: #0000FF;">Items</span><span style="color: #008000;">[</span><span style="color: #FF0000;">1</span><span style="color: #008000;">]</span> <span style="color: #0600FF; font-weight: bold;">as</span> Person<span style="color: #008000;">;</span>
&nbsp;
        <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">(</span>personTwo<span style="color: #008000;">.</span><span style="color: #0000FF;">Age</span><span style="color: #008000;">==</span><span style="color: #FF0000;">0</span> <span style="color: #008000;">&amp;&amp;</span> personOne<span style="color: #008000;">.</span><span style="color: #0000FF;">Age</span><span style="color: #008000;">&lt;</span><span style="color: #FF0000;">18</span><span style="color: #008000;">)</span>
        <span style="color: #008000;">{</span>
            <span style="color: #0600FF; font-weight: bold;">return</span> <span style="color: #008000;">new</span> ValidationResult<span style="color: #008000;">(</span><span style="color: #0600FF; font-weight: bold;">false</span>,
                     <span style="color: #666666;">"Person 2 Age can't be zero if Person1 Age &lt; 18"</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
        <span style="color: #008000;">}</span>           
&nbsp;
        <span style="color: #0600FF; font-weight: bold;">return</span> ValidationResult<span style="color: #008000;">.</span><span style="color: #0000FF;">ValidResult</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">}</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>We simply retrieve both Person instances, apply our rule raising an error if our condition is not met. Any validation errors returned by the BindingGroup become associated with the <a href="http://msdn.microsoft.com/en-us/library/system.windows.controls.validation.errors.aspx">Validation.Errors</a> attached property of the element which the BindingGroup is associated with. Therefore they can be accessed and styled in the ‘standard’ way, for example:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="xml" style="font-family: monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Style</span> <span style="color: #000066;">TargetType</span>=<span style="color: #ff0000;">"{x:Type TextBox}"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Style.Triggers<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Trigger</span> <span style="color: #000066;">Property</span>=<span style="color: #ff0000;">"Validation.HasError"</span> <span style="color: #000066;">Value</span>=<span style="color: #ff0000;">"true"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
            <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Setter</span> <span style="color: #000066;">Property</span>=<span style="color: #ff0000;">"ToolTip"</span></span>
<span style="color: #009900;">                <span style="color: #000066;">Value</span>=<span style="color: #ff0000;">"{Binding RelativeSource={RelativeSource Self}, </span>
<span style="color: #009900;">                       Path=(Validation.Errors)[0].ErrorContent}"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Trigger<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Style.Triggers<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Style<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre></td></tr></table></div><p>See the excellent article <a href="http://www.codeproject.com/KB/WPF/wpfvalidation.aspx">Validation in WPF</a> for details. </p><p>However, BindingGroups offer one further advantage, validation errors from the associated binding expressions are also placed in the Validation.Errors collection, therefore we can output all the validation errors for our form by binding to this property as follows:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="xml" style="font-family: monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;ItemsControl</span> <span style="color: #000066;">ItemsSource</span>=<span style="color: #ff0000;">"{Binding Path=(Validation.Errors), ElementName=RootElement}"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;ItemsControl.ItemTemplate<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;DataTemplate<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
            <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Label</span> <span style="color: #000066;">Foreground</span>=<span style="color: #ff0000;">"Red"</span> <span style="color: #000066;">Content</span>=<span style="color: #ff0000;">"{Binding Path=ErrorContent}"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/DataTemplate<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/ItemsControl.ItemTemplate<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/ItemsControl<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre></td></tr></table></div><p>The following screenshot shows the form where multiple validation errors are present:</p><p><img src="http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2009/01/errors.png" alt="errors" title="errors" width="292" height="484" class="alignnone size-full wp-image-95" /></p><p><b>Conclusions</b></p><p>So … which approach is better? BindingGroups or Sacha’s ViewModel technique?</p><p>Personally, I don’t think there is one best approach – and this blog post is certainly not an attack on Sacha’s article, which presents an elegant solution. My intention is to simply show that it is possible to perform validation on multiple objects at a ‘wider’ scope with the standard WPF framework. </p><p>To quote Mike Hillberg, the <a href="http://blogs.msdn.com/mikehillberg/archive/2008/05/21/Model-see_2C00_-model-do.aspx">Poo is Optional</a>.</p><p>A sample project with the code from this post is available for download: <a href="{{ site.url }}/blog/colin/wp-content/uploads/2009/01/bindinggroupsglobalvalidation.zip">bindinggroupsglobalvalidation.zip</a>.</p><p>Regards, Colin E.</p></div>