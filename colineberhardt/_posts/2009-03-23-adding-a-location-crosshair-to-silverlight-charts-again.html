---
author: Colin Eberhardt
tags: charts, silverlight
permalink: /blog/colin/2009/03/adding-a-location-crosshair-to-silverlight-charts-again/index.html
layout: colineberhardt-blog
---
<div class="entry"><div class="topsy_widget_data topsy_theme_light-green" style="float: right; margin-left: 0.75em; background: url(data:,%7B%20%22url%22%3A%20%22http%253A%252F%252Fwww.scottlogic.co.uk%252Fblog%252Fcolin%252F2009%252F03%252Fadding-a-location-crosshair-to-silverlight-charts-again%252F%22%2C%20%22style%22%3A%20%22big%22%2C%20%22title%22%3A%20%22Adding%20a%20Location%20Crosshair%20to%20Silverlight%20charts%20%28again%21%29%20%23%22%20%7D);"></div><p>Silverlight is moving fast. Really fast. The recent <a href="http://live.visitmix.com/">MIX09</a> conference saw the release of Silverlight 3 (Beta) and also a new release of the <a href="http://blogs.msdn.com/delay/archive/2009/03/19/silverlight-charting-is-faster-and-better-than-ever-silverlight-toolkit-march-09-release-now-available.aspx">Silverlight Toolkit</a>. All this change is making it hard for us bloggers to keep up!</p><p>Just over a month ago I posted an article on this blog about how to add <a href="{{ site.url }}/blog/colin/2009/02/adding-a-location-crosshair-to-silverlight-charts/">a location crosshair</a> to the Silverlight Toolkit Charts. This blog post briefly discusses how the charts have changed with the release last week, and updates the code accordingly.</p><p>If you want to know how the general approach works, I would recommend reading the <a href="{{ site.url }}/blog/colin/2009/02/adding-a-location-crosshair-to-silverlight-charts/">previous blog post</a>, this post serves as an update and discussion on how the chart template has changed.</p><p>There have been a number of minor changes to the charts that affect my previous implementation, including a change of namespace and orientation type on the chart axes. However, the biggest change is in the template of the chart control itself. Previously the chart template was structured via a Grid as shown below:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="xml" style="font-family: monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;ControlTemplate</span> <span style="color: #000066;">TargetType</span>=<span style="color: #ff0000;">"charting:Chart"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Grid</span> <span style="color: #000066;">Name</span>=<span style="color: #ff0000;">"ChartArea"</span> <span style="color: #000066;">Style</span>=<span style="color: #ff0000;">"{TemplateBinding ChartAreaStyle}"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
&nbsp;
        <span style="color: #808080; font-style: italic;">&lt;!-- ##### chart control adds column / row definitions and axes here #### --&gt;</span>
&nbsp;
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Grid</span> <span style="color: #000066;">Height</span>=<span style="color: #ff0000;">"250"</span> <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"PlotArea"</span> <span style="color: #000066;">Style</span>=<span style="color: #ff0000;">"{TemplateBinding PlotAreaStyle}"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
&nbsp;
            <span style="color: #808080; font-style: italic;">&lt;!-- the standard chart template components --&gt;</span>
            <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Grid</span> <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"GridLinesContainer"</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>
            <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Grid</span> <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"SeriesContainer"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
            <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Border</span> <span style="color: #000066;">BorderBrush</span>=<span style="color: #ff0000;">"#FF919191"</span> <span style="color: #000066;">BorderThickness</span>=<span style="color: #ff0000;">"1"</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>
&nbsp;
            <span style="color: #808080; font-style: italic;">&lt;!-- ##### I added cross hair and legend here #### --&gt;</span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Grid<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Grid<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/ControlTemplate<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre></td></tr></table></div><p>After loading the template the chart adds the axes and the appropriate column / row definitions. This leaves us free to add new visual content withing the ‘PlotArea’ grid. Inspecting the visual tree, with <a href="http://silverlightspy.com/silverlightspy/">Silverlight Spy</a>, it look like the following:</p><p><a href="{{ site.url }}/blog/colin/wp-content/uploads/2009/03/visualtree-before.png"><img src="http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2009/03/visualtree-before.png" alt="visualtree-before" title="visualtree-before" width="292" height="220" class="alignnone size-full wp-image-221" /></a></p><p>The content I added in order to construct a crosshair and legend are highlighted in red.</p><p>The March release of the Silverlight toolkit modifies the way in which axes are added to the chart by the introduction of a new layout panel, the EdgePanel (think DockPanel!). This panel allows you to locate (or dock) elements at one of the four edges of a panel or the panel centre. The modified control template is show below:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="xml" style="font-family: monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;ControlTemplate</span> <span style="color: #000066;">TargetType</span>=<span style="color: #ff0000;">"charting:Chart"</span> <span style="color: #000066;">x:Key</span>=<span style="color: #ff0000;">"ChartTemplate"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Grid</span> <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"ChartRoot"</span> <span style="color: #000066;">Style</span>=<span style="color: #ff0000;">"{TemplateBinding PlotAreaStyle}"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
&nbsp;
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;chartingprimitives:EdgePanel</span> <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"ChartArea"</span> <span style="color: #000066;">Style</span>=<span style="color: #ff0000;">"{TemplateBinding ChartAreaStyle}"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>                                   
&nbsp;
            <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Grid</span> <span style="color: #000066;">Canvas.ZIndex</span>=<span style="color: #ff0000;">"1"</span> <span style="color: #000066;">Style</span>=<span style="color: #ff0000;">"{TemplateBinding PlotAreaStyle}"</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>
            <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Border</span> <span style="color: #000066;">Canvas.ZIndex</span>=<span style="color: #ff0000;">"1"</span> <span style="color: #000066;">BorderBrush</span>=<span style="color: #ff0000;">"#FF919191"</span> <span style="color: #000066;">BorderThickness</span>=<span style="color: #ff0000;">"1"</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>
&nbsp;
            <span style="color: #808080; font-style: italic;">&lt;!-- ##### I added cross hair and legend here #### --&gt;</span>
&nbsp;
            <span style="color: #808080; font-style: italic;">&lt;!-- ##### chart control adds column / row definitions and axes here #### --&gt;</span>
&nbsp;
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/chartingprimitives:EdgePanel<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Grid<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/ControlTemplate<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre></td></tr></table></div><p>I have indicated the location where I add my own visual content and also the location where the chart control adds the axes. The resulting visual tree is shown below:</p><p><a href="{{ site.url }}/blog/colin/wp-content/uploads/2009/03/visualtree-after.png"><img src="http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2009/03/visualtree-after.png" alt="visualtree-after" title="visualtree-after" width="340" height="256" class="alignnone size-full wp-image-223" /></a></p><p>The significant difference here is that all the components of our chart are contained within the same EdgePanel, with their location dictated by their EdgePanel.Edge property. One problem this does introduce for us is that of Z-ordering, previously our additional content was top of the stack, now it sits somewhere in between. Fortunately EdgePanel honours the Canvas.ZIndex attached property allowing us to push our content to the top. The modified template is given below in full:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="xml" style="font-family: monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;ControlTemplate</span> <span style="color: #000066;">TargetType</span>=<span style="color: #ff0000;">"charting:Chart"</span> <span style="color: #000066;">x:Key</span>=<span style="color: #ff0000;">"ChartTemplate"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Grid</span> <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"ChartRoot"</span> <span style="color: #000066;">Style</span>=<span style="color: #ff0000;">"{TemplateBinding PlotAreaStyle}"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
&nbsp;
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;chartingprimitives:EdgePanel</span> <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"ChartArea"</span> <span style="color: #000066;">Style</span>=<span style="color: #ff0000;">"{TemplateBinding ChartAreaStyle}"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>                                   
&nbsp;
            <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Grid</span> <span style="color: #000066;">Canvas.ZIndex</span>=<span style="color: #ff0000;">"-1"</span> <span style="color: #000066;">Style</span>=<span style="color: #ff0000;">"{TemplateBinding PlotAreaStyle}"</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>
            <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Border</span> <span style="color: #000066;">Canvas.ZIndex</span>=<span style="color: #ff0000;">"3"</span> <span style="color: #000066;">BorderBrush</span>=<span style="color: #ff0000;">"#FF919191"</span> <span style="color: #000066;">BorderThickness</span>=<span style="color: #ff0000;">"1"</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>
&nbsp;
            <span style="color: #808080; font-style: italic;">&lt;!-- a location crosshair --&gt;</span>
            <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Grid</span> <span style="color: #000066;">Name</span>=<span style="color: #ff0000;">"CrosshairContainer"</span> <span style="color: #000066;">Canvas.ZIndex</span>=<span style="color: #ff0000;">"1"</span> <span style="color: #000066;">Background</span>=<span style="color: #ff0000;">"Transparent"</span></span>
<span style="color: #009900;">                 <span style="color: #000066;">MouseMove</span>=<span style="color: #ff0000;">"CrosshairContainer_MouseMove"</span> <span style="color: #000066;">MouseEnter</span>=<span style="color: #ff0000;">"CrosshairContainer_MouseEnter"</span></span>
<span style="color: #009900;">                 <span style="color: #000066;">MouseLeave</span>=<span style="color: #ff0000;">"CrosshairContainer_MouseLeave"</span> <span style="color: #000000; font-weight: bold;">&gt;</span></span>
                <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Grid</span> <span style="color: #000066;">Name</span>=<span style="color: #ff0000;">"Crosshair"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
                    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Line</span> <span style="color: #000066;">Name</span>=<span style="color: #ff0000;">"Vertical"</span> <span style="color: #000066;">X1</span>=<span style="color: #ff0000;">"{Binding Path=X}"</span> <span style="color: #000066;">Y1</span>=<span style="color: #ff0000;">"0"</span> <span style="color: #000066;">X2</span>=<span style="color: #ff0000;">"{Binding Path=X}"</span> <span style="color: #000066;">Y2</span>=<span style="color: #ff0000;">"400"</span> <span style="color: #000066;">Stroke</span>=<span style="color: #ff0000;">"Black"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
                    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Line</span> <span style="color: #000066;">Name</span>=<span style="color: #ff0000;">"Horizontal"</span> <span style="color: #000066;">X1</span>=<span style="color: #ff0000;">"0"</span> <span style="color: #000066;">Y1</span>=<span style="color: #ff0000;">"{Binding Path=Y}"</span> <span style="color: #000066;">X2</span>=<span style="color: #ff0000;">"400"</span> <span style="color: #000066;">Y2</span>=<span style="color: #ff0000;">"{Binding Path=Y}"</span> <span style="color: #000066;">Stroke</span>=<span style="color: #ff0000;">"Black"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
                <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Grid<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
            <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Grid<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
&nbsp;
            <span style="color: #808080; font-style: italic;">&lt;!-- a location 'legend' --&gt;</span>
            <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Border</span> <span style="color: #000066;">Canvas.ZIndex</span>=<span style="color: #ff0000;">"2"</span> <span style="color: #000066;">Name</span>=<span style="color: #ff0000;">"LocationIndicator"</span> <span style="color: #000066;">Visibility</span>=<span style="color: #ff0000;">"Collapsed"</span> <span style="color: #000066;">Style</span>=<span style="color: #ff0000;">"{StaticResource LocationLegendStyle}"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
                <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;StackPanel</span> <span style="color: #000066;">Orientation</span>=<span style="color: #ff0000;">"Horizontal"</span> <span style="color: #000066;">Margin</span>=<span style="color: #ff0000;">"5"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
                    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;TextBlock</span> <span style="color: #000066;">Text</span>=<span style="color: #ff0000;">"Location: "</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
                    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;TextBlock</span> <span style="color: #000066;">Text</span>=<span style="color: #ff0000;">"{Binding Path=Key,</span>
<span style="color: #009900;">                                Converter={StaticResource FormattingConverter}, ConverterParameter=hh:mm:ss}"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
                    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;TextBlock</span> <span style="color: #000066;">Text</span>=<span style="color: #ff0000;">", "</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
                    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;TextBlock</span> <span style="color: #000066;">Text</span>=<span style="color: #ff0000;">"{Binding Path=Value,</span>
<span style="color: #009900;">                                Converter={StaticResource FormattingConverter}, ConverterParameter=0.00}"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
                <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/StackPanel<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
            <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Border<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
&nbsp;
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/chartingprimitives:EdgePanel<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Grid<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/ControlTemplate<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre></td></tr></table></div><p>One more subtle point, the event handlers for MouseMove, MouseLeave etc.. when associated with a Grid only work if the background is not null, hence the need for a transparent background. I have no idea why, believe me … it just works!</p><p>One final important change is the method used to translate points from screen coordinates into a position within the chart coordinate system. Previously I used a method called <code>GetPlotAreaCoordinateValueRange</code> on the ‘hidden <code>IRangeAxis</code> interface. This has now been renamed to <code>GetValueAtPosition</code> and returns and takes a <code>UnitValue</code> type as its input (presumably for API consistency with the pie charts). Here is the code:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #008080; font-style: italic;">/// &lt;summary&gt;</span>
<span style="color: #008080; font-style: italic;">/// Transforms the supplied position on the plot area grid into a point within</span>
<span style="color: #008080; font-style: italic;">/// the plot area coordinate system</span>
<span style="color: #008080; font-style: italic;">/// &lt;/summary&gt;</span>
<span style="color: #0600FF; font-weight: bold;">private</span> KeyValuePair<span style="color: #008000;">&lt;</span>DateTime, <span style="color: #6666cc; font-weight: bold;">double</span><span style="color: #008000;">&gt;</span> GetPlotAreaCoordinates<span style="color: #008000;">(</span>Point position<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
    IComparable yAxisHit <span style="color: #008000;">=</span> <span style="color: #008000;">(</span><span style="color: #008000;">(</span>IRangeAxis<span style="color: #008000;">)</span>YAxis<span style="color: #008000;">)</span><span style="color: #008000;">.</span><span style="color: #0000FF;">GetValueAtPosition</span><span style="color: #008000;">(</span>
        <span style="color: #008000;">new</span> UnitValue<span style="color: #008000;">(</span>PlotArea<span style="color: #008000;">.</span><span style="color: #0000FF;">ActualHeight</span> <span style="color: #008000;">-</span> position<span style="color: #008000;">.</span><span style="color: #0000FF;">Y</span>, Unit<span style="color: #008000;">.</span><span style="color: #0000FF;">Pixels</span><span style="color: #008000;">)</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
    IComparable xAxisHit <span style="color: #008000;">=</span> <span style="color: #008000;">(</span><span style="color: #008000;">(</span>IRangeAxis<span style="color: #008000;">)</span>XAxis<span style="color: #008000;">)</span><span style="color: #008000;">.</span><span style="color: #0000FF;">GetValueAtPosition</span><span style="color: #008000;">(</span>
        <span style="color: #008000;">new</span> UnitValue<span style="color: #008000;">(</span>position<span style="color: #008000;">.</span><span style="color: #0000FF;">X</span>, Unit<span style="color: #008000;">.</span><span style="color: #0000FF;">Pixels</span><span style="color: #008000;">)</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
    <span style="color: #0600FF; font-weight: bold;">return</span> <span style="color: #008000;">new</span> KeyValuePair<span style="color: #008000;">&lt;</span>DateTime, <span style="color: #6666cc; font-weight: bold;">double</span><span style="color: #008000;">&gt;</span><span style="color: #008000;">(</span><span style="color: #008000;">(</span>DateTime<span style="color: #008000;">)</span>xAxisHit, <span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">double</span><span style="color: #008000;">)</span>yAxisHit<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>With these changes in place, our crosshair is fully functional once more:</p><div id="slPluginHost"> <object id="SilverlightPlugin" width="400" height="300" data="data:application/x-silverlight," type="application/x-silverlight-2"><param name="source" value="http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2009/03/sllinechartcrosshair.xap" /><a href="http://go.microsoft.com/fwlink/?LinkID=124807" style="text-decoration: none;"> <img src="http://go.microsoft.com/fwlink/?LinkId=108181" alt="Get Microsoft Silverlight" style="border-style: none;" /></a></object></div><p>… until the next release of the toolkit <img src="http://www.scottlogic.co.uk/blog/colin/wp-includes/images/smilies/icon_wink.gif" alt=";-)" class="wp-smiley" /> </p><p>You can download the project sourcecode: <a href="{{ site.url }}/blog/colin/wp-content/uploads/2009/03/sllinechartcrosshairupdated.zip">sllinechartcrosshairupdated.zip</a>.</p><p>Regards, Colin E.</p></div>