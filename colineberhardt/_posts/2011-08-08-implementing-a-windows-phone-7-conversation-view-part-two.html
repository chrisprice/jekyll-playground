---
author: Colin Eberhardt
tags: codeproject, Windows Phone 7
permalink: /blog/colin/2011/08/implementing-a-windows-phone-7-conversation-view-part-two/index.html
layout: colineberhardt-blog
---
<div class="entry"><div class="topsy_widget_data topsy_theme_light-green" style="float: right; margin-left: 0.75em; background: url(data:,%7B%20%22url%22%3A%20%22http%253A%252F%252Fwww.scottlogic.co.uk%252Fblog%252Fcolin%252F2011%252F08%252Fimplementing-a-windows-phone-7-conversation-view-part-two%252F%22%2C%20%22style%22%3A%20%22big%22%2C%20%22title%22%3A%20%22Implementing%20a%20Windows%20Phone%207%20Conversation%20View%20Part%20Two%20%23%22%20%7D);"></div><p><em>This blog post describes how to implement a conversation / messaging style application with Windows Phone 7. It covers how to style the speech bubbles and the scrolling of the conversation list view when the phone keyboard is shown.</em></p><p>A couple of weeks ago I wrote a blog post which described the creation of a <a href="{{ site.url }}/blog/colin/2011/07/a-wp7-conversation-view/" title="Implementing a Windows Phone 7 Conversation View">Windows Phone 7 ConversationView</a>, a view which renders a list of messages so that they look like a conversation. In this blog post I am going to extend the concept further, by adding an input text field allowing you to have a conversation with ELIZA, an A.I. chatterbot. This blog post will look at some of the tricky issue regarding scrolling the list of messages so that the most recent is always visible when responding.</p><p>You can see a video of this code in action below:</p><p><iframe width="425" height="349" src="http://www.youtube.com/embed/cu2pw98tjZc" frameborder="0" allowfullscreen="allowfullscreen"></iframe></p><p>I hoped that I could find a decent C# <a href="http://en.wikipedia.org/wiki/ELIZA">ELIZA</a> (a classic chatter application that takes on the role of a therapist) implementation on the internet, however, the only one <a href="http://www.codeproject.com/KB/library/ProjectEliza.aspx">I found was rather basic</a>. If you know of any alternatives, pleas let me know!</p><p>In my previous blog post I created a <code>UserControl</code> which renders each <code>Message</code> instance, where the template used to render the message is dependant on which side of the conversation it relates to. Refer to <a href="{{ site.url }}/blog/colin/2011/07/a-wp7-conversation-view/" title="Implementing a Windows Phone 7 Conversation View">my previous blog post</a> for implementation details.</p><p><img src="http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2011/07/WP7ConversationDesignTime.png" alt="" title="WP7ConversationDesignTime" width="600" height="328" class="aligncenter size-full wp-image-1604" /></p><p>The layout for my simple chat application uses an instance of the <code>ConversationView</code> user control, with a text input located at the bottom of the screen:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="xml" style="font-family: monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Grid</span> <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"ContentPanel"</span> <span style="color: #000066;">Grid.Row</span>=<span style="color: #ff0000;">"1"</span> <span style="color: #000066;">Margin</span>=<span style="color: #ff0000;">"12,0,12,0"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Grid</span> <span style="color: #000066;">contribControls:GridUtils.RowDefinitions</span>=<span style="color: #ff0000;">",Auto"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
&nbsp;
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;ScrollViewer</span> <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"ConversationScrollViewer"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
        <span style="color: #808080; font-style: italic;">&lt;!-- conversation view --&gt;</span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;local:ConversationView</span> <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"conversationView"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/StackPanel<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/ScrollViewer<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
&nbsp;
    <span style="color: #808080; font-style: italic;">&lt;!-- the text input field --&gt;</span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Grid</span> <span style="color: #000066;">Grid.Row</span>=<span style="color: #ff0000;">"1"</span></span>
<span style="color: #009900;">          <span style="color: #000066;">contribControls:GridUtils.RowDefinitions</span>=<span style="color: #ff0000;">",,"</span></span>
<span style="color: #009900;">          <span style="color: #000066;">Margin</span>=<span style="color: #ff0000;">"0,10,0,0"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Rectangle</span> <span style="color: #000066;">Fill</span>=<span style="color: #ff0000;">"White"</span></span>
<span style="color: #009900;">                  <span style="color: #000066;">Grid.RowSpan</span>=<span style="color: #ff0000;">"2"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;txt:WatermarkedTextBox</span> <span style="color: #000066;">Watermark</span>=<span style="color: #ff0000;">"type a message"</span></span>
<span style="color: #009900;">                              <span style="color: #000066;">TextWrapping</span>=<span style="color: #ff0000;">"Wrap"</span></span>
<span style="color: #009900;">                              <span style="color: #000066;">AcceptsReturn</span>=<span style="color: #ff0000;">"True"</span></span>
<span style="color: #009900;">                              <span style="color: #000066;">Padding</span>=<span style="color: #ff0000;">"0"</span></span>
<span style="color: #009900;">                              <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"TextInput"</span></span>
<span style="color: #009900;">                              <span style="color: #000066;">GotFocus</span>=<span style="color: #ff0000;">"TextInput_GotFocus"</span></span>
<span style="color: #009900;">                              <span style="color: #000066;">LostFocus</span>=<span style="color: #ff0000;">"TextInput_LostFocus"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>            
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Path</span> <span style="color: #000066;">Data</span>=<span style="color: #ff0000;">"m 0,0 l 16,0 l 0,16 l -16,-16"</span></span>
<span style="color: #009900;">            <span style="color: #000066;">Fill</span>=<span style="color: #ff0000;">"White"</span></span>
<span style="color: #009900;">            <span style="color: #000066;">Margin</span>=<span style="color: #ff0000;">"0,0,5,0"</span></span>
<span style="color: #009900;">            <span style="color: #000066;">HorizontalAlignment</span>=<span style="color: #ff0000;">"Right"</span></span>
<span style="color: #009900;">            <span style="color: #000066;">Grid.Row</span>=<span style="color: #ff0000;">"2"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Grid<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Grid<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>      
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Grid<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre></td></tr></table></div><p>Note the simplified <code>Grid</code> markup from the <a href="http://wp7contrib.codeplex.com/">WP7Contrib codeplex project</a>, where the string <code>",Auto"</code> is used in place of the more verbose <code>RowDefinition</code> XAML elements.</p><p><img src="http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2011/08/ConversationViewLayout.png" alt="" title="ConversationViewLayout" width="190" height="350" class="aligncenter size-full wp-image-1622" /></p><p>The <code>WatermarkedTextBox</code> is <a href="http://www.windowsphonegeek.com/articles/WP7-WatermarkedTextBox-custom-control">from an article by WindowsPhoneGeek</a> (and it works like a charm – thanks!). A simple <code>Path</code> and <code>Rectangle</code> are added to the layout so that the input field looks like a speech bubble.</p><p>When the user clicks on the input TextBlock the phone keyboard will be revealed, allowing them to enter their message. This is where we stumble upon our first major problem!</p><p>When the phone keyboard is displayed, your application content is ‘pushed’ upwards to make space for the keyboard. Unfortunately, this results in the message which the user is replying to being pushed off the top of the screen …</p><p><img src="http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2011/08/KeyboardIssue.png" alt="" title="KeyboardIssue" width="450" height="386" class="aligncenter size-full wp-image-1620" /></p><p>Because our <code>ConversationView</code> sits within a <code>ScrollViewer</code> we can scroll to push the message further down the screen, however, this would require a negative scroll offset, which isn’t possible! </p><p>To circumnavigate this issue, we can add an element which is used to ‘push’ the top message downwards so that it is located at the bottom of the <code>ScrollViewer</code>. The following markup adds a <code>Rectangle</code> which sits above the <code>ConversationView</code>, with two Storyboards that expand / collapse the <code>Rectangle</code> allowing us to push the messages down when we need them:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="xml" style="font-family: monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;ScrollViewer</span> <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"ConversationScrollViewer"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;StackPanel</span> <span style="color: #000066;">Orientation</span>=<span style="color: #ff0000;">"Vertical"</span></span>
<span style="color: #009900;">              <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"ConversationContentContainer"</span></span>
<span style="color: #009900;">              <span style="color: #000066;">VerticalAlignment</span>=<span style="color: #ff0000;">"Top"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
    <span style="color: #808080; font-style: italic;">&lt;!-- padding element --&gt;</span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Rectangle</span> <span style="color: #000066;">Width</span>=<span style="color: #ff0000;">"100"</span></span>
<span style="color: #009900;">                <span style="color: #000066;">Height</span>=<span style="color: #ff0000;">"0"</span></span>
<span style="color: #009900;">                <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"PaddingRectangle"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Rectangle.Resources<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Storyboard</span> <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"PaddingRectangleShowAnim"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
          <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;DoubleAnimation</span> <span style="color: #000066;">Storyboard.TargetName</span>=<span style="color: #ff0000;">"PaddingRectangle"</span> </span>
<span style="color: #009900;">                <span style="color: #000066;">Storyboard.TargetProperty</span>=<span style="color: #ff0000;">"(Height)"</span></span>
<span style="color: #009900;">                <span style="color: #000066;">To</span>=<span style="color: #ff0000;">"400"</span>  <span style="color: #000066;">Duration</span>=<span style="color: #ff0000;">"00:00:00.3"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Storyboard<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;Storyboard</span> <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"PaddingRectangleHideAnim"</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
          <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;DoubleAnimation</span> <span style="color: #000066;">Storyboard.TargetName</span>=<span style="color: #ff0000;">"PaddingRectangle"</span> </span>
<span style="color: #009900;">                <span style="color: #000066;">Storyboard.TargetProperty</span>=<span style="color: #ff0000;">"(Height)"</span></span>
<span style="color: #009900;">                <span style="color: #000066;">To</span>=<span style="color: #ff0000;">"0"</span>  <span style="color: #000066;">Duration</span>=<span style="color: #ff0000;">"00:00:00.3"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Storyboard<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Rectangle.Resources<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/Rectangle<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
&nbsp;
    <span style="color: #808080; font-style: italic;">&lt;!-- conversation view --&gt;</span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;local:ConversationView</span> <span style="color: #000066;">x:Name</span>=<span style="color: #ff0000;">"conversationView"</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/StackPanel<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/ScrollViewer<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre></td></tr></table></div><p>We can detect when the input <code>TextBlock</code> receives focus to determine when the keyboard will be revealed. Using the <a href="{{ site.url }}/blog/colin/2009/09/helpful-extension-methods-for-show-hide-animations-in-silverlight/" title="Helpful extension methods for Show / Hide animations in Silverlight">Show / Hide extension methods I blogged about a while back</a>, we can fire the animations which make this padding rectangle grow or shrink when the keyboard is shown or hidden:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">void</span> TextInput_GotFocus<span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">object</span> sender, RoutedEventArgs e<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
  PaddingRectangle<span style="color: #008000;">.</span><span style="color: #0000FF;">Show</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
  ApplicationBar<span style="color: #008000;">.</span><span style="color: #0000FF;">IsVisible</span> <span style="color: #008000;">=</span> <span style="color: #0600FF; font-weight: bold;">true</span><span style="color: #008000;">;</span>
<span style="color: #008000;">}</span>
&nbsp;
<span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">void</span> TextInput_LostFocus<span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">object</span> sender, RoutedEventArgs e<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
  PaddingRectangle<span style="color: #008000;">.</span><span style="color: #0000FF;">Hide</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
  ApplicationBar<span style="color: #008000;">.</span><span style="color: #0000FF;">IsVisible</span> <span style="color: #008000;">=</span> <span style="color: #0600FF; font-weight: bold;">false</span><span style="color: #008000;">;</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>If we fill the rectangle so that it is visible, you can see how it pushes down the content as shown below:</p><p><img src="http://www.scottlogic.co.uk/blog/colin/wp-content/uploads/2011/08/KeyboardIssueFix.png" alt="" title="KeyboardIssueFix" width="450" height="388" class="aligncenter size-full wp-image-1623" /></p><p>The next step is to ensure that the <code>ConversationView</code> is always scrolled so that the most recent message is visible. The <code>ScrollViewer</code> has a <code>ScrollToVerticalOffset</code> method which can be used to programmatically scroll the content, however, because this is not a dependency property it cannot be animated via  <code>Storyboard</code>.</p><p>Here I am using the same trick I employed for the Windows Phone 7 Jump List control, where a private dependency property that sets the scroll offset value in its change handler is used as a target for the scrolling Storyboard:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #008080; font-style: italic;">/// &lt;summary&gt;</span>
<span style="color: #008080; font-style: italic;">/// VerticalOffset, a private DP used to animate the scrollviewer</span>
<span style="color: #008080; font-style: italic;">/// &lt;/summary&gt;</span>
<span style="color: #0600FF; font-weight: bold;">private</span> DependencyProperty VerticalOffsetProperty <span style="color: #008000;">=</span> DependencyProperty<span style="color: #008000;">.</span><span style="color: #0000FF;">Register</span><span style="color: #008000;">(</span><span style="color: #666666;">"VerticalOffset"</span>,
  <span style="color: #008000;">typeof</span><span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">double</span><span style="color: #008000;">)</span>, <span style="color: #008000;">typeof</span><span style="color: #008000;">(</span>MainPage<span style="color: #008000;">)</span>, <span style="color: #008000;">new</span> PropertyMetadata<span style="color: #008000;">(</span><span style="color: #FF0000;">0.0</span>, OnVerticalOffsetChanged<span style="color: #008000;">)</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
&nbsp;
<span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #0600FF; font-weight: bold;">static</span> <span style="color: #6666cc; font-weight: bold;">void</span> OnVerticalOffsetChanged<span style="color: #008000;">(</span>DependencyObject d, DependencyPropertyChangedEventArgs e<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
  MainPage app <span style="color: #008000;">=</span> d <span style="color: #0600FF; font-weight: bold;">as</span> MainPage<span style="color: #008000;">;</span>
  app<span style="color: #008000;">.</span><span style="color: #0000FF;">OnVerticalOffsetChanged</span><span style="color: #008000;">(</span>e<span style="color: #008000;">)</span><span style="color: #008000;">;</span>
<span style="color: #008000;">}</span>
&nbsp;
<span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">void</span> OnVerticalOffsetChanged<span style="color: #008000;">(</span>DependencyPropertyChangedEventArgs e<span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
  ConversationScrollViewer<span style="color: #008000;">.</span><span style="color: #0000FF;">ScrollToVerticalOffset</span><span style="color: #008000;">(</span><span style="color: #008000;">(</span><span style="color: #6666cc; font-weight: bold;">double</span><span style="color: #008000;">)</span>e<span style="color: #008000;">.</span><span style="color: #0000FF;">NewValue</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>Using this dependency property we can create a simple <code>Storyboard</code> and <code>DoubleAnimation</code> that scrolls to reveal the latest message:</p><div class="wp_syntax"><table><tr><td class="code"><pre class="csharp" style="font-family: monospace;"><span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">void</span> ScrollConvesationToEnd<span style="color: #008000;">(</span><span style="color: #008000;">)</span>
<span style="color: #008000;">{</span>
  <span style="color: #008080; font-style: italic;">// start from the current position</span>
  scrollViewerScrollToEndAnim<span style="color: #008000;">.</span><span style="color: #0600FF; font-weight: bold;">From</span> <span style="color: #008000;">=</span> ConversationScrollViewer<span style="color: #008000;">.</span><span style="color: #0000FF;">VerticalOffset</span><span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #008080; font-style: italic;">// set the scroll position to the the height of the contained content</span>
  scrollViewerScrollToEndAnim<span style="color: #008000;">.</span><span style="color: #0000FF;">To</span> <span style="color: #008000;">=</span> ConversationContentContainer<span style="color: #008000;">.</span><span style="color: #0000FF;">ActualHeight</span><span style="color: #008000;">;</span>
&nbsp;
  <span style="color: #008080; font-style: italic;">// go!</span>
  scrollViewerStoryboard<span style="color: #008000;">.</span><span style="color: #0000FF;">Begin</span><span style="color: #008000;">(</span><span style="color: #008000;">)</span><span style="color: #008000;">;</span>
<span style="color: #008000;">}</span></pre></td></tr></table></div><p>And there you have it, a fully functional conversation application. Enjoy!</p><p>You can download the complete sourcecode: <a href="{{ site.url }}/blog/colin/wp-content/uploads/2011/08/WP7ConversationView.zip">WP7ConversationView.zip</a> </p><p>Regards, Colin E.</p></div>